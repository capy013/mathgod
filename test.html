<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MathGodâš¡ å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹</title>
  <meta name="description" content="MathGodâš¡ å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹ - å°ˆç‚ºæœ‹å‹èšæœƒã€æ—…è¡Œè¨­è¨ˆçš„åŒæ­¥åˆ†å¸³å·¥å…·ã€‚æ”¯æ´å¤šåœ‹åŒ¯ç‡è½‰æ›ï¼Œä¸€éµç”Ÿæˆçµç®—å–®ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://capy013.github.io/mathgod/">
  <meta property="og:title" content="MathGodâš¡ å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta property="og:description" content="æ—…è¡Œã€é£Ÿé£¯ã€å¤¾éŒ¢å””ä½¿ç…©ï¼æ”¯æ´å³æ™‚åŒæ­¥åŠŸèƒ½ï¼Œè‡ªå‹•æ›ç®—åŒ¯ç‡ï¼ŒMathGod å¹«ä½ è¨ˆåˆ°ç›¡ã€‚">
  <meta property="og:image" content="favicon.svg">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MathGodâš¡ å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta name="twitter:description" content="æœ‹å‹èšæœƒåˆ†å¸³ç¥å™¨ï¼šæ”¯æ´å¤šå¹£ç¨®ã€é›²ç«¯åŒæ­¥ã€‚">
  <meta name="twitter:image" content="favicon.svg">
  <meta name="theme-color" content="#0a2f23">
  <link rel="icon" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">
  <link rel="manifest" href="./manifest.webmanifest">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #10b981; --bg: #050505; --card-bg: rgba(30, 30, 30, 0.65); --border: rgba(255, 255, 255, 0.1); }
    [v-cloak] { display: none !important; }
    body { background-color: var(--bg); color: #fff; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .glass { background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
    .glass-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
    .glass-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); background: rgba(0,0,0,0.5); }
    .input-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .font-num { font-family: 'JetBrains Mono', monospace; }
    .btn-press { transition: transform 0.1s; }
    .btn-press:active { transform: scale(0.96); }
    .footer-gradient { background: linear-gradient(to top, rgba(5,5,5,0.95) 10%, rgba(5,5,5,0.6) 40%, rgba(5,5,5,0) 100%); pointer-events: none; height: 120px; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-30px) scale(0.9); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    .math-check { appearance: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; position: relative; transition: all 0.2s; }
    .math-check:checked { background: var(--primary); border-color: var(--primary); }
    .math-check:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; font-size: 10px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    .app-logo { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3)); }
    @keyframes lightningBar {
      0%   { transform: translateX(-120%); }
      100% { transform: translateX(420%); }
    }
    .animate-lightning-bar { animation: lightningBar 1s infinite linear; }
    .capture-mode .truncate { overflow: visible !important; text-overflow: clip !important; }
    .capture-mode .capture-row, .capture-mode .capture-row span { line-height: 1.6 !important; padding-bottom: 2px !important; }
    .calc-enter-active, .calc-leave-active { transition: opacity 0.25s ease, transform 0.25s ease; }
    .calc-enter-from, .calc-leave-to { opacity: 0; transform: scale(0.92) translateY(12px); }
    @keyframes addedGlow {
      0%   { transform: scale(0.995); box-shadow: 0 0 0 rgba(16,185,129,0); }
      40%  { transform: scale(1.01);  box-shadow: 0 0 24px rgba(16,185,129,0.22); }
      100% { transform: scale(1);     box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    .just-added { animation: addedGlow 0.9s ease; }
    .clear-btn {
      width: 26px; height: 26px; border-radius: 9999px; display: flex; align-items: center; justify-content: center;
      background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.55); transition: all .15s ease;
    }
    .clear-btn:hover { background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.90); }
    .clear-btn i { font-size: 11px; line-height: 1; }
    .amount-fit { font-variant-numeric: tabular-nums; letter-spacing: 0.02em; line-height: 1; }
    
    /* å¤šå¤©æ¨¡å¼æ¨£å¼ */
    .day-tabs-container {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 8px 0;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .day-tabs-container::-webkit-scrollbar { display: none; }
    .tab-item {
      flex-shrink: 0;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      min-width: 80px;
    }
    .tab-item.active {
      background: rgba(16, 185, 129, 0.2);
      border-color: rgba(16, 185, 129, 0.5);
    }
    .tab-item.deleting {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.5);
      animation: pulse 0.5s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    .sortable-ghost {
      opacity: 0.4;
      background: rgba(16, 185, 129, 0.3);
    }
    .day-tab-input {
      background: transparent;
      border: none;
      outline: none;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 100%;
      text-align: center;
    }
  </style>
</head>
<body>
<div id="app" v-cloak class="min-h-screen flex flex-col max-w-[500px] mx-auto relative pb-32">

      <!-- Loading -->
  <transition name="fade">
    <div v-if="isLoading" class="fixed inset-0 z-[200] bg-black flex items-center justify-center">
      <div class="flex flex-col items-center">
        <img src="favicon.svg" class="w-16 h-16 rounded-2xl mb-4 animate-pulse shadow-2xl">
        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">âš¡  Loading...</p>
      </div>
    </div>
  </transition>

  <!-- Toasts -->
  <div class="fixed top-8 left-0 right-0 z-[999] flex flex-col items-center pointer-events-none px-4">
    <transition-group name="toast">
      <div v-for="t in toasts" :key="t.id" class="glass px-6 py-3 rounded-full flex items-center gap-3 mb-2 shadow-2xl pointer-events-auto border-l-4"
           :class="t.type === 'error' ? 'border-red-500' : 'border-emerald-500'">
        <i :class="['fas', t.type === 'error' ? 'fa-times-circle text-red-400' : 'fa-check-circle text-emerald-400']"></i>
        <span class="text-xs font-bold">{{ t.msg }}</span>
      </div>
    </transition-group>
  </div>

  <!-- Header -->
  <header class="p-6 pb-8 rounded-b-[2.5rem] sticky top-0 z-40 transition-all duration-500 shadow-2xl backdrop-blur-xl border-b border-white/5"
          :class="isEditing ? 'bg-amber-950/80' : 'bg-[#0a2f23]/80'">
    <div class="flex justify-between items-start mb-6">
      <div class="flex items-center gap-3">
        <img src="favicon.svg" class="h-10 w-10 rounded-xl object-contain shadow-lg border border-white/10 app-logo">
        <div>
          <h1 class="text-xl font-black italic tracking-tighter text-white leading-none">MathGod</h1>
          <p class="text-[9px] font-bold text-emerald-400/80 tracking-[0.1em] uppercase">
            {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹æ¨¡å¼' : 'æœ‹å‹å¤¾éŒ¢è¨ˆç®—å™¨' }}
          </p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button @click="showTutorial = true" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs hover:bg-white/20 transition-all">
          <i class="fas fa-question text-white/70"></i>
        </button>
        <div v-if="roomId" class="glass px-3 py-1.5 rounded-full flex items-center gap-3 border-emerald-500/30 bg-emerald-900/20">
          <div class="text-right">
            <p class="text-[8px] font-bold uppercase" :class="isOnline ? 'text-emerald-400' : 'text-gray-400'">
              {{ isOnline ? 'ONLINE' : 'OFFLINE' }}
            </p>
            <p class="text-xs font-num font-bold text-emerald-400 leading-none">#{{ roomId }}</p>
          </div>
          <button @click="copyRoomLink" class="w-6 h-6 rounded-full bg-white/10 text-white/70 flex items-center justify-center hover:bg-white/20 transition-all">
            <i class="fas fa-link text-[10px]"></i>
          </button>
          <button @click="logoutRoom" class="w-6 h-6 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
            <i class="fas fa-power-off text-[10px]"></i>
          </button>
        </div>
        <button
          v-else
          @click="isOnline ? (showSyncModal = true) : toast('ç›®å‰é›¢ç·šï¼Œæœªèƒ½åŒæ­¥', 'error')"
          class="glass px-4 py-2 rounded-full text-[10px] font-bold border-white/10 transition-all flex items-center gap-2 btn-press"
          :class="isOnline ? 'hover:border-emerald-500/50' : 'opacity-40 grayscale'">
          <i :class="['fas', isOnline ? 'fa-cloud' : 'fa-wifi', isOnline ? 'text-emerald-400' : 'text-gray-500']"></i>
          <span>{{ isOnline ? 'åŒæ­¥MODE' : 'é›¢ç·šä¸­' }}</span>
        </button>
      </div>
    </div>

    <div class="flex gap-3 mb-4">
      <div class="flex-1 glass-input rounded-2xl flex items-center px-4 relative">
        <i class="fas fa-pen text-[10px] text-gray-500 mr-3"></i>
        <input v-model="eventName" @input="saveData" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/20" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: æ—¥æœ¬ Day1)">
      </div>
      <button @click="openDatePicker" class="w-12 glass-input rounded-2xl flex items-center justify-center hover:border-emerald-500/50 btn-press">
        <i class="fas fa-calendar-day text-emerald-400 pointer-events-none"></i>
      </button>
      <input type="date" id="dateInput" class="absolute -left-[9999px] opacity-0" @change="appendDate"/>
    </div>

    <!-- å¤šå¤©æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
    <div class="mb-3">
      <button @click="toggleMultiDay" class="w-full glass-input rounded-xl py-3 px-4 flex items-center justify-between hover:border-emerald-500/50 transition-all btn-press">
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar-week text-emerald-400"></i>
          <span class="text-xs font-bold">å¤šå¤©æ¨¡å¼</span>
        </div>
        <div class="relative inline-flex items-center cursor-pointer">
          <div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all"
               :class="multiDayMode ? 'peer-checked:bg-emerald-600' : ''"></div>
        </div>
      </button>
    </div>

    <!-- å¤šå¤©æ¨¡å¼ Tabs -->
    <div v-if="multiDayMode" class="space-y-3">
      <div class="day-tabs-container" ref="tabsContainer" id="sortable-tabs">
        <div v-for="day in days" :key="day.id"
             class="tab-item"
             :class="{ 
               'active': currentDayId === day.id,
               'deleting': deletingDayId === day.id
             }"
             @click="selectDay(day.id)">
          <div v-if="editingDayId === day.id" @click.stop>
            <input 
              v-model="editingName"
              @keyup.enter="finishEditingName"
              @keyup.esc="cancelEditingName"
              @blur="finishEditingName"
              class="day-tab-input"
              maxlength="20"
            />
          </div>
          <div v-else class="flex items-center justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="text-xs font-bold truncate">{{ day.name }}</div>
              <div class="text-[9px] text-gray-400 font-num">
                ${{ getDayTotal(day.id).toFixed(1) }}
              </div>
            </div>
            <div class="flex items-center gap-1">
              <button @click.stop="startEditingName(day.id)" class="w-6 h-6 rounded-full hover:bg-white/10 flex items-center justify-center">
                <i class="fas fa-pen text-[9px] text-gray-400"></i>
              </button>
              <button @click.stop="handleDeleteDay(day.id)" class="w-6 h-6 rounded-full hover:bg-red-500/20 flex items-center justify-center">
                <i class="fas fa-trash text-[9px]" :class="deletingDayId === day.id ? 'text-red-400' : 'text-gray-400'"></i>
              </button>
            </div>
          </div>
        </div>
        <button @click="addNewDay" class="tab-item flex items-center justify-center hover:bg-emerald-500/20">
          <i class="fas fa-plus text-emerald-400"></i>
        </button>
      </div>
      
      <!-- ç•¶å‰å¤©æ•¸ç¸½è¨ˆ -->
      <div class="glass-input rounded-xl px-4 py-2 flex items-center justify-between">
        <span class="text-xs font-bold text-gray-400">{{ currentDayName }} ç¸½è¨ˆ</span>
        <span class="text-sm font-black font-num text-emerald-400">HKD ${{ currentDayTotal.toFixed(1) }}</span>
      </div>
    </div>

    <div v-if="isSyncing" class="mt-3">
      <div class="h-1 w-full overflow-hidden rounded-full bg-white/10">
        <div class="h-full w-1/3 bg-emerald-400 animate-lightning-bar"></div>
      </div>
      <div class="mt-1 text-[9px] font-bold text-gray-400 tracking-widest uppercase">âš¡  Loading...</div>
    </div>
  </header>
  <!-- Main -->
  <main class="p-5 space-y-6 flex-1">
    <!-- STEP 1 -->
    <section class="glass p-5 rounded-[2rem]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">STEP 1: æœ‹å‹</h3>
        <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full text-gray-400 font-num">{{ users.length }} äºº</span>
      </div>
      <div class="flex gap-2 mb-4">
        <div class="flex-1 glass-input rounded-xl flex items-center px-4 transition-all"
             :class="{'border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]': users.length === 0}">
          <i class="fas fa-user-plus text-xs text-gray-500 mr-2"></i>
          <input v-model="newUser" @keyup.enter="addUser" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="è¼¸å…¥åå­—...">
        </div>
        <button @click="addUser" class="bg-emerald-600 px-5 rounded-xl font-black text-xs btn-press shadow-lg shadow-emerald-900/50">åŠ å…¥</button>
      </div>
      <div class="flex flex-wrap gap-2">
        <transition-group name="toast">
          <div v-for="(u, i) in users" :key="u" class="bg-white/5 border border-white/10 px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 group">
            {{ u }}
            <button @click="removeUser(i)" class="text-gray-600 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
          </div>
        </transition-group>
        <div v-if="users.length === 0" class="w-full text-center py-2 text-[10px] text-emerald-400/70 animate-pulse">
          <i class="fas fa-arrow-up mr-1"></i> è«‹å…ˆåŠ å…¥åƒèˆ‡æ´»å‹•çš„æœ‹å‹
        </div>
      </div>
    </section>

    <!-- STEP 2 -->
    <section class="glass p-6 rounded-[2rem] transition-all duration-300 relative overflow-visible"
             :class="{'opacity-50 pointer-events-none grayscale': users.length === 0, 'border-amber-500/50': isEditing}">
      <div v-if="users.length === 0" class="absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
        <div class="bg-black/80 px-4 py-2 rounded-full text-xs font-bold text-white"><i class="fas fa-lock mr-2"></i>åŠ å…¥æœ‹å‹å¾Œè§£é–</div>
      </div>
      <div class="flex justify-between items-center mb-5">
        <h3 class="text-[10px] font-bold uppercase tracking-widest flex items-center gap-2" :class="isEditing ? 'text-amber-500' : 'text-emerald-500'">
          {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹' : 'STEP 2: æ–°å¢æ¶ˆè²»' }}
        </h3>
        <button v-if="isEditing" @click="cancelEdit" class="text-[10px] text-gray-400 underline hover:text-white">å–æ¶ˆä¿®æ”¹</button>
      </div>
      <div class="space-y-4">
        <div class="glass-input rounded-2xl flex items-center px-4 relative" :class="{'input-error': errors.item}">
          <input v-model="form.item" @input="errors.item = false" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤)">
          <button
            v-if="form.item"
            type="button"
            @click.stop.prevent="form.item=''"
            class="absolute right-3 top-1/2 -translate-y-1/2 clear-btn"
            aria-label="æ¸…é™¤æ¶ˆè²»é …ç›®"
            title="æ¸…é™¤">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- currency + amount + calc icon -->
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-3 sm:col-span-4 glass-input rounded-2xl relative">
            <select v-model="form.currency" @change="handleCurrencyChange" class="w-full h-full bg-transparent px-2 text-[11px] font-black outline-none appearance-none text-center z-10 relative">
              <option value="HKD">HKD ğŸ‡­ğŸ‡° </option>
              <option value="CNY">CNY ğŸ‡¨ğŸ‡³ </option>
              <option value="JPY">JPY ğŸ‡¯ğŸ‡µ </option>
              <option value="TWD">TWD ğŸ‡¹ğŸ‡¼ </option>
              <option value="THB">THB ğŸ‡¹ğŸ‡­ </option>
              <option value="KRW">KRW ğŸ‡°ğŸ‡· </option>
              <option value="USD">USD ğŸ‡ºğŸ‡¸ </option>
              <option value="EUR">EUR ğŸ‡ªğŸ‡º </option>
              <option value="GBP">GBP ğŸ‡¬ğŸ‡§ </option>
            </select>
            <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[8px] text-gray-500"></i>
          </div>
          <div class="col-span-9 sm:col-span-8 glass-input rounded-2xl flex flex-col justify-center pl-4 pr-1 py-2" :class="{'input-error': errors.amount}">
            <div class="relative flex items-center w-full">
              <span class="text-xs font-black text-gray-500 w-5 shrink-0 text-center">$</span>
              <div class="flex-1 min-w-0">
                <input
                  v-model="form.amount"
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9.]*"
                  @input="sanitizeAmount(); errors.amount = false"
                  :class="[
                    'w-full bg-transparent text-center font-num font-black outline-none placeholder-white/10 amount-fit',
                    amountFontClass
                  ]"
                  placeholder="0.0"
                />
              </div>
              <div class="flex items-center justify-end gap-2 w-[80px] shrink-0 pl-2">
                <button
                  v-if="form.amount"
                  type="button"
                  class="clear-btn"
                  @click.stop.prevent="form.amount=''"
                  aria-label="æ¸…é™¤é‡‘é¡"
                  title="æ¸…é™¤">
                  <i class="fas fa-times"></i>
                </button>
                <span class="h-6 w-px bg-white/10"></span>
                <button
                  type="button"
                  @click.stop.prevent="openKeypad()"
                  class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-emerald-500/10 active:bg-emerald-500/20"
                  title="é–‹å•Ÿè¨ˆæ•¸æ©Ÿ"
                  aria-label="é–‹å•Ÿè¨ˆæ•¸æ©Ÿ">
                  <i class="fas fa-calculator text-[13px] text-emerald-400"></i>
                </button>
              </div>
            </div>
            <div v-if="form.currency !== 'HKD'" class="text-right border-t border-white/5 mt-1 pt-1 space-y-1">
              <div>
                <span class="text-[9px] font-bold text-emerald-400 font-num">
                  Rate: {{ currentRate.toFixed(3) }} â‰ˆ HKD ${{ ((Number(form.amount || 0)) * currentRate).toFixed(1) }}
                </span>
              </div>
              <div v-if="rateUpdatedAt" class="text-[9px] font-bold text-gray-500 font-num">
                æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ formatTs(rateUpdatedAt) }}
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-[9px] font-bold text-gray-500 ml-1">èª°ä»˜éŒ¢</p>
            <div class="glass-input rounded-xl relative" :class="{'input-error': errors.payer}">
              <select v-model="form.payer" @change="errors.payer = false" class="w-full bg-transparent p-3 text-xs font-bold outline-none appearance-none">
                <option value="" disabled>è«‹é¸æ“‡...</option>
                <option v-for="u in users" :value="u">{{ u }}</option>
              </select>
              <i class="fas fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            </div>
          </div>
          <div class="space-y-1">
            <div class="flex justify-between px-1">
              <p class="text-[9px] font-bold text-gray-500" :class="{'text-red-400': errors.involved}">èª°æœ‰ä»½ ({{ form.involved.length }})</p>
              <button @click="toggleSelectAll" class="text-[9px] text-emerald-500 font-bold hover:text-white transition-colors">å…¨é¸/å–æ¶ˆ</button>
            </div>
            <div class="glass-input rounded-xl p-2 max-h-28 overflow-y-auto custom-scroll space-y-1" :class="{'input-error': errors.involved}">
              <div v-for="u in users" :key="u" @click="toggleInvolved(u)" class="flex items-center gap-2 p-1.5 rounded-lg cursor-pointer hover:bg-white/5">
                <input type="checkbox" :checked="form.involved.includes(u)" class="math-check pointer-events-none">
                <span class="text-[10px] font-bold" :class="form.involved.includes(u) ? 'text-white' : 'text-gray-500'">{{ u }}</span>
              </div>
            </div>
          </div>
        </div>

        <button @click="addExpense" class="w-full py-4 rounded-2xl font-black text-sm shadow-xl btn-press flex items-center justify-center gap-2 transition-all"
                :class="isEditing ? 'bg-amber-600 shadow-amber-900/40' : 'bg-emerald-600 shadow-emerald-900/40'">
          <i :class="['fas', isEditing ? 'fa-save' : 'fa-plus']"></i>
          <span>{{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªå…¥æ•¸' }}</span>
          <span v-if="form.amount" class="font-num bg-black/20 px-2 rounded ml-1 text-xs">
            HKD ${{ ((Number(form.amount || 0) * currentRate) || 0).toFixed(1) }}
          </span>
        </button>
      </div>
    </section>

    <!-- Recent -->
    <section class="pb-10">
      <h3 class="text-[10px] font-bold text-gray-500 ml-2 mb-3 uppercase tracking-widest">
        {{ multiDayMode ? currentDayName + ' ç´€éŒ„' : 'æœ€è¿‘ç´€éŒ„' }}
      </h3>
      <div v-if="currentExpenses.length === 0" class="text-center py-6 opacity-30">
        <i class="fas fa-clipboard-list text-3xl mb-2"></i>
        <p class="text-xs">æš«ç„¡æ¶ˆè²»</p>
      </div>
      <div class="space-y-3">
        <div v-for="(exp, idx) in currentExpenses" :key="exp.id" @click="editExpense(idx)"
             class="glass p-4 rounded-2xl flex justify-between items-center border-l-[3px] transition-all active:scale-[0.99]"
             :class="exp.id === lastAddedId ? 'just-added' : ''"
             :style="{ borderColor: isEditing && editingId === exp.id ? '#f59e0b' : '#10b981' }">
          <div class="flex-1 overflow-hidden pr-3">
            <div class="flex items-center gap-2 mb-1">
              <p class="font-bold text-sm truncate text-gray-100">{{ exp.item }}</p>
              <span v-if="exp.origCurrency !== 'HKD'" class="text-[8px] bg-white/10 px-1.5 rounded text-gray-400 font-num">{{ exp.origCurrency }}</span>
            </div>
            <p class="text-[10px] text-gray-400 font-bold flex items-center gap-1">
              <span class="text-emerald-400 font-num">HKD ${{ (exp.hkd || 0).toFixed(1) }}</span>
              <span class="text-gray-600">|</span>
              <span>{{ exp.payer }} ä»˜</span>
            </p>
          </div>
          <button @click.stop="removeExpense(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-600 hover:bg-red-500/20 hover:text-red-400 transition-colors">
            <i class="fas fa-trash-alt text-xs"></i>
          </button>
        </div>
      </div>
    </section>
  </main>
  <!-- ===== Floating Draggable Calculator (Top Layer) ===== -->
  <transition name="calc">
    <div v-if="showKeypad" class="fixed inset-0 z-[999]">
      <!-- click-away overlay -->
      <div
        class="absolute inset-0 bg-black/40"
        @pointerdown.prevent="closeKeypad()"
      ></div>
      <!-- draggable panel -->
      <div
        class="absolute glass rounded-2xl w-[320px] max-w-[92vw] p-4 shadow-2xl"
        :style="{ left: calcPos.x + 'px', top: calcPos.y + 'px' }"
        @click.stop
        @touchmove.prevent
      >
        <!-- header (drag handle) -->
        <div
          class="flex items-center justify-between mb-3 cursor-move select-none"
          @pointerdown.prevent="startDrag"
        >
          <div class="text-xs font-black text-gray-200">è¼¸å…¥é‡‘é¡ï¼ˆå¯è¨ˆæ•¸ï¼‰</div>
          <button
            type="button"
            class="w-9 h-9 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all"
            @pointerdown.prevent.stop="closeKeypad()"
            aria-label="é—œé–‰"
            title="é—œé–‰"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <!-- display -->
        <div class="glass-input rounded-2xl px-3 py-3 mb-3">
          <div class="text-[10px] font-bold text-gray-500 mb-1">Expression</div>
          <div class="font-num font-black text-2xl text-right break-all text-white">
            {{ keypadExpr || '0' }}
          </div>
          <div class="mt-2 flex items-center justify-between">
            <div class="text-[10px] font-bold text-gray-500">Result</div>
            <div class="font-num font-black text-lg text-right text-gray-300">
              {{ amountPreviewText }}
            </div>
          </div>
          <div v-if="keypadHint" class="text-[10px] font-bold text-red-400 mt-1 text-right">
            {{ keypadHint }}
          </div>
        </div>
        <!-- keys -->
        <div class="grid grid-cols-4 gap-2 text-sm font-black select-none">
          <button class="bg-white/10 rounded-xl py-3 btn-press" @click="kp('C')">C</button>
          <button
            class="bg-white/10 rounded-xl py-3 btn-press"
            @mousedown.prevent="startBackspaceHold()"
            @mouseup.prevent="stopBackspaceHold()"
            @mouseleave.prevent="stopBackspaceHold()"
            @touchstart.prevent="startBackspaceHold()"
            @touchend.prevent="stopBackspaceHold()"
            @touchcancel.prevent="stopBackspaceHold()"
          >âŒ«</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('/')">Ã·</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('*')">Ã—</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('7')">7</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('8')">8</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('9')">9</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('-')">âˆ’</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('4')">4</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('5')">5</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('6')">6</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('+')">ï¼‹</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('1')">1</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('2')">2</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('3')">3</button>
          <button class="bg-emerald-600 rounded-xl py-3 btn-press row-span-2" @click="kp('=')">
            =<div class="text-[9px] font-bold opacity-80 mt-1">OK</div>
          </button>
          <button class="bg-white/5 rounded-xl py-3 btn-press col-span-2" @click="kp('0')">0</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('.')">.</button>
        </div>
      </div>
    </div>
  </transition>

  <div class="fixed bottom-0 left-0 right-0 footer-gradient z-40 pointer-events-none"></div>
  <div v-if="showResetMenu" @click="showResetMenu = false" class="fixed inset-0 z-40 bg-transparent"></div>

  <!-- Footer -->
  <footer class="fixed bottom-6 left-0 right-0 max-w-[500px] mx-auto px-6 z-50 grid grid-cols-2 gap-4 pointer-events-none">
    <button @click="showShareModal = true" :disabled="getTotalExpensesCount() === 0"
            class="pointer-events-auto bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-xs shadow-2xl shadow-emerald-900/40 btn-press disabled:opacity-50 disabled:grayscale transition-all flex items-center justify-center gap-2 border border-emerald-400/20 backdrop-blur-md text-white">
      <i class="fas fa-receipt"></i> çµç®—åˆ†äº«
    </button>
    <div class="relative pointer-events-auto group">
      <button @click="showResetMenu = !showResetMenu" class="w-full bg-[#151515]/90 border border-white/10 py-4 rounded-2xl font-black text-xs text-gray-400 backdrop-blur-md btn-press hover:bg-white/5 transition-all flex items-center justify-center gap-2 shadow-xl">
        <i class="fas fa-cog"></i> é‡è¨­
      </button>
      <div v-if="showResetMenu" class="absolute bottom-full mb-3 left-0 right-0 bg-[#1a1a1a] rounded-2xl border border-white/10 overflow-hidden shadow-2xl z-50">
        <button @click="resetData('expenses')" class="w-full p-4 text-xs font-bold text-left text-red-300 border-b border-white/5 hover:bg-white/5">
          <i class="fas fa-eraser mr-2"></i>åªæ¸…ç©ºæ¶ˆè²»ç´€éŒ„
        </button>
        <button @click="resetData('all')" class="w-full p-4 text-xs font-bold text-left text-red-500 hover:bg-white/5">
          <i class="fas fa-bomb mr-2"></i>æ¸…é™¤æ‰€æœ‰ç´€éŒ„ (åŒ…æ‹¬æœ‹å‹)
        </button>
      </div>
    </div>
  </footer>
  <!-- Sync Modal -->
  <div v-if="showSyncModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6" @click.self="showSyncModal = false">
    <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] relative overflow-hidden">
      <div class="absolute top-0 left-0 right-0 h-32 bg-gradient-to-b from-emerald-900/20 to-transparent pointer-events-none"></div>
      <div class="relative z-10 text-center mb-8">
        <img src="favicon.svg" class="w-20 h-20 mx-auto mb-4 rounded-2xl shadow-[0_0_20px_rgba(16,185,129,0.3)] border border-white/10 object-contain bg-black/20">
        <h3 class="text-xl font-black">ç™»å…¥åŒæ­¥æˆ¿é–“</h3>
      </div>
      <div class="mb-6 relative group">
        <input v-model="roomInput" type="number" class="w-full text-center text-4xl font-num font-bold py-4 bg-black/40 rounded-2xl outline-none border border-white/10 focus:border-emerald-500/50 transition-all text-emerald-400 placeholder-white/5 tracking-widest" placeholder="0000">
        <p class="text-[9px] text-gray-600 text-center mt-2 font-bold uppercase">è¼¸å…¥ 4 ä½æ•¸æˆ¿è™Ÿ</p>
      </div>
      <div class="grid grid-cols-2 gap-3 mb-8">
        <button @click="joinRoom(roomInput)" class="bg-emerald-600 py-3.5 rounded-xl font-black text-xs btn-press">é€²å…¥æˆ¿é–“</button>
        <button @click="createRoom" class="bg-white/5 border border-white/10 py-3.5 rounded-xl font-black text-xs btn-press hover:bg-white/10">æ–°é–‹æˆ¿é–“</button>
      </div>
      <div v-if="recentRoomsWithNames.length > 0" class="border-t border-white/5 pt-5">
        <p class="text-[9px] text-gray-500 font-bold uppercase mb-3 px-1">æœ€è¿‘ç€è¦½</p>
        <div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-1">
          <div v-for="r in recentRoomsWithNames" :key="r.id" class="flex items-center gap-2 group">
            <button @click="joinRoom(r.id)" class="flex-1 bg-white/5 p-3 rounded-xl flex items-center border border-transparent hover:border-emerald-500/30 transition-all text-left">
              <span class="font-num text-emerald-500 font-bold mr-3 text-xs">#{{ r.id }}</span>
              <span class="text-[10px] font-bold text-gray-300 truncate flex-1">{{ r.name }}</span>
            </button>
            <button @click="removeHistoryRoom(r.id)" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-600 hover:text-red-400 hover:bg-red-500/10 transition-colors">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
      </div>
      <button @click="showSyncModal = false" class="absolute top-6 right-6 text-gray-500 hover:text-white">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
  </div>

  <!-- Share Modal -->
  <div v-if="showShareModal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex flex-col p-4 overflow-y-auto" @click.self="showShareModal = false">
    <div class="max-w-md mx-auto w-full my-auto">
      <div id="capture-zone" class="bg-[#e8e8e8] text-black p-6 rounded-lg shadow-2xl mb-6 relative font-mono">
        <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-b from-gray-300 to-transparent opacity-20"></div>
        <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4">
          <h2 class="font-black text-2xl tracking-tighter uppercase mb-1">éæ•¸é€šçŸ¥å–®</h2>
          <p v-if="eventName" class="text-sm font-bold text-gray-600">{{ eventName }}</p>
        </div>
        
        <!-- å¤šå¤©æ¨¡å¼ï¼šé¡¯ç¤ºç¸½è¨ˆ -->
        <div class="flex justify-between items-end mb-4 px-2">
          <span class="text-xs font-bold text-gray-600">ç¸½æ”¯å‡º (Total)</span>
          <span class="font-black text-2xl tracking-tight">${{ shareTotal.toFixed(1) }}</span>
        </div>

        <!-- å¤šå¤©æ¨¡å¼ï¼šé¡¯ç¤ºé¸æ“‡çš„å¤©æ•¸ -->
        <div v-if="multiDayMode && shareDayIds.length > 0" class="bg-white/50 p-2 rounded mb-4">
          <p class="text-[9px] font-bold text-gray-500 mb-1">åŒ…å«å¤©æ•¸</p>
          <div class="flex flex-wrap gap-1">
            <span v-for="dayId in shareDayIds" :key="dayId" class="text-[10px] bg-emerald-100 text-emerald-700 px-2 py-0.5 rounded font-bold">
              {{ getDayName(dayId) }}
            </span>
          </div>
        </div>

        <div class="bg-white p-3 rounded border border-gray-300 mb-4">
          <p class="text-[10px] font-bold text-gray-500 mb-2 border-b border-gray-200 pb-1">éæ•¸æŒ‡å— (Payment Guide)</p>
          <div v-if="shareSettlements.length === 0" class="text-center text-gray-400 text-xs py-2">æ²’æœ‰äººéœ€è¦å¤¾éŒ¢</div>
          <div v-for="s in shareSettlements" :key="s.from + s.to" class="flex justify-between items-center py-1 text-sm font-bold">
            <div class="flex items-center gap-2">
              <span class="text-red-600">{{ s.from }}</span>
              <i class="fas fa-arrow-right-long text-gray-400 mx-2"></i>
              <span class="text-emerald-600">{{ s.to }}</span>
            </div>
            <span>${{ s.amount.toFixed(1) }}</span>
          </div>
        </div>

        <div v-if="shareOptions.showList" class="mt-4 pt-2 border-t-2 border-dashed border-gray-400">
          <p class="text-[10px] font-bold text-gray-500 mb-2 text-center uppercase">-- æ¶ˆè²»ç´€éŒ„ (Details) --</p>
          
          <!-- å¤šå¤©æ¨¡å¼ï¼šæŒ‰å¤©åˆ†çµ„é¡¯ç¤º -->
          <template v-if="multiDayMode">
            <div v-for="dayId in shareDayIds" :key="dayId" class="mb-3">
              <div class="bg-emerald-50 px-2 py-1 rounded mb-1">
                <span class="text-[10px] font-black text-emerald-700">{{ getDayName(dayId) }}</span>
                <span class="text-[9px] text-gray-500 ml-2">${{ getDayTotal(dayId).toFixed(1) }}</span>
              </div>
              <div v-for="e in getDayExpenses(dayId)" :key="e.id" class="capture-row flex justify-between text-[10px] leading-[1.4] py-1.5 border-b border-gray-300 last:border-0 pl-2">
                <span class="truncate pr-2 font-medium">{{ e.item }} <span class="text-gray-400">({{ e.payer }})</span></span>
                <span class="whitespace-nowrap font-bold">${{ e.hkd.toFixed(1) }}</span>
              </div>
            </div>
          </template>

          <!-- å–®å¤©æ¨¡å¼ï¼šç›´æ¥é¡¯ç¤º -->
          <template v-else>
            <div v-for="e in shareExpenses" :key="e.id" class="capture-row flex justify-between text-[10px] leading-[1.4] py-1.5 border-b border-gray-300 last:border-0">
              <span class="truncate pr-2 font-medium">{{ e.item }} <span class="text-gray-400">({{ e.payer }})</span></span>
              <span class="whitespace-nowrap font-bold">${{ e.hkd.toFixed(1) }}</span>
            </div>
          </template>
        </div>

        <div class="mt-6 text-center">
          <p class="text-[10px] font-bold text-gray-500">Generated by âš¡ MathGod</p>
          <div class="h-2 opacity-0">.</div>
        </div>
      </div>

      <div class="glass p-6 rounded-[2rem] space-y-4">
        <!-- å¤šå¤©æ¨¡å¼ï¼šé¸æ“‡è¦åˆ†äº«çš„å¤©æ•¸ -->
        <div v-if="multiDayMode" class="bg-black/20 p-4 rounded-xl border border-white/5 space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold text-gray-300">é¸æ“‡è¦åˆ†äº«çš„å¤©æ•¸</span>
            <button @click="selectAllShareDays" class="text-[10px] text-emerald-400 font-bold hover:text-white">
              {{ shareDayIds.length === days.length ? 'å–æ¶ˆå…¨é¸' : 'å…¨é¸' }}
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto custom-scroll">
            <div v-for="day in days" :key="day.id" 
                 @click="toggleShareDay(day.id)"
                 class="flex items-center gap-2 p-2 rounded-lg cursor-pointer transition-all"
                 :class="shareDayIds.includes(day.id) ? 'bg-emerald-500/20 border border-emerald-500/50' : 'bg-white/5 border border-white/10'">
              <input type="checkbox" :checked="shareDayIds.includes(day.id)" class="math-check pointer-events-none">
              <div class="flex-1 min-w-0">
                <div class="text-[10px] font-bold truncate">{{ day.name }}</div>
                <div class="text-[9px] text-gray-400 font-num">${{ getDayTotal(day.id).toFixed(1) }}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-between items-center bg-black/20 p-3 rounded-xl border border-white/5">
          <span class="text-xs font-bold text-gray-300">åˆ—å‡ºæ¶ˆè²»ç´€éŒ„</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" v-model="shareOptions.showList" class="sr-only peer">
            <div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
          </label>
        </div>

        <div v-if="shareSubMenu === 'none'" class="grid grid-cols-2 gap-3">
          <button @click="shareSubMenu = 'text'" class="bg-gray-700 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-file-alt text-lg"></i> åˆ†äº«æ–‡å­—
          </button>
          <button @click="shareSubMenu = 'image'" class="bg-emerald-600 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-image text-lg"></i> åˆ†äº«åœ–ç‰‡
          </button>
        </div>

        <div v-if="shareSubMenu === 'text'" class="space-y-3">
          <button @click="copyText" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-copy mr-2"></i> è¤‡è£½æ–‡å­—
          </button>
          <button @click="shareViaApp('text')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>

        <div v-if="shareSubMenu === 'image'" class="space-y-3">
          <button @click="generateImage" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-download mr-2"></i> ä¸‹è¼‰åœ–ç‰‡
          </button>
          <button @click="shareViaApp('image')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share-nodes mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>
      </div>

      <button @click="showShareModal = false; shareSubMenu = 'none'"
              class="w-full bg-white/10 py-3 rounded-xl text-xs font-black mt-4 border border-white/10 hover:bg-white/15 btn-press">
        é—œé–‰
      </button>
    </div>
  </div>
  <!-- Tutorial Modal -->
  <div v-if="showTutorial" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex items-center justify-center p-6 overflow-y-auto" @click.self="showTutorial = false">
    <div class="glass w-full max-w-md p-8 rounded-[2.5rem] relative my-auto">
      <button @click="showTutorial = false" class="absolute top-6 right-6 text-gray-500 hover:text-white transition-colors">
        <i class="fas fa-times text-xl"></i>
      </button>
      <div class="text-center mb-6">
        <img src="favicon.svg" class="w-16 h-16 mx-auto mb-4 rounded-2xl shadow-lg border border-white/10 object-contain">
        <h3 class="text-2xl font-black mb-2">ä½¿ç”¨æ•™å­¸</h3>
        <p class="text-xs text-gray-400">å¿«é€Ÿä¸Šæ‰‹ MathGod</p>
      </div>
      <div class="space-y-4 text-sm">
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-users text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">1. åŠ å…¥æœ‹å‹</h4>
              <p class="text-xs text-gray-400">å…ˆè¼¸å…¥åƒèˆ‡æ´»å‹•çš„æœ‹å‹åå­—</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-receipt text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">2. è¨˜éŒ„æ¶ˆè²»</h4>
              <p class="text-xs text-gray-400">è¼¸å…¥æ¶ˆè²»é …ç›®ã€é‡‘é¡ã€èª°ä»˜éŒ¢ã€èª°æœ‰ä»½</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-calculator text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">3. è¨ˆæ•¸æ©ŸåŠŸèƒ½</h4>
              <p class="text-xs text-gray-400">é»æ“Šè¨ˆç®—æ©Ÿåœ–ç¤ºå¯ä»¥é€²è¡ŒåŠ æ¸›ä¹˜é™¤é‹ç®—ï¼Œé•·æŒ‰é€€æ ¼éµå¿«é€Ÿæ¸…é™¤</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-calendar-week text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">4. å¤šå¤©æ¨¡å¼</h4>
              <p class="text-xs text-gray-400">é–‹å•Ÿå¤šå¤©æ¨¡å¼å¯ä»¥åˆ†å¤©è¨˜éŒ„æ¶ˆè²»ï¼Œé•·æŒ‰æ¨™ç±¤å¯æ‹–å‹•æ’åº</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-share-nodes text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">5. çµç®—åˆ†äº«</h4>
              <p class="text-xs text-gray-400">é»æ“Šã€Œçµç®—åˆ†äº«ã€ç”Ÿæˆéæ•¸é€šçŸ¥å–®ï¼Œå¯é¸æ“‡åˆ†äº«æ–‡å­—æˆ–åœ–ç‰‡</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-cloud text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">6. åŒæ­¥åŠŸèƒ½</h4>
              <p class="text-xs text-gray-400">é»æ“Šã€ŒåŒæ­¥MODEã€å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“ï¼Œèˆ‡æœ‹å‹å³æ™‚åŒæ­¥è³‡æ–™</p>
            </div>
          </div>
        </div>
        <div class="bg-white/5 p-4 rounded-xl border border-white/10">
          <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center flex-shrink-0">
              <i class="fas fa-edit text-emerald-400 text-xs"></i>
            </div>
            <div>
              <h4 class="font-bold mb-1">7. ä¿®æ”¹ç´€éŒ„</h4>
              <p class="text-xs text-gray-400">é»æ“Šä»»ä½•æ¶ˆè²»ç´€éŒ„å³å¯ä¿®æ”¹å…§å®¹</p>
            </div>
          </div>
        </div>
      </div>
      <button @click="showTutorial = false" class="w-full bg-emerald-600 py-4 rounded-xl font-black text-sm mt-6 btn-press">
        é–‹å§‹ä½¿ç”¨
      </button>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDMt1kJLMDdNXVWlNxfJQqLFyVTKOxrPSI",
  authDomain: "mathgod-9a8f8.firebaseapp.com",
  databaseURL: "https://mathgod-9a8f8-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mathgod-9a8f8",
  storageBucket: "mathgod-9a8f8.firebasestorage.app",
  messagingSenderId: "1091779362530",
  appId: "1:1091779362530:web:b9c7c2f8f3c9f0b8e5f5e5"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

createApp({
  data() {
    return {
      // åŸºæœ¬è³‡æ–™
      eventName: '',
      users: [],
      expenses: [],
      newUser: '',
      
      // å¤šå¤©æ¨¡å¼
      multiDayMode: false,
      days: [],
      currentDayId: null,
      editingDayId: null,
      editingName: '',
      deletingDayId: null,
      deleteConfirmTimer: null,
      sortableInstance: null,

      // è¡¨å–®
      form: {
        item: '',
        amount: '',
        currency: 'HKD',
        payer: '',
        involved: []
      },

      // ç·¨è¼¯ç‹€æ…‹
      isEditing: false,
      editingId: null,
      lastAddedId: null,

      // éŒ¯èª¤æç¤º
      errors: {
        item: false,
        amount: false,
        payer: false,
        involved: false
      },

      // UI ç‹€æ…‹
      showSyncModal: false,
      showShareModal: false,
      showResetMenu: false,
      showTutorial: false,
      isLoading: true,
      toasts: [],

      // åŒæ­¥ç›¸é—œ
      roomId: null,
      roomInput: '',
      isOnline: navigator.onLine,
      isSyncing: false,
      recentRooms: [],

      // åŒ¯ç‡
      rates: {
        HKD: 1,
        CNY: 1.1,
        JPY: 0.055,
        TWD: 0.25,
        THB: 0.22,
        KRW: 0.0059,
        USD: 7.8,
        EUR: 8.5,
        GBP: 10
      },
      rateUpdatedAt: null,

      // åˆ†äº«é¸é …
      shareOptions: {
        showList: true
      },
      shareSubMenu: 'none',
      shareDayIds: [], // é¸æ“‡è¦åˆ†äº«çš„å¤©æ•¸

      // è¨ˆç®—æ©Ÿ
      showKeypad: false,
      keypadExpr: '',
      keypadHint: '',
      calcPos: { x: 20, y: 100 },
      isDragging: false,
      dragStart: { x: 0, y: 0 },
      backspaceTimer: null,
      backspaceInterval: null
    };
  },

  computed: {
    currentRate() {
      return this.rates[this.form.currency] || 1;
    },

    amountFontClass() {
      const len = String(this.form.amount || '').length;
      if (len >= 12) return 'text-base';
      if (len >= 9) return 'text-lg';
      if (len >= 6) return 'text-xl';
      return 'text-2xl';
    },

    amountPreviewText() {
      const val = this.safeEval(this.keypadExpr);
      if (val === null) return '---';
      return val.toFixed(2);
    },

    // å¤šå¤©æ¨¡å¼ç›¸é—œ
    currentDayName() {
      if (!this.multiDayMode) return '';
      const day = this.days.find(d => d.id === this.currentDayId);
      return day ? day.name : '';
    },

    currentExpenses() {
      if (!this.multiDayMode) return this.expenses;
      return this.expenses.filter(e => e.dayId === this.currentDayId);
    },

    currentDayTotal() {
      return this.currentExpenses.reduce((sum, e) => sum + (e.hkd || 0), 0);
    },

    // åˆ†äº«ç›¸é—œ
    shareExpenses() {
      if (!this.multiDayMode) {
        return this.expenses;
      }
      // å¤šå¤©æ¨¡å¼ï¼šåªè¿”å›é¸ä¸­å¤©æ•¸çš„æ¶ˆè²»
      return this.expenses.filter(e => this.shareDayIds.includes(e.dayId));
    },

    shareTotal() {
      return this.shareExpenses.reduce((sum, e) => sum + (e.hkd || 0), 0);
    },

    shareSettlements() {
      const balances = {};
      this.users.forEach(u => balances[u] = 0);

      this.shareExpenses.forEach(exp => {
        const perPerson = exp.hkd / exp.involved.length;
        balances[exp.payer] += exp.hkd;
        exp.involved.forEach(person => {
          balances[person] -= perPerson;
        });
      });

      const debtors = [];
      const creditors = [];
      for (const [name, balance] of Object.entries(balances)) {
        if (balance < -0.01) debtors.push({ name, amount: -balance });
        else if (balance > 0.01) creditors.push({ name, amount: balance });
      }

      debtors.sort((a, b) => b.amount - a.amount);
      creditors.sort((a, b) => b.amount - a.amount);

      const settlements = [];
      let i = 0, j = 0;
      while (i < debtors.length && j < creditors.length) {
        const debtor = debtors[i];
        const creditor = creditors[j];
        const amount = Math.min(debtor.amount, creditor.amount);
        settlements.push({ from: debtor.name, to: creditor.name, amount });
        debtor.amount -= amount;
        creditor.amount -= amount;
        if (debtor.amount < 0.01) i++;
        if (creditor.amount < 0.01) j++;
      }

      return settlements;
    },

    recentRoomsWithNames() {
      return this.recentRooms.map(r => ({
        id: r.id,
        name: r.name || 'æœªå‘½åæ´»å‹•'
      }));
    }
  },

  watch: {
    multiDayMode(val) {
      if (val && this.days.length === 0) {
        this.addNewDay();
      }
      this.saveData();
    },

    days: {
      deep: true,
      handler() {
        this.saveData();
      }
    },

    currentDayId() {
      this.saveData();
    }
  },

  mounted() {
    this.loadData();
    this.loadRecentRooms();
    this.checkUrlRoom();
    this.fetchRates();
    
    window.addEventListener('online', () => {
      this.isOnline = true;
      this.toast('ç¶²çµ¡å·²é€£ç·š', 'success');
    });
    window.addEventListener('offline', () => {
      this.isOnline = false;
      this.toast('ç¶²çµ¡å·²æ–·ç·š', 'error');
    });

    setTimeout(() => {
      this.isLoading = false;
    }, 800);

    // åˆå§‹åŒ– Sortable
    this.$nextTick(() => {
      this.initSortable();
    });
  },
  methods: {
    // ===== å¤šå¤©æ¨¡å¼ =====
    toggleMultiDay() {
      this.multiDayMode = !this.multiDayMode;
      if (this.multiDayMode && this.days.length === 0) {
        this.addNewDay();
      }
    },

    addNewDay() {
      const newDay = {
        id: Date.now(),
        name: `Day ${this.days.length + 1}`,
        expenses: []
      };
      this.days.push(newDay);
      this.currentDayId = newDay.id;
      this.saveData();
      
      this.$nextTick(() => {
        const container = this.$refs.tabsContainer;
        if (container) {
          container.scrollLeft = container.scrollWidth;
        }
      });
    },

    selectDay(dayId) {
      if (this.editingDayId === dayId) return;
      this.currentDayId = dayId;
    },

    startEditingName(dayId) {
      const day = this.days.find(d => d.id === dayId);
      if (!day) return;
      this.editingDayId = dayId;
      this.editingName = day.name;
      this.$nextTick(() => {
        const input = document.querySelector('.day-tab-input');
        if (input) {
          input.focus();
          input.select();
        }
      });
    },

    finishEditingName() {
      if (!this.editingDayId) return;
      const day = this.days.find(d => d.id === this.editingDayId);
      if (day && this.editingName.trim()) {
        day.name = this.editingName.trim();
        this.saveData();
      }
      this.editingDayId = null;
      this.editingName = '';
    },

    cancelEditingName() {
      this.editingDayId = null;
      this.editingName = '';
    },

    handleDeleteDay(dayId) {
      if (this.days.length <= 1) {
        this.toast('è‡³å°‘è¦ä¿ç•™ä¸€å¤©', 'error');
        return;
      }

      if (this.deletingDayId === dayId) {
        // ç¬¬äºŒæ¬¡é»æ“Šï¼Œç¢ºèªåˆªé™¤
        this.deleteDay(dayId);
      } else {
        // ç¬¬ä¸€æ¬¡é»æ“Šï¼Œé€²å…¥ç¢ºèªç‹€æ…‹
        this.deletingDayId = dayId;
        this.toast('å†é»ä¸€æ¬¡ç¢ºèªåˆªé™¤', 'error');
        
        // 3ç§’å¾Œè‡ªå‹•å–æ¶ˆ
        if (this.deleteConfirmTimer) {
          clearTimeout(this.deleteConfirmTimer);
        }
        this.deleteConfirmTimer = setTimeout(() => {
          this.deletingDayId = null;
        }, 3000);
      }
    },

    deleteDay(dayId) {
      const index = this.days.findIndex(d => d.id === dayId);
      if (index === -1) return;

      // åˆªé™¤è©²å¤©çš„æ‰€æœ‰æ¶ˆè²»
      this.expenses = this.expenses.filter(e => e.dayId !== dayId);

      // åˆªé™¤å¤©æ•¸
      this.days.splice(index, 1);

      // åˆ‡æ›åˆ°å…¶ä»–å¤©
      if (this.currentDayId === dayId) {
        this.currentDayId = this.days[0]?.id || null;
      }

      this.deletingDayId = null;
      if (this.deleteConfirmTimer) {
        clearTimeout(this.deleteConfirmTimer);
      }

      this.saveData();
      this.toast('å·²åˆªé™¤', 'success');
    },

    getDayTotal(dayId) {
      return this.expenses
        .filter(e => e.dayId === dayId)
        .reduce((sum, e) => sum + (e.hkd || 0), 0);
    },

    getDayName(dayId) {
      const day = this.days.find(d => d.id === dayId);
      return day ? day.name : '';
    },

    getDayExpenses(dayId) {
      return this.expenses.filter(e => e.dayId === dayId);
    },

    getTotalExpensesCount() {
      return this.expenses.length;
    },

    initSortable() {
      const container = document.getElementById('sortable-tabs');
      if (!container) return;

      if (this.sortableInstance) {
        this.sortableInstance.destroy();
      }

      this.sortableInstance = Sortable.create(container, {
        animation: 150,
        filter: '.tab-item:last-child', // æ’é™¤ã€Œ+ã€æŒ‰éˆ•
        preventOnFilter: true,
        delay: 200,
        delayOnTouchOnly: true,
        onEnd: (evt) => {
          const oldIndex = evt.oldIndex;
          const newIndex = evt.newIndex;
          
          if (oldIndex !== newIndex && oldIndex < this.days.length && newIndex < this.days.length) {
            const movedDay = this.days.splice(oldIndex, 1)[0];
            this.days.splice(newIndex, 0, movedDay);
            this.saveData();
          }
        }
      });
    },

    // ===== ç”¨æˆ¶ç®¡ç† =====
    addUser() {
      const name = this.newUser.trim();
      if (!name) return;
      if (this.users.includes(name)) {
        this.toast('åå­—å·²å­˜åœ¨', 'error');
        return;
      }
      this.users.push(name);
      this.newUser = '';
      this.saveData();
      this.toast(`å·²åŠ å…¥ ${name}`, 'success');
    },

    removeUser(index) {
      const name = this.users[index];
      this.users.splice(index, 1);
      this.saveData();
      this.toast(`å·²ç§»é™¤ ${name}`, 'success');
    },

    // ===== æ¶ˆè²»ç®¡ç† =====
    addExpense() {
      // é©—è­‰
      this.errors = {
        item: !this.form.item.trim(),
        amount: !this.form.amount || isNaN(Number(this.form.amount)) || Number(this.form.amount) <= 0,
        payer: !this.form.payer,
        involved: this.form.involved.length === 0
      };

      if (Object.values(this.errors).some(e => e)) {
        this.toast('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«é …ç›®', 'error');
        return;
      }

      const hkd = Number(this.form.amount) * this.currentRate;
      const expense = {
        id: this.isEditing ? this.editingId : Date.now(),
        item: this.form.item.trim(),
        origAmount: Number(this.form.amount),
        origCurrency: this.form.currency,
        hkd: hkd,
        payer: this.form.payer,
        involved: [...this.form.involved],
        dayId: this.multiDayMode ? this.currentDayId : null
      };

      if (this.isEditing) {
        const index = this.expenses.findIndex(e => e.id === this.editingId);
        if (index !== -1) {
          this.expenses.splice(index, 1, expense);
          this.toast('å·²æ›´æ–°', 'success');
        }
        this.isEditing = false;
        this.editingId = null;
      } else {
        this.expenses.unshift(expense);
        this.lastAddedId = expense.id;
        setTimeout(() => { this.lastAddedId = null; }, 1000);
        this.toast('å·²æ–°å¢', 'success');
      }

      this.resetForm();
      this.saveData();
    },

    editExpense(index) {
      const exp = this.currentExpenses[index];
      if (!exp) return;

      this.form = {
        item: exp.item,
        amount: String(exp.origAmount),
        currency: exp.origCurrency,
        payer: exp.payer,
        involved: [...exp.involved]
      };

      this.isEditing = true;
      this.editingId = exp.id;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    },

    cancelEdit() {
      this.isEditing = false;
      this.editingId = null;
      this.resetForm();
    },

    removeExpense(index) {
      const exp = this.currentExpenses[index];
      if (!exp) return;
      
      const globalIndex = this.expenses.findIndex(e => e.id === exp.id);
      if (globalIndex !== -1) {
        this.expenses.splice(globalIndex, 1);
        this.saveData();
        this.toast('å·²åˆªé™¤', 'success');
      }
    },

    resetForm() {
      this.form = {
        item: '',
        amount: '',
        currency: 'HKD',
        payer: '',
        involved: []
      };
      this.errors = {
        item: false,
        amount: false,
        payer: false,
        involved: false
      };
    },

    toggleInvolved(user) {
      const index = this.form.involved.indexOf(user);
      if (index > -1) {
        this.form.involved.splice(index, 1);
      } else {
        this.form.involved.push(user);
      }
    },

    toggleSelectAll() {
      if (this.form.involved.length === this.users.length) {
        this.form.involved = [];
      } else {
        this.form.involved = [...this.users];
      }
    },

    sanitizeAmount() {
      this.form.amount = this.form.amount.replace(/[^0-9.]/g, '');
      const parts = this.form.amount.split('.');
      if (parts.length > 2) {
        this.form.amount = parts[0] + '.' + parts.slice(1).join('');
      }
    },

    handleCurrencyChange() {
      this.saveData();
    },

    // ===== æ—¥æœŸé¸æ“‡ =====
    openDatePicker() {
      document.getElementById('dateInput').click();
    },

    appendDate(e) {
      const date = e.target.value;
      if (!date) return;
      const formatted = new Date(date).toLocaleDateString('zh-HK', {
        month: 'numeric',
        day: 'numeric'
      });
      this.eventName = this.eventName ? `${this.eventName} ${formatted}` : formatted;
      this.saveData();
      e.target.value = '';
    },
    // ===== è¨ˆç®—æ©Ÿ =====
    openKeypad() {
      this.showKeypad = true;
      this.keypadExpr = this.form.amount || '';
      this.keypadHint = '';
      
      // å±…ä¸­é¡¯ç¤º
      const vw = window.innerWidth;
      const vh = window.innerHeight;
      this.calcPos = {
        x: Math.max(10, (vw - 320) / 2),
        y: Math.max(10, (vh - 450) / 2)
      };
    },

    closeKeypad() {
      const val = this.safeEval(this.keypadExpr);
      if (val !== null && val > 0) {
        this.form.amount = val.toFixed(2);
      }
      this.showKeypad = false;
      this.keypadExpr = '';
      this.keypadHint = '';
    },

    kp(key) {
      if (key === 'C') {
        this.keypadExpr = '';
        this.keypadHint = '';
      } else if (key === 'âŒ«') {
        this.keypadExpr = this.keypadExpr.slice(0, -1);
        this.keypadHint = '';
      } else if (key === '=') {
        const val = this.safeEval(this.keypadExpr);
        if (val !== null) {
          this.form.amount = val.toFixed(2);
          this.showKeypad = false;
          this.keypadExpr = '';
          this.keypadHint = '';
        } else {
          this.keypadHint = 'è¨ˆç®—éŒ¯èª¤';
        }
      } else {
        const last = this.keypadExpr.slice(-1);
        const isOp = ['+', '-', '*', '/'].includes(key);
        const lastIsOp = ['+', '-', '*', '/'].includes(last);
        
        if (isOp && lastIsOp) {
          this.keypadExpr = this.keypadExpr.slice(0, -1) + key;
        } else if (key === '.' && last === '.') {
          return;
        } else {
          this.keypadExpr += key;
        }
        this.keypadHint = '';
      }
    },

    safeEval(expr) {
      try {
        if (!expr) return null;
        expr = expr.replace(/[^0-9+\-*/.]/g, '');
        if (!expr) return null;
        const result = Function('"use strict"; return (' + expr + ')')();
        return isFinite(result) ? result : null;
      } catch {
        return null;
      }
    },

    startDrag(e) {
      this.isDragging = true;
      const touch = e.touches ? e.touches[0] : e;
      this.dragStart = {
        x: touch.clientX - this.calcPos.x,
        y: touch.clientY - this.calcPos.y
      };

      const moveHandler = (e) => {
        if (!this.isDragging) return;
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        const newX = touch.clientX - this.dragStart.x;
        const newY = touch.clientY - this.dragStart.y;
        
        const maxX = window.innerWidth - 320;
        const maxY = window.innerHeight - 450;
        
        this.calcPos = {
          x: Math.max(10, Math.min(newX, maxX)),
          y: Math.max(10, Math.min(newY, maxY))
        };
      };

      const upHandler = () => {
        this.isDragging = false;
        document.removeEventListener('pointermove', moveHandler);
        document.removeEventListener('pointerup', upHandler);
        document.removeEventListener('touchmove', moveHandler);
        document.removeEventListener('touchend', upHandler);
      };

      document.addEventListener('pointermove', moveHandler);
      document.addEventListener('pointerup', upHandler);
      document.addEventListener('touchmove', moveHandler, { passive: false });
      document.addEventListener('touchend', upHandler);
    },

    startBackspaceHold() {
      this.kp('âŒ«');
      this.backspaceTimer = setTimeout(() => {
        this.backspaceInterval = setInterval(() => {
          this.kp('âŒ«');
        }, 100);
      }, 500);
    },

    stopBackspaceHold() {
      if (this.backspaceTimer) {
        clearTimeout(this.backspaceTimer);
        this.backspaceTimer = null;
      }
      if (this.backspaceInterval) {
        clearInterval(this.backspaceInterval);
        this.backspaceInterval = null;
      }
    },

    // ===== åŒæ­¥åŠŸèƒ½ =====
    async createRoom() {
      if (!this.isOnline) {
        this.toast('è«‹å…ˆé€£æ¥ç¶²çµ¡', 'error');
        return;
      }

      const newRoomId = Math.floor(1000 + Math.random() * 9000);
      try {
        await db.ref(`rooms/${newRoomId}`).set({
          eventName: this.eventName || 'æœªå‘½åæ´»å‹•',
          users: this.users,
          expenses: this.expenses,
          multiDayMode: this.multiDayMode,
          days: this.days,
          currentDayId: this.currentDayId,
          createdAt: Date.now()
        });
        
        this.joinRoom(newRoomId);
        this.toast(`æˆ¿é–“ #${newRoomId} å·²å»ºç«‹`, 'success');
      } catch (error) {
        console.error(error);
        this.toast('å»ºç«‹æˆ¿é–“å¤±æ•—', 'error');
      }
    },

    async joinRoom(roomId) {
      if (!roomId) return;
      if (!this.isOnline) {
        this.toast('è«‹å…ˆé€£æ¥ç¶²çµ¡', 'error');
        return;
      }

      const id = String(roomId).padStart(4, '0');
      
      try {
        const snapshot = await db.ref(`rooms/${id}`).once('value');
        if (!snapshot.exists()) {
          this.toast('æˆ¿é–“ä¸å­˜åœ¨', 'error');
          return;
        }

        this.roomId = id;
        const data = snapshot.val();
        
        this.eventName = data.eventName || '';
        this.users = data.users || [];
        this.expenses = data.expenses || [];
        this.multiDayMode = data.multiDayMode || false;
        this.days = data.days || [];
        this.currentDayId = data.currentDayId || null;

        this.addToRecentRooms(id, data.eventName);
        this.showSyncModal = false;
        this.roomInput = '';

        // ç›£è½è®Šæ›´
        db.ref(`rooms/${id}`).on('value', (snapshot) => {
          if (!snapshot.exists()) return;
          const data = snapshot.val();
          
          this.eventName = data.eventName || '';
          this.users = data.users || [];
          this.expenses = data.expenses || [];
          this.multiDayMode = data.multiDayMode || false;
          this.days = data.days || [];
          this.currentDayId = data.currentDayId || null;
        });

        this.toast(`å·²åŠ å…¥æˆ¿é–“ #${id}`, 'success');
        
        // æ›´æ–° URL
        const url = new URL(window.location);
        url.searchParams.set('room', id);
        window.history.pushState({}, '', url);
      } catch (error) {
        console.error(error);
        this.toast('åŠ å…¥æˆ¿é–“å¤±æ•—', 'error');
      }
    },

    leaveRoom() {
      if (this.roomId) {
        db.ref(`rooms/${this.roomId}`).off();
        this.roomId = null;
        this.toast('å·²é›¢é–‹æˆ¿é–“', 'success');
        
        // ç§»é™¤ URL åƒæ•¸
        const url = new URL(window.location);
        url.searchParams.delete('room');
        window.history.pushState({}, '', url);
      }
    },

    checkUrlRoom() {
      const params = new URLSearchParams(window.location.search);
      const roomId = params.get('room');
      if (roomId) {
        this.roomInput = roomId;
        this.joinRoom(roomId);
      }
    },

    addToRecentRooms(roomId, name) {
      const existing = this.recentRooms.findIndex(r => r.id === roomId);
      if (existing > -1) {
        this.recentRooms.splice(existing, 1);
      }
      this.recentRooms.unshift({ id: roomId, name: name || 'æœªå‘½åæ´»å‹•' });
      if (this.recentRooms.length > 5) {
        this.recentRooms = this.recentRooms.slice(0, 5);
      }
      localStorage.setItem('recentRooms', JSON.stringify(this.recentRooms));
    },

    loadRecentRooms() {
      const stored = localStorage.getItem('recentRooms');
      if (stored) {
        try {
          this.recentRooms = JSON.parse(stored);
        } catch (e) {
          this.recentRooms = [];
        }
      }
    },

    removeHistoryRoom(roomId) {
      this.recentRooms = this.recentRooms.filter(r => r.id !== roomId);
      localStorage.setItem('recentRooms', JSON.stringify(this.recentRooms));
    },

    // ===== åˆ†äº«åŠŸèƒ½ =====
    selectAllShareDays() {
      if (this.shareDayIds.length === this.days.length) {
        this.shareDayIds = [];
      } else {
        this.shareDayIds = this.days.map(d => d.id);
      }
    },

    toggleShareDay(dayId) {
      const index = this.shareDayIds.indexOf(dayId);
      if (index > -1) {
        this.shareDayIds.splice(index, 1);
      } else {
        this.shareDayIds.push(dayId);
      }
    },

    copyText() {
      let text = `ğŸ“‹ éæ•¸é€šçŸ¥å–®\n`;
      if (this.eventName) text += `${this.eventName}\n`;
      text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      text += `ğŸ’° ç¸½æ”¯å‡ºï¼šHKD $${this.shareTotal.toFixed(1)}\n\n`;

      if (this.multiDayMode && this.shareDayIds.length > 0) {
        text += `ğŸ“… åŒ…å«å¤©æ•¸ï¼š\n`;
        this.shareDayIds.forEach(dayId => {
          text += `  â€¢ ${this.getDayName(dayId)} ($${this.getDayTotal(dayId).toFixed(1)})\n`;
        });
        text += `\n`;
      }

      text += `ğŸ’¸ éæ•¸æŒ‡å—ï¼š\n`;
      if (this.shareSettlements.length === 0) {
        text += `æ²’æœ‰äººéœ€è¦å¤¾éŒ¢\n`;
      } else {
        this.shareSettlements.forEach(s => {
          text += `${s.from} â†’ ${s.to}ï¼š$${s.amount.toFixed(1)}\n`;
        });
      }

      if (this.shareOptions.showList) {
        text += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        text += `ğŸ“ æ¶ˆè²»ç´€éŒ„ï¼š\n\n`;
        
        if (this.multiDayMode) {
          this.shareDayIds.forEach(dayId => {
            text += `ã€${this.getDayName(dayId)}ã€‘\n`;
            this.getDayExpenses(dayId).forEach(e => {
              text += `  ${e.item} (${e.payer})ï¼š$${e.hkd.toFixed(1)}\n`;
            });
            text += `\n`;
          });
        } else {
          this.shareExpenses.forEach(e => {
            text += `${e.item} (${e.payer})ï¼š$${e.hkd.toFixed(1)}\n`;
          });
        }
      }

      text += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
      text += `âš¡ Generated by MathGod`;

      navigator.clipboard.writeText(text).then(() => {
        this.toast('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
      }).catch(() => {
        this.toast('è¤‡è£½å¤±æ•—', 'error');
      });
    },
    async generateImage() {
      try {
        const zone = document.getElementById('capture-zone');
        const canvas = await html2canvas(zone, {
          backgroundColor: '#e8e8e8',
          scale: 2,
          logging: false,
          useCORS: true
        });

        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `éæ•¸å–®_${this.eventName || 'MathGod'}_${Date.now()}.png`;
          a.click();
          URL.revokeObjectURL(url);
          this.toast('åœ–ç‰‡å·²ä¸‹è¼‰', 'success');
        });
      } catch (error) {
        console.error(error);
        this.toast('ç”Ÿæˆåœ–ç‰‡å¤±æ•—', 'error');
      }
    },

    async shareViaApp(type) {
      if (!navigator.share) {
        this.toast('ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´åˆ†äº«åŠŸèƒ½', 'error');
        return;
      }

      try {
        if (type === 'text') {
          let text = `ğŸ“‹ éæ•¸é€šçŸ¥å–®\n`;
          if (this.eventName) text += `${this.eventName}\n`;
          text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
          text += `ğŸ’° ç¸½æ”¯å‡ºï¼šHKD $${this.shareTotal.toFixed(1)}\n\n`;

          if (this.multiDayMode && this.shareDayIds.length > 0) {
            text += `ğŸ“… åŒ…å«å¤©æ•¸ï¼š\n`;
            this.shareDayIds.forEach(dayId => {
              text += `  â€¢ ${this.getDayName(dayId)} ($${this.getDayTotal(dayId).toFixed(1)})\n`;
            });
            text += `\n`;
          }

          text += `ğŸ’¸ éæ•¸æŒ‡å—ï¼š\n`;
          if (this.shareSettlements.length === 0) {
            text += `æ²’æœ‰äººéœ€è¦å¤¾éŒ¢\n`;
          } else {
            this.shareSettlements.forEach(s => {
              text += `${s.from} â†’ ${s.to}ï¼š$${s.amount.toFixed(1)}\n`;
            });
          }

          if (this.shareOptions.showList) {
            text += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            text += `ğŸ“ æ¶ˆè²»ç´€éŒ„ï¼š\n\n`;
            
            if (this.multiDayMode) {
              this.shareDayIds.forEach(dayId => {
                text += `ã€${this.getDayName(dayId)}ã€‘\n`;
                this.getDayExpenses(dayId).forEach(e => {
                  text += `  ${e.item} (${e.payer})ï¼š$${e.hkd.toFixed(1)}\n`;
                });
                text += `\n`;
              });
            } else {
              this.shareExpenses.forEach(e => {
                text += `${e.item} (${e.payer})ï¼š$${e.hkd.toFixed(1)}\n`;
              });
            }
          }

          text += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
          text += `âš¡ Generated by MathGod`;

          await navigator.share({
            title: 'éæ•¸é€šçŸ¥å–®',
            text: text
          });
          this.toast('å·²åˆ†äº«', 'success');
        } else if (type === 'image') {
          const zone = document.getElementById('capture-zone');
          const canvas = await html2canvas(zone, {
            backgroundColor: '#e8e8e8',
            scale: 2,
            logging: false,
            useCORS: true
          });

          canvas.toBlob(async (blob) => {
            const file = new File([blob], `éæ•¸å–®_${this.eventName || 'MathGod'}.png`, { type: 'image/png' });
            await navigator.share({
              title: 'éæ•¸é€šçŸ¥å–®',
              files: [file]
            });
            this.toast('å·²åˆ†äº«', 'success');
          });
        }
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error(error);
          this.toast('åˆ†äº«å¤±æ•—', 'error');
        }
      }
    },

    // ===== åŒ¯ç‡ =====
    async fetchRates() {
      try {
        const response = await fetch('https://api.exchangerate-api.com/v4/latest/HKD');
        const data = await response.json();
        
        this.rates = {
          HKD: 1,
          CNY: 1 / (data.rates.CNY || 0.9),
          JPY: 1 / (data.rates.JPY || 18),
          TWD: 1 / (data.rates.TWD || 4),
          THB: 1 / (data.rates.THB || 4.5),
          KRW: 1 / (data.rates.KRW || 170),
          USD: 1 / (data.rates.USD || 0.128),
          EUR: 1 / (data.rates.EUR || 0.117),
          GBP: 1 / (data.rates.GBP || 0.1)
        };
        
        this.rateUpdatedAt = new Date().toLocaleString('zh-HK');
        this.toast('åŒ¯ç‡å·²æ›´æ–°', 'success');
      } catch (error) {
        console.error('åŒ¯ç‡æ›´æ–°å¤±æ•—:', error);
        this.toast('åŒ¯ç‡æ›´æ–°å¤±æ•—ï¼Œä½¿ç”¨é è¨­å€¼', 'error');
      }
    },

    // ===== å„²å­˜èˆ‡è®€å– =====
    saveData() {
      const data = {
        eventName: this.eventName,
        users: this.users,
        expenses: this.expenses,
        multiDayMode: this.multiDayMode,
        days: this.days,
        currentDayId: this.currentDayId
      };

      localStorage.setItem('mathgod_data', JSON.stringify(data));

      // å¦‚æœåœ¨æˆ¿é–“ä¸­ï¼ŒåŒæ­¥åˆ° Firebase
      if (this.roomId && this.isOnline && !this.isSyncing) {
        this.isSyncing = true;
        db.ref(`rooms/${this.roomId}`).update(data).then(() => {
          this.isSyncing = false;
        }).catch((error) => {
          console.error('åŒæ­¥å¤±æ•—:', error);
          this.isSyncing = false;
        });
      }
    },

    loadData() {
      const stored = localStorage.getItem('mathgod_data');
      if (stored) {
        try {
          const data = JSON.parse(stored);
          this.eventName = data.eventName || '';
          this.users = data.users || [];
          this.expenses = data.expenses || [];
          this.multiDayMode = data.multiDayMode || false;
          this.days = data.days || [];
          this.currentDayId = data.currentDayId || null;

          // å¦‚æœé–‹å•Ÿå¤šå¤©æ¨¡å¼ä½†æ²’æœ‰å¤©æ•¸ï¼Œå»ºç«‹ä¸€å¤©
          if (this.multiDayMode && this.days.length === 0) {
            this.addNewDay();
          }
        } catch (e) {
          console.error('è®€å–è³‡æ–™å¤±æ•—:', e);
        }
      }

      // æª¢æŸ¥æ˜¯å¦ç¬¬ä¸€æ¬¡ä½¿ç”¨
      const hasSeenTutorial = localStorage.getItem('mathgod_tutorial_seen');
      if (!hasSeenTutorial) {
        this.showTutorial = true;
        localStorage.setItem('mathgod_tutorial_seen', 'true');
      }
    },

    resetData(type) {
      if (type === 'expenses') {
        if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¶ˆè²»ç´€éŒ„å—ï¼Ÿ')) return;
        this.expenses = [];
        this.toast('æ¶ˆè²»ç´€éŒ„å·²æ¸…ç©º', 'success');
      } else if (type === 'all') {
        if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼ˆåŒ…æ‹¬æœ‹å‹åå–®ï¼‰å—ï¼Ÿ')) return;
        this.eventName = '';
        this.users = [];
        this.expenses = [];
        this.multiDayMode = false;
        this.days = [];
        this.currentDayId = null;
        this.toast('æ‰€æœ‰ç´€éŒ„å·²æ¸…é™¤', 'success');
      }
      this.showResetMenu = false;
      this.saveData();
    },

    // ===== å·¥å…·å‡½æ•¸ =====
    toast(message, type = 'info') {
      const id = Date.now();
      this.toasts.push({ id, message, type });
      setTimeout(() => {
        this.toasts = this.toasts.filter(t => t.id !== id);
      }, 3000);
    },

    formatCurrency(amount, currency = 'HKD') {
      const symbols = {
        HKD: 'HK$',
        CNY: 'Â¥',
        JPY: 'Â¥',
        TWD: 'NT$',
        THB: 'à¸¿',
        KRW: 'â‚©',
        USD: '$',
        EUR: 'â‚¬',
        GBP: 'Â£'
      };
      return `${symbols[currency] || ''}${amount.toFixed(2)}`;
    },

    getCurrencySymbol(currency) {
      const symbols = {
        HKD: 'HK$',
        CNY: 'Â¥',
        JPY: 'Â¥',
        TWD: 'NT$',
        THB: 'à¸¿',
        KRW: 'â‚©',
        USD: '$',
        EUR: 'â‚¬',
        GBP: 'Â£'
      };
      return symbols[currency] || currency;
    }
  },

  // ===== ç”Ÿå‘½é€±æœŸ =====
  beforeUnmount() {
    if (this.roomId) {
      db.ref(`rooms/${this.roomId}`).off();
    }
    if (this.sortableInstance) {
      this.sortableInstance.destroy();
    }
    if (this.backspaceTimer) {
      clearTimeout(this.backspaceTimer);
    }
    if (this.backspaceInterval) {
      clearInterval(this.backspaceInterval);
    }
    if (this.deleteConfirmTimer) {
      clearTimeout(this.deleteConfirmTimer);
    }
  }
}).mount('#app');
</script>
</body>
</html>
