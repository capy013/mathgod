<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹ (å¤šå¤©ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary-dark: #0a2f23;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-green: #00ff9d;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--primary-dark);
            color: #e0e0e0;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 255, 157, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(0, 157, 255, 0.05) 0%, transparent 20%);
            min-height: 100vh;
        }

        .mono { font-family: 'JetBrains Mono', monospace; }

        /* Glassmorphism Card */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Inputs */
        .glass-input {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }
        .glass-input:focus {
            outline: none;
            border-color: var(--neon-green);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.2);
        }

        /* Custom Scrollbar for Days */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Buttons */
        .btn-press {
            transition: transform 0.1s;
        }
        .btn-press:active {
            transform: scale(0.95);
        }

        /* Day Tab Active/Inactive */
        .day-tab {
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .day-tab.active {
            background: var(--neon-green);
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 255, 157, 0.4);
        }
        .day-tab.inactive {
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
        }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .list-enter-active, .list-leave-active { transition: all 0.4s ease; }
        .list-enter-from, .list-leave-to { opacity: 0; transform: translateX(-20px); }

        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-top: 3px solid var(--neon-green);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

<div id="app" class="max-w-md mx-auto relative pb-20">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-green-400 to-blue-500">
            <i class="fa-solid fa-bolt text-yellow-400 mr-2"></i>MathGod
        </h1>
        <div class="flex space-x-3">
             <div v-if="roomId" @click="copyRoomLink" class="glass-panel px-3 py-1 rounded-full text-xs flex items-center gap-2 cursor-pointer active:scale-95 transition-transform border-green-500/30 border">
                <span class="text-green-400 font-bold">â— Live</span>
                <span class="mono">{{ roomId }}</span>
                <i class="fa-regular fa-copy text-gray-400"></i>
            </div>
            <button @click="showSettings = !showSettings" class="w-8 h-8 rounded-full glass-panel flex items-center justify-center hover:bg-white/10">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </div>

    <div v-if="!isInRoom" class="glass-panel rounded-2xl p-6 mb-6 text-center space-y-4">
        <div class="text-6xl mb-4">ğŸ‘‹</div>
        <h2 class="text-xl font-bold">å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“</h2>
        <p class="text-sm text-gray-400">èˆ‡æœ‹å‹å³æ™‚åŒæ­¥å¸³ç›®ï¼Œæ”¯æ´å¤šå¤©è¡Œç¨‹ã€‚</p>
        
        <div class="grid grid-cols-2 gap-3 mt-4">
            <button @click="createRoom" class="btn-press bg-green-500 hover:bg-green-400 text-black font-bold py-3 rounded-xl shadow-lg shadow-green-500/20">
                æ–°æˆ¿é–“
            </button>
            <button @click="showJoinInput = true" v-if="!showJoinInput" class="btn-press glass-input py-3 rounded-xl font-bold">
                åŠ å…¥æˆ¿é–“
            </button>
        </div>

        <div v-if="showJoinInput" class="mt-2 flex gap-2">
            <input v-model="joinRoomId" type="text" placeholder="è¼¸å…¥æˆ¿è™Ÿ (ä¾‹å¦‚: 1234)" class="glass-input w-full p-3 rounded-xl text-center mono text-lg uppercase">
            <button @click="joinRoom" class="bg-blue-500 text-white px-4 rounded-xl">
                <i class="fa-solid fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div v-else>
        
        <div class="glass-panel rounded-2xl p-4 mb-4">
            <div class="flex flex-wrap gap-2 mb-4">
                <div v-for="(user, index) in users" :key="index" class="relative group">
                    <div class="px-3 py-1 rounded-full text-sm font-medium bg-gradient-to-r from-gray-700 to-gray-600 border border-gray-500 shadow-sm">
                        {{ user }}
                    </div>
                    <button @click="removeUser(index)" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-[10px] flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>
                <button @click="addUser" class="px-3 py-1 rounded-full text-sm font-medium border border-dashed border-gray-500 text-gray-400 hover:border-green-400 hover:text-green-400 transition-colors">
                    + äºº
                </button>
            </div>

            <div class="flex items-center justify-between text-sm">
                <div class="flex items-center gap-2">
                    <span class="text-gray-400">åŒ¯ç‡: 1 {{ currencyCode }} = </span>
                    <input type="number" v-model.number="currencyRate" @change="handleCurrencyChange" class="glass-input w-16 px-2 py-1 rounded text-center mono" step="0.01">
                    <span class="text-gray-400">HKD</span>
                </div>
                <select v-model="currencyCode" @change="handleCurrencyChange" class="glass-input px-2 py-1 rounded text-xs">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                    <option value="KRW">KRW</option>
                    <option value="THB">THB</option>
                    <option value="CNY">CNY</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                    <option value="USD">USD</option>
                    <option value="OTHER">å…¶ä»–</option>
                </select>
            </div>
        </div>

        <div class="mb-4">
            <div class="flex overflow-x-auto no-scrollbar gap-2 pb-1">
                <button 
                    v-for="day in daysList" 
                    :key="day"
                    @click="currentDay = day"
                    class="day-tab px-4 py-2 rounded-xl text-sm btn-press"
                    :class="currentDay === day ? 'active' : 'inactive'"
                >
                    Day {{ day }}
                </button>
                <button @click="addNewDay" class="px-4 py-2 rounded-xl text-sm glass-input text-gray-400 hover:text-white">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="glass-panel rounded-2xl p-4 mb-4 border-l-4 border-l-green-500">
            <div class="flex justify-between items-center mb-3">
                <span class="text-green-400 font-bold text-sm">
                    <i class="fa-solid fa-pen-to-square"></i> è¨˜å¸³ (Day {{ currentDay }})
                </span>
                <span class="text-xs text-gray-500 mono">{{ new Date().toLocaleDateString() }}</span>
            </div>

            <div class="space-y-3">
                <input v-model="newItem" placeholder="é …ç›® (e.g. æ™šé¤)" class="glass-input w-full p-3 rounded-xl">
                
                <div class="flex gap-2">
                    <input v-model.number="newPrice" type="number" placeholder="é‡‘é¡" class="glass-input w-2/3 p-3 rounded-xl mono text-lg font-bold">
                    <select v-model="newPayer" class="glass-input w-1/3 p-3 rounded-xl text-sm">
                        <option value="" disabled>èª°ä»˜?</option>
                        <option v-for="u in users" :key="u" :value="u">{{ u }}</option>
                    </select>
                </div>

                <div class="mt-2">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs text-gray-400">åˆ†éŒ¢çš„äºº:</span>
                        <button @click="toggleSelectAll" class="text-xs text-green-400">å…¨é¸/å–æ¶ˆ</button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <button 
                            v-for="user in users" 
                            :key="user" 
                            @click="toggleInvolved(user)"
                            class="px-3 py-1 rounded-lg text-xs transition-all duration-200 border"
                            :class="newInvolved.includes(user) ? 'bg-green-500/20 border-green-500 text-green-300' : 'bg-transparent border-gray-600 text-gray-500'"
                        >
                            {{ user }}
                        </button>
                    </div>
                </div>

                <button @click="addExpense" :disabled="!isFormValid" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-black font-bold py-3 rounded-xl shadow-lg mt-2 btn-press disabled:opacity-50 disabled:cursor-not-allowed">
                    åŠ å…¥ Day {{ currentDay }}
                </button>
            </div>
        </div>

        <div class="space-y-2 mb-20">
            <h3 class="text-gray-400 text-sm font-bold ml-1 mb-2">Day {{ currentDay }} æ¶ˆè²»ç´€éŒ„</h3>
            
            <div v-if="currentDayExpenses.length === 0" class="text-center py-8 text-gray-500 opacity-50">
                <i class="fa-solid fa-receipt text-4xl mb-2"></i>
                <p>é€™å¤©é‚„æ²’æœ‰æ¶ˆè²»å“¦</p>
            </div>

            <transition-group name="list">
                <div v-for="(expense, index) in currentDayExpenses" :key="expense.id" class="glass-panel p-3 rounded-xl flex justify-between items-center group">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white">{{ expense.item }}</span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-gray-700 text-gray-300">{{ expense.payer }}ä»˜</span>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">
                            æ¶‰åŠ: {{ expense.involved.length === users.length ? 'æ‰€æœ‰äºº' : expense.involved.join(', ') }}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold mono text-green-400">{{ formatMoney(expense.price) }}</div>
                        <div class="text-[10px] text-gray-500 mono">HKD {{ formatMoney(expense.hkd) }}</div>
                    </div>
                    <button @click="removeExpense(expense)" class="ml-3 text-gray-600 hover:text-red-400 w-8 h-8 flex items-center justify-center transition-colors">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </transition-group>
            
            <div v-if="currentDayExpenses.length > 0" class="text-right text-sm text-gray-400 mt-2 px-2">
                Day {{ currentDay }} ç¸½è¨ˆ: <span class="text-white font-bold mono">HKD {{ formatMoney(currentDayTotal) }}</span>
            </div>
        </div>
    </div>

    <div v-if="isInRoom" class="fixed bottom-6 left-0 right-0 flex justify-center z-50 pointer-events-none">
        <button @click="openSummaryModal" class="bg-yellow-400 hover:bg-yellow-300 text-black font-bold px-8 py-3 rounded-full shadow-2xl shadow-yellow-400/30 btn-press pointer-events-auto flex items-center gap-2">
            <i class="fa-solid fa-calculator"></i> çµç®—ç¸½æ•¸
        </button>
    </div>

    <div v-if="showSettings" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" @click.self="showSettings = false">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative">
            <h3 class="text-xl font-bold mb-4">è¨­å®š</h3>
            <div class="space-y-3">
                <button @click="resetData" class="w-full py-3 bg-red-500/20 border border-red-500 text-red-400 rounded-xl">
                    âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™
                </button>
                <button @click="logoutRoom" class="w-full py-3 bg-gray-700 hover:bg-gray-600 rounded-xl">
                    é€€å‡ºæˆ¿é–“
                </button>
                <button @click="showSettings = false" class="w-full py-3 bg-transparent border border-gray-600 rounded-xl mt-4">
                    é—œé–‰
                </button>
            </div>
        </div>
    </div>

    <div v-if="showSummary" class="fixed inset-0 z-[60] flex items-end md:items-center justify-center bg-black/90 backdrop-blur-md p-0 md:p-4 animate-fade-in" @click.self="showSummary = false">
        <div class="bg-[#0f172a] w-full md:max-w-md h-[90vh] md:h-auto md:rounded-3xl rounded-t-3xl p-6 overflow-y-auto relative flex flex-col border border-gray-700">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white"><span class="text-yellow-400">âš¡ï¸</span> æœ€çµ‚çµæœ</h3>
                <button @click="showSummary = false" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-xl"></i></button>
            </div>

            <div id="capture-area" class="bg-[#1e293b] p-5 rounded-2xl border border-gray-700 mb-4">
                <div class="text-center mb-4">
                    <div class="text-gray-400 text-xs uppercase tracking-widest mb-1">Total Spending</div>
                    <div class="text-3xl font-bold text-white mono">HKD {{ formatMoney(totalSpendingHKD) }}</div>
                </div>

                <div class="space-y-3">
                    <div v-for="(debt, idx) in calculatedDebts" :key="idx" class="flex items-center justify-between bg-[#0f172a] p-3 rounded-lg border border-gray-800">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center font-bold text-xs">{{ debt.from[0] }}</div>
                            <i class="fa-solid fa-arrow-right text-gray-600 text-xs"></i>
                            <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center font-bold text-xs">{{ debt.to[0] }}</div>
                        </div>
                        <div class="flex flex-col text-right">
                            <span class="text-sm text-gray-400">{{ debt.from }} æ¯” {{ debt.to }}</span>
                            <span class="text-lg font-bold text-yellow-400 mono">${{ formatMoney(debt.amount) }}</span>
                        </div>
                    </div>
                    <div v-if="calculatedDebts.length === 0" class="text-center text-green-400 py-2">
                        ğŸ‰ æ•¸ç›®åˆ†æ˜ï¼Œç„¡éœ€å¤¾éŒ¢ï¼
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-xs text-gray-500">
                    <span>Room: {{ roomId }}</span>
                    <span>Generated by MathGod</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-auto md:mt-0">
                <button @click="copyText" class="py-3 bg-gray-700 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-gray-600">
                    <i class="fa-regular fa-copy"></i> è¤‡è£½æ–‡å­—
                </button>
                <button @click="generateImage" class="py-3 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl font-bold flex items-center justify-center gap-2 text-white">
                    <i class="fa-solid fa-image"></i> å„²å­˜åœ–ç‰‡
                </button>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp, ref, computed, onMounted, watch } = Vue;

const firebaseConfig = {
    apiKey: "yFDRUSUFAFnZf6AGdsEA9LxSyLcZF75oIFfib5At",
    databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "mathgod2",
    storageBucket: "mathgod2.appspot.com",
    messagingSenderId: "536739462528",
    appId: "1:536739462528:web:123456"
};

// Initialize Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

createApp({
    setup() {
        // State
        const users = ref(['A', 'B']); // Default users
        const shareExpenses = ref([]);
        const currencyCode = ref('JPY');
        const currencyRate = ref(0.053); // Default JPY rate
        
        // Room State
        const roomId = ref('');
        const joinRoomId = ref('');
        const isInRoom = ref(false);
        const showJoinInput = ref(false);
        
        // UI State
        const showSettings = ref(false);
        const showSummary = ref(false);
        
        // Multi-day State
        const currentDay = ref(1);
        const totalDays = ref(1); // Keep track of max days
        
        // Input State
        const newItem = ref('');
        const newPrice = ref('');
        const newPayer = ref('');
        const newInvolved = ref([...users.value]);

        // --- Computed Properties ---

        const isFormValid = computed(() => {
            return newItem.value && newPrice.value && newPayer.value && newInvolved.value.length > 0;
        });

        const daysList = computed(() => {
            // Generate array [1, 2, ..., totalDays]
            return Array.from({length: totalDays.value}, (_, i) => i + 1);
        });

        const currentDayExpenses = computed(() => {
            return shareExpenses.value
                .filter(e => (e.day || 1) === currentDay.value) // Default to day 1 if undefined
                .sort((a, b) => b.timestamp - a.timestamp); // Newest first
        });
        
        const currentDayTotal = computed(() => {
            return currentDayExpenses.value.reduce((sum, e) => sum + (e.hkd || 0), 0);
        });

        const totalSpendingHKD = computed(() => {
            return shareExpenses.value.reduce((sum, e) => sum + (Number(e.hkd) || 0), 0);
        });

        const calculatedDebts = computed(() => {
            return calculateDebtsLogic(shareExpenses.value, users.value);
        });

        // --- Methods ---

        const formatMoney = (val) => {
            if (!val) return '0.0';
            return Number(val).toLocaleString('en-US', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
        };

        // Day Management
        const addNewDay = () => {
            totalDays.value++;
            currentDay.value = totalDays.value;
            saveData(); // Save the new totalDays to DB
        };

        // User Management
        const addUser = () => {
            const name = prompt("è¼¸å…¥åå­—:");
            if (name && !users.value.includes(name)) {
                users.value.push(name);
                newInvolved.value.push(name); // Auto select new user
                saveData();
            }
        };

        const removeUser = (index) => {
            if (confirm(`ç¢ºå®šåˆªé™¤ ${users.value[index]}?`)) {
                const removedName = users.value[index];
                users.value.splice(index, 1);
                newInvolved.value = newInvolved.value.filter(u => u !== removedName);
                saveData();
            }
        };

        const toggleInvolved = (user) => {
            if (newInvolved.value.includes(user)) {
                newInvolved.value = newInvolved.value.filter(u => u !== user);
            } else {
                newInvolved.value.push(user);
            }
        };

        const toggleSelectAll = () => {
            if (newInvolved.value.length === users.value.length) {
                newInvolved.value = [];
            } else {
                newInvolved.value = [...users.value];
            }
        };

        // Expense Management
        const addExpense = () => {
            if (!isFormValid.value) return;

            const expense = {
                id: Date.now().toString(),
                timestamp: Date.now(),
                item: newItem.value,
                price: parseFloat(newPrice.value),
                currency: currencyCode.value,
                rate: currencyRate.value,
                hkd: parseFloat(newPrice.value) * currencyRate.value,
                payer: newPayer.value,
                involved: [...newInvolved.value],
                day: currentDay.value // Critical: Tag with current day
            };

            // Local push first for instant feedback (though Firebase listener will overwrite)
            // shareExpenses.value.push(expense); 
            
            // Push to Firebase
            const roomRef = db.ref('rooms/' + roomId.value + '/expenses');
            roomRef.push(expense);

            // Reset Form
            newItem.value = '';
            newPrice.value = '';
            // keep payer
            newInvolved.value = [...users.value];
        };

        const removeExpense = (expense) => {
            if (confirm(`åˆªé™¤ ${expense.item}?`)) {
                // Remove from Firebase
                // We need the firebase key. Since we mapped array, we need to find it or change how we sync.
                // Simple way: Reload all from FB, but here we need to delete specific node.
                // Let's find the key by ID since we don't store FB key in object in this simple array map
                // Actually, let's store FB key when fetching.
                if (expense.firebaseKey) {
                    db.ref('rooms/' + roomId.value + '/expenses/' + expense.firebaseKey).remove();
                }
            }
        };

        const handleCurrencyChange = () => {
            saveData();
        };

        // --- Firebase & Logic ---

        const createRoom = () => {
            const newRoomId = Math.floor(1000 + Math.random() * 9000).toString();
            roomId.value = newRoomId;
            isInRoom.value = true;
            
            // Initial Data
            db.ref('rooms/' + newRoomId).set({
                users: ['A', 'B'],
                currencyCode: 'JPY',
                currencyRate: 0.053,
                totalDays: 1, // Init Days
                createdAt: Date.now()
            });
            
            listenToRoom(newRoomId);
        };

        const joinRoom = () => {
            if (!joinRoomId.value) return;
            const rid = joinRoomId.value;
            
            db.ref('rooms/' + rid).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    roomId.value = rid;
                    isInRoom.value = true;
                    listenToRoom(rid);
                } else {
                    alert("æ‰¾ä¸åˆ°æˆ¿é–“ï¼");
                }
            });
        };

        const listenToRoom = (rid) => {
            const roomRef = db.ref('rooms/' + rid);
            
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // Sync Config
                    if (data.users) users.value = data.users;
                    if (data.currencyCode) currencyCode.value = data.currencyCode;
                    if (data.currencyRate) currencyRate.value = data.currencyRate;
                    if (data.totalDays) totalDays.value = data.totalDays;
                    
                    // Sync Expenses
                    if (data.expenses) {
                        const arr = [];
                        Object.keys(data.expenses).forEach(key => {
                            arr.push({
                                ...data.expenses[key],
                                firebaseKey: key
                            });
                        });
                        shareExpenses.value = arr;
                    } else {
                        shareExpenses.value = [];
                    }
                }
            });
            
            // Save room ID to local storage for convenience
            localStorage.setItem('mathgod_room_id', rid);
        };

        const saveData = () => {
            if (!roomId.value) return;
            db.ref('rooms/' + roomId.value).update({
                users: users.value,
                currencyCode: currencyCode.value,
                currencyRate: currencyRate.value,
                totalDays: totalDays.value
            });
        };

        const resetData = () => {
            if (confirm("åš´é‡è­¦å‘Šï¼šé€™æœƒæ¸…ç©ºæˆ¿é–“æ‰€æœ‰å¸³ç›®ï¼")) {
                db.ref('rooms/' + roomId.value + '/expenses').remove();
                // Optional: reset users or keep them
            }
        };

        const logoutRoom = () => {
            isInRoom.value = false;
            roomId.value = '';
            shareExpenses.value = [];
            localStorage.removeItem('mathgod_room_id');
            // Stop listening? In a simple app, page refresh clears it, or we rely on v-if to hide UI
            window.location.reload();
        };

        // --- Core Calculation Logic ---
        function calculateDebtsLogic(expenses, userList) {
            let balances = {};
            userList.forEach(u => balances[u] = 0);

            expenses.forEach(e => {
                const amount = Number(e.hkd);
                const payer = e.payer;
                const involved = e.involved || [];
                
                if (amount > 0 && involved.length > 0) {
                    // Payer paid full amount
                    balances[payer] = (balances[payer] || 0) + amount;
                    
                    // Split among involved
                    const splitAmount = amount / involved.length;
                    involved.forEach(u => {
                        balances[u] = (balances[u] || 0) - splitAmount;
                    });
                }
            });

            // Resolve debts
            let debtors = [];
            let creditors = [];

            for (const [user, amount] of Object.entries(balances)) {
                if (amount < -0.01) debtors.push({ user, amount }); // Owes money
                if (amount > 0.01) creditors.push({ user, amount }); // Owed money
            }

            debtors.sort((a, b) => a.amount - b.amount); // Ascending (most negative first)
            creditors.sort((a, b) => b.amount - a.amount); // Descending (most positive first)

            let results = [];
            let i = 0; // debtor index
            let j = 0; // creditor index

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];
                
                let debtAmount = Math.abs(debtor.amount);
                let creditAmount = creditor.amount;
                
                let settleAmount = 0;

                if (debtAmount < creditAmount) {
                    settleAmount = debtAmount;
                    creditor.amount -= settleAmount;
                    debtor.amount = 0;
                    i++;
                } else {
                    settleAmount = creditAmount;
                    debtor.amount += settleAmount; // moves towards 0
                    creditor.amount = 0;
                    j++;
                }

                if (settleAmount > 0.1) {
                    results.push({
                        from: debtor.user,
                        to: creditor.user,
                        amount: settleAmount
                    });
                }
            }
            return results;
        }

        // --- Utility ---
        const copyRoomLink = () => {
            navigator.clipboard.writeText(roomId.value);
            alert("å·²è¤‡è£½æˆ¿è™Ÿ: " + roomId.value);
        };

        const openSummaryModal = () => {
            showSummary.value = true;
        };

        const copyText = () => {
            let msg = `âš¡ï¸MathGod çµç®—å–® (Room: ${roomId.value})\n`;
            msg += `------------------------------\n`;
            
            // Debts
            if (calculatedDebts.value.length === 0) {
                msg += `ç„¡éœ€å¤¾éŒ¢ï¼\n`;
            } else {
                calculatedDebts.value.forEach(d => {
                    msg += `${d.from} æ¯” ${d.to}: $${formatMoney(d.amount)}\n`;
                });
            }
            
            msg += `\nğŸ“‹ è©³ç´°ç´€éŒ„ (Total: $${formatMoney(totalSpendingHKD.value)}):\n`;
            
            // Group by Day for text export
            const grouped = {};
            shareExpenses.value.forEach(e => {
                const d = e.day || 1;
                if (!grouped[d]) grouped[d] = [];
                grouped[d].push(e);
            });

            Object.keys(grouped).sort((a,b) => a-b).forEach(dayNum => {
                msg += `\n[Day ${dayNum}]\n`;
                grouped[dayNum].forEach((e) => {
                     msg += `- ${e.item} (${e.payer}): $${formatMoney(e.hkd)}\n`;
                });
            });
            
            msg += `\nGenerated by MathGod`;
            
            navigator.clipboard.writeText(msg).then(() => {
                alert("å·²è¤‡è£½çµç®—æ–‡å­—ï¼");
            });
        };

        const generateImage = () => {
            const el = document.getElementById("capture-area");
            html2canvas(el, { backgroundColor: "#0f172a" }).then(canvas => {
                const link = document.createElement('a');
                link.download = `mathgod_summary_${roomId.value}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // Check LocalStorage for auto-login
        onMounted(() => {
            const savedRoom = localStorage.getItem('mathgod_room_id');
            if (savedRoom) {
                joinRoomId.value = savedRoom;
                joinRoom(); // Auto join
            }
        });

        return {
            users, shareExpenses, currencyCode, currencyRate,
            roomId, joinRoomId, isInRoom, showJoinInput, showSettings, showSummary,
            newItem, newPrice, newPayer, newInvolved, isFormValid,
            currentDay, totalDays, daysList, currentDayExpenses, currentDayTotal, totalSpendingHKD,
            calculatedDebts,
            addUser, removeUser, createRoom, joinRoom, logoutRoom, resetData,
            addExpense, removeExpense, toggleInvolved, toggleSelectAll,
            handleCurrencyChange, addNewDay,
            formatMoney, copyRoomLink, openSummaryModal, copyText, generateImage
        };
    }
}).mount('#app');
</script>
</body>
</html>
