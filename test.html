<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹</title>

  <meta name="description" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹ - å°ˆç‚ºæœ‹å‹èšæœƒã€æ—…è¡Œè¨­è¨ˆçš„åŒæ­¥åˆ†å¸³å·¥å…·ã€‚æ”¯æ´å¤šåœ‹åŒ¯ç‡è½‰æ›ï¼Œä¸€éµç”Ÿæˆçµç®—å–®ã€‚">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://capy013.github.io/mathgod/">
  <meta property="og:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta property="og:description" content="æ—…è¡Œã€é£Ÿé£¯ã€å¤¾éŒ¢å””ä½¿ç…©ï¼æ”¯æ´å³æ™‚åŒæ­¥åŠŸèƒ½ï¼Œè‡ªå‹•æ›ç®—åŒ¯ç‡ï¼ŒMathGod å¹«ä½ è¨ˆåˆ°ç›¡ã€‚">
  <meta property="og:image" content="favicon.svg">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta name="twitter:description" content="æœ‹å‹èšæœƒåˆ†å¸³ç¥å™¨ï¼šæ”¯æ´å¤šå¹£ç¨®ã€é›²ç«¯åŒæ­¥ã€‚">
  <meta name="twitter:image" content="favicon.svg">

  <meta name="theme-color" content="#0a2f23">

  <link rel="icon" href="favicon.svg">
  <link rel="apple-touch-icon" href="favicon.svg">

  <link rel="manifest" href="./manifest.webmanifest">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #10b981; --bg: #050505; --card-bg: rgba(30, 30, 30, 0.65); --border: rgba(255, 255, 255, 0.1); }
    [v-cloak] { display: none !important; }
    body { background-color: var(--bg); color: #fff; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .glass { background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
    .glass-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
    .glass-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); background: rgba(0,0,0,0.5); }
    .input-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .font-num { font-family: 'JetBrains Mono', monospace; }
    .btn-press { transition: transform 0.1s; }
    .btn-press:active { transform: scale(0.96); }
    .footer-gradient { background: linear-gradient(to top, rgba(5,5,5,0.95) 10%, rgba(5,5,5,0.6) 40%, rgba(5,5,5,0) 100%); pointer-events: none; height: 120px; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-30px) scale(0.9); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    .math-check { appearance: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; position: relative; transition: all 0.2s; }
    .math-check:checked { background: var(--primary); border-color: var(--primary); }
    .math-check:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; font-size: 10px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    .app-logo { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3)); }

    @keyframes lightningBar {
      0%   { transform: translateX(-120%); }
      100% { transform: translateX(420%); }
    }
    .animate-lightning-bar { animation: lightningBar 1s infinite linear; }

    .capture-mode .truncate { overflow: visible !important; text-overflow: clip !important; }
    .capture-mode .capture-row, .capture-mode .capture-row span { line-height: 1.6 !important; padding-bottom: 2px !important; }

    .calc-enter-active, .calc-leave-active { transition: opacity 0.25s ease, transform 0.25s ease; }
    .calc-enter-from, .calc-leave-to { opacity: 0; transform: scale(0.92) translateY(12px); }
    @keyframes addedGlow {
      0%   { transform: scale(0.995); box-shadow: 0 0 0 rgba(16,185,129,0); }
      40%  { transform: scale(1.01);  box-shadow: 0 0 24px rgba(16,185,129,0.22); }
      100% { transform: scale(1);     box-shadow: 0 0 0 rgba(16,185,129,0); }
    }
    .just-added { animation: addedGlow 0.9s ease; }

    .clear-btn{
      width: 26px;
      height: 26px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.55);
      transition: all .15s ease;
    }
    .clear-btn:hover{ background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.90); }
    .clear-btn i{ font-size: 11px; line-height: 1; }
    .amount-fit{ font-variant-numeric: tabular-nums; letter-spacing: 0.02em; line-height: 1; }

    /* tabs */
.day-tab {
  background: rgba(255,255,255,0.04);
  border: 1.5px solid rgba(255,255,255,0.08);
  transition: all .2s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
}
.day-tab:hover:not(.active) {
  background: rgba(255,255,255,0.08);
  border-color: rgba(255,255,255,0.15);
  transform: translateY(-1px);
}
.day-tab.active {
  border-color: rgba(16,185,129,0.7);
  background: linear-gradient(135deg, rgba(16,185,129,0.15) 0%, rgba(16,185,129,0.08) 100%);
  box-shadow: 0 0 0 2px rgba(16,185,129,0.12), 0 4px 12px rgba(16,185,129,0.15);
  transform: translateY(-2px);
}
.day-tab.active::before {
  content: '';
  position: absolute;
  bottom: -2px;
  left: 50%;
  transform: translateX(-50%);
  width: 60%;
  height: 3px;
  background: linear-gradient(90deg, transparent, rgba(16,185,129,0.8), transparent);
  border-radius: 2px 2px 0 0;
}

  </style>
</head>

<body>
<div id="app" v-cloak class="min-h-screen flex flex-col max-w-[500px] mx-auto relative pb-32">

  <!-- Loading -->
  <transition name="fade">
    <div v-if="isLoading" class="fixed inset-0 z-[200] bg-black flex items-center justify-center">
      <div class="flex flex-col items-center">
        <img src="favicon.svg" class="w-16 h-16 rounded-2xl mb-4 animate-pulse shadow-2xl">
        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">âš¡ï¸ Loading...</p>
      </div>
    </div>
  </transition>

  <!-- Toasts -->
  <div class="fixed top-8 left-0 right-0 z-[999] flex flex-col items-center pointer-events-none px-4">
    <transition-group name="toast">
      <div v-for="t in toasts" :key="t.id" class="glass px-6 py-3 rounded-full flex items-center gap-3 mb-2 shadow-2xl pointer-events-auto border-l-4"
           :class="t.type === 'error' ? 'border-red-500' : 'border-emerald-500'">
        <i :class="['fas', t.type === 'error' ? 'fa-times-circle text-red-400' : 'fa-check-circle text-emerald-400']"></i>
        <span class="text-xs font-bold">{{ t.msg }}</span>
      </div>
    </transition-group>
  </div>

  <!-- Header -->
  <header class="p-6 pb-6 rounded-b-[2.5rem] sticky top-0 z-40 transition-all duration-500 shadow-2xl backdrop-blur-xl border-b border-white/5"
          :class="isEditing ? 'bg-amber-950/80' : 'bg-[#0a2f23]/80'">

    <div class="flex justify-between items-start mb-4">
      <div class="flex items-center gap-3">
        <img src="favicon.svg" class="h-10 w-10 rounded-xl object-contain shadow-lg border border-white/10 app-logo">
        <div>
          <h1 class="text-xl font-black italic tracking-tighter text-white leading-none">MathGod</h1>
          <p class="text-[9px] font-bold text-emerald-400/80 tracking-[0.1em] uppercase">
            {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹æ¨¡å¼' : 'æœ‹å‹å¤¾éŒ¢è¨ˆç®—å™¨' }}
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button @click="showTutorial = true" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs hover:bg-white/20 transition-all">
          <i class="fas fa-question text-white/70"></i>
        </button>

        <div v-if="roomId" class="glass px-3 py-1.5 rounded-full flex items-center gap-3 border-emerald-500/30 bg-emerald-900/20">
          <div class="text-right">
            <p class="text-[8px] font-bold uppercase" :class="isOnline ? 'text-emerald-400' : 'text-gray-400'">
              {{ isOnline ? 'ONLINE' : 'OFFLINE' }}
            </p>
            <p class="text-xs font-num font-bold text-emerald-400 leading-none">#{{ roomId }}</p>
          </div>
          <button @click="copyRoomLink" class="w-6 h-6 rounded-full bg-white/10 text-white/70 flex items-center justify-center hover:bg-white/20 transition-all">
            <i class="fas fa-link text-[10px]"></i>
          </button>
          <button @click="logoutRoom" class="w-6 h-6 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
            <i class="fas fa-power-off text-[10px]"></i>
          </button>
        </div>

        <button
  v-else
  @click="handleSyncClick"
  class="glass px-4 py-2 rounded-full text-[10px] font-bold border-white/10 transition-all flex items-center gap-2 btn-press"
  :class="isOnline ? 'hover:border-emerald-500/50' : 'opacity-40 grayscale'">
  <i :class="['fas', isOnline ? 'fa-cloud' : 'fa-wifi', isOnline ? 'text-emerald-400' : 'text-gray-500']"></i>
  <span>{{ isOnline ? 'åŒæ­¥MODE' : 'é›¢ç·šä¸­' }}</span>
</button>

      </div>
    </div>

    <div class="flex gap-3 mb-3">
      <div class="flex-1 glass-input rounded-2xl flex items-center px-4 relative">
        <i class="fas fa-pen text-[10px] text-gray-500 mr-3"></i>
        <input v-model="eventName" @input="saveData" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/20" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: æ—¥æœ¬ä¹‹æ—…)">
      </div>

      <button @click="openDatePicker" class="w-12 glass-input rounded-2xl flex items-center justify-center hover:border-emerald-500/50 btn-press">
        <i class="fas fa-calendar-day text-emerald-400 pointer-events-none"></i>
      </button>
      <input
        type="date"
        id="dateInput"
        class="absolute -left-[9999px] opacity-0"
        @change="appendDate"
      />
    </div>

    <!-- âœ… Multi-day toggle -->
    <div class="flex items-center justify-between px-2">
      <div class="flex items-center gap-2">
        <i class="fas fa-layer-group text-[11px]" :class="multiDayMode ? 'text-emerald-400' : 'text-gray-500'"></i>
        <span class="text-[10px] font-bold" :class="multiDayMode ? 'text-emerald-300' : 'text-gray-400'">å¤šå¤©æ¨¡å¼</span>
        <span class="text-[9px] font-bold text-gray-500" v-if="multiDayMode">ï¼ˆDay åˆ†é ï¼‰</span>
      </div>

      <label class="relative inline-flex items-center cursor-pointer select-none">
        <input type="checkbox" v-model="multiDayMode" @change="onToggleMultiDay" class="sr-only peer">
        <div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
      </label>
    </div>

    <!-- Syncing bar -->
    <div v-if="isSyncing" class="mt-3">
      <div class="h-1 w-full overflow-hidden rounded-full bg-white/10">
        <div class="h-full w-1/3 bg-emerald-400 animate-lightning-bar"></div>
      </div>
      <div class="mt-1 text-[9px] font-bold text-gray-400 tracking-widest uppercase">âš¡ï¸ Loading...</div>
    </div>
  </header>

  <!-- Main -->
  <main class="p-5 space-y-6 flex-1">
      <!-- STEP 1 -->
    <section class="glass p-5 rounded-[2rem]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">STEP 1: æœ‹å‹</h3>
        <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full text-gray-400 font-num">{{ users.length }} äºº</span>
      </div>

      <div class="flex gap-2 mb-4">
        <div class="flex-1 glass-input rounded-xl flex items-center px-4 transition-all"
             :class="{'border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]': users.length === 0}">
          <i class="fas fa-user-plus text-xs text-gray-500 mr-2"></i>
          <input v-model="newUser" @keyup.enter="addUser" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="è¼¸å…¥åå­—...">
        </div>
        <button @click="addUser" class="bg-emerald-600 px-5 rounded-xl font-black text-xs btn-press shadow-lg shadow-emerald-900/50">åŠ å…¥</button>
      </div>

      <div class="flex flex-wrap gap-2">
        <transition-group name="toast">
          <div v-for="(u, i) in users" :key="u" class="bg-white/5 border border-white/10 px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 group">
            {{ u }}
            <button @click="removeUser(i)" class="text-gray-600 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
          </div>
        </transition-group>
        <div v-if="users.length === 0" class="w-full text-center py-2 text-[10px] text-emerald-400/70 animate-pulse">
          <i class="fas fa-arrow-up mr-1"></i> è«‹å…ˆåŠ å…¥åƒèˆ‡æ´»å‹•çš„æœ‹å‹
        </div>
      </div>
    </section>

    <!-- âœ… Multi-day tabs (only when enabled) -->
<section v-if="multiDayMode" class="glass p-5 rounded-[2rem]">
  <div class="flex justify-between items-center mb-4">
    <div>
      <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">DAY åˆ†é ç®¡ç†</h3>
      <p class="text-[9px] text-gray-500 font-bold">å…± {{ days.length }} æ—¥ Â· æ»‘å‹•æŸ¥çœ‹æ›´å¤š</p>
    </div>
    <button @click="addDay" class="bg-emerald-600 px-4 py-2.5 rounded-xl font-black text-[10px] btn-press shadow-lg shadow-emerald-900/40 hover:bg-emerald-500 transition-all">
      <i class="fas fa-plus mr-1.5"></i>æ–°å¢
    </button>
  </div>

  <!-- Tabs with gradient indicators -->
  <div class="relative">
    <!-- Left gradient fade -->
    <div class="absolute left-0 top-0 bottom-0 w-8 bg-gradient-to-r from-[rgba(30,30,30,0.65)] to-transparent pointer-events-none z-10 rounded-l-xl"></div>
    
    <!-- Right gradient fade -->
    <div class="absolute right-0 top-0 bottom-0 w-8 bg-gradient-to-l from-[rgba(30,30,30,0.65)] to-transparent pointer-events-none z-10 rounded-r-xl"></div>
    
    <!-- Scrollable tabs -->
    <div class="flex gap-2 overflow-x-auto custom-scroll pb-2 pt-1 px-1 -mx-1 scroll-smooth">
      <button
        v-for="(d, idx) in days"
        :key="d.id"
        @click="setActiveDay(d.id)"
        class="day-tab px-4 py-3 rounded-xl text-[11px] font-black whitespace-nowrap flex items-center gap-2 shrink-0 transition-all duration-200"
        :class="activeDayId===d.id ? 'active' : ''"
      >
        <div class="flex items-center gap-2">
          <div class="w-7 h-7 rounded-lg flex items-center justify-center transition-all"
               :class="activeDayId===d.id ? 'bg-emerald-500/20' : 'bg-white/5'">
            <span class="font-num font-black text-[10px]" 
                  :class="activeDayId===d.id ? 'text-emerald-400' : 'text-gray-500'">
              {{ idx + 1 }}
            </span>
          </div>
          <span class="truncate max-w-[120px]" :class="activeDayId===d.id ? 'text-white' : 'text-gray-400'">
            {{ d.name }}
          </span>
        </div>
        <div v-if="(d.expenses || []).length > 0" 
             class="ml-1 px-1.5 py-0.5 rounded-full text-[8px] font-black"
             :class="activeDayId===d.id ? 'bg-emerald-500/20 text-emerald-300' : 'bg-white/10 text-gray-500'">
          {{ (d.expenses || []).length }}
        </div>
      </button>
    </div>
  </div>


      <div class="mt-4 bg-gradient-to-br from-black/30 to-black/10 p-4 rounded-2xl border border-white/10 backdrop-blur-sm">
  <div class="flex items-start justify-between gap-3">
    <div class="flex-1 min-w-0">
      <div class="flex items-center gap-2 mb-2">
        <i class="fas fa-edit text-emerald-400 text-[10px]"></i>
        <div class="text-[9px] text-gray-400 font-bold uppercase tracking-wider">ç·¨è¼¯ç•¶æ—¥åç¨±</div>
      </div>
      <div class="relative">
        <input
          v-model="activeDayNameProxy"
          class="w-full bg-black/30 border border-white/10 rounded-xl px-3 py-2.5 outline-none text-sm font-bold text-white placeholder-white/20 focus:border-emerald-500/50 focus:bg-black/50 transition-all"
          placeholder="ä¾‹å¦‚ï¼šæ±äº¬ Day1 / å¤§é˜ªè³¼ç‰©æ—¥"
        />
        <div class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-gray-600 font-num pointer-events-none">
          {{ activeDayNameProxy.length }}/20
        </div>
      </div>
    </div>
    <button
      class="w-11 h-11 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 hover:bg-red-500 hover:border-red-500 hover:text-white transition-all flex items-center justify-center shrink-0 mt-6"
      @click="removeActiveDay"
      title="åˆªé™¤ç•¶æ—¥"
      aria-label="åˆªé™¤ç•¶æ—¥"
    >
      <i class="fas fa-trash text-sm"></i>
    </button>
  </div>
</div>
<div class="mt-4 grid grid-cols-2 gap-3">
  <div class="bg-gradient-to-br from-blue-500/10 to-blue-600/5 border border-blue-500/20 p-3 rounded-xl">
    <div class="flex items-center gap-1.5 mb-1">
      <i class="fas fa-calendar-day text-blue-400 text-[9px]"></i>
      <div class="text-[9px] font-bold text-blue-300 uppercase tracking-wide">ç•¶æ—¥æ”¯å‡º</div>
    </div>
    <div class="text-xl font-black font-num text-white">
      ${{ totalSpentDay.toFixed(1) }}
    </div>
  </div>
  
  <div class="bg-gradient-to-br from-emerald-500/10 to-emerald-600/5 border border-emerald-500/20 p-3 rounded-xl">
    <div class="flex items-center gap-1.5 mb-1">
      <i class="fas fa-layer-group text-emerald-400 text-[9px]"></i>
      <div class="text-[9px] font-bold text-emerald-300 uppercase tracking-wide">å…¨éƒ¨æ”¯å‡º</div>
    </div>
    <div class="text-xl font-black font-num text-emerald-400">
      ${{ totalSpentAll.toFixed(1) }}
    </div>
  </div>
</div>

    </section>

  

    <!-- STEP 2 -->
    <section class="glass p-6 rounded-[2rem] transition-all duration-300 relative overflow-visible"
             :class="{'opacity-50 pointer-events-none grayscale': users.length === 0, 'border-amber-500/50': isEditing}">

      <div v-if="users.length === 0" class="absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
        <div class="bg-black/80 px-4 py-2 rounded-full text-xs font-bold text-white"><i class="fas fa-lock mr-2"></i>åŠ å…¥æœ‹å‹å¾Œè§£é–</div>
      </div>

      <div class="flex justify-between items-center mb-5">
        <h3 class="text-[10px] font-bold uppercase tracking-widest flex items-center gap-2" :class="isEditing ? 'text-amber-500' : 'text-emerald-500'">
          {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹' : 'STEP 2: æ–°å¢æ¶ˆè²»' }}
          <span v-if="multiDayMode && activeDay" class="text-[9px] bg-white/10 px-2 py-0.5 rounded-full text-gray-300 font-black">
            {{ activeDay.name }}
          </span>
        </h3>
        <button v-if="isEditing" @click="cancelEdit" class="text-[10px] text-gray-400 underline hover:text-white">å–æ¶ˆä¿®æ”¹</button>
      </div>

      <div class="space-y-4">
        <div class="glass-input rounded-2xl flex items-center px-4 relative" :class="{'input-error': errors.item}">
          <input v-model="form.item" @input="errors.item = false" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤)">
          <button
            v-if="form.item"
            type="button"
            @click.stop.prevent="form.item=''"
            class="absolute right-3 top-1/2 -translate-y-1/2 clear-btn"
            aria-label="æ¸…é™¤æ¶ˆè²»é …ç›®"
            title="æ¸…é™¤"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- currency + amount + calc icon -->
        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-3 sm:col-span-4 glass-input rounded-2xl relative">
            <select v-model="form.currency" @change="handleCurrencyChange" class="w-full h-full bg-transparent px-2 text-[11px] font-black outline-none appearance-none text-center z-10 relative">
              <option value="HKD">HKD ğŸ‡­ğŸ‡°</option>
              <option value="CNY">CNY ğŸ‡¨ğŸ‡³</option>
              <option value="JPY">JPY ğŸ‡¯ğŸ‡µ</option>
              <option value="TWD">TWD ğŸ‡¹ğŸ‡¼</option>
              <option value="THB">THB ğŸ‡¹ğŸ‡­</option>
              <option value="KRW">KRW ğŸ‡°ğŸ‡·</option>
              <option value="USD">USD ğŸ‡ºğŸ‡¸</option>
              <option value="EUR">EUR ğŸ‡ªğŸ‡º</option>
              <option value="GBP">GBP ğŸ‡¬ğŸ‡§</option>
            </select>
            <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[8px] text-gray-500"></i>
          </div>

          <div class="col-span-9 sm:col-span-8 glass-input rounded-2xl flex flex-col justify-center pl-4 pr-1 py-2" :class="{'input-error': errors.amount}">
            <div class="relative flex items-center w-full">
              <span class="text-xs font-black text-gray-500 w-5 shrink-0 text-center">$</span>

              <div class="flex-1 min-w-0">
                <input
                  v-model="form.amount"
                  type="text"
                  inputmode="decimal"
                  pattern="[0-9.]*"
                  @input="sanitizeAmount(); errors.amount = false"
                  :class="[
                    'w-full bg-transparent text-center font-num font-black outline-none placeholder-white/10 amount-fit',
                    amountFontClass
                  ]"
                  placeholder="0.0"
                />
              </div>

              <div class="flex items-center justify-end gap-2 w-[80px] shrink-0 pl-2">
                <button
                  v-if="form.amount"
                  type="button"
                  class="clear-btn"
                  @click.stop.prevent="form.amount=''"
                  aria-label="æ¸…é™¤é‡‘é¡"
                  title="æ¸…é™¤"
                >
                  <i class="fas fa-times"></i>
                </button>

                <span class="h-6 w-px bg-white/10"></span>

                <button
                  type="button"
                  @click.stop.prevent="openKeypad()"
                  class="w-9 h-9 flex items-center justify-center rounded-full hover:bg-emerald-500/10 active:bg-emerald-500/20"
                  title="é–‹å•Ÿè¨ˆæ•¸æ©Ÿ"
                  aria-label="é–‹å•Ÿè¨ˆæ•¸æ©Ÿ"
                >
                  <i class="fas fa-calculator text-[13px] text-emerald-400"></i>
                </button>
              </div>
            </div>

            <div v-if="form.currency !== 'HKD'" class="text-right border-t border-white/5 mt-1 pt-1 space-y-1">
              <div>
                <span class="text-[9px] font-bold text-emerald-400 font-num">
                  Rate: {{ currentRate.toFixed(3) }} â‰ˆ HKD ${{ ((Number(form.amount || 0)) * currentRate).toFixed(1) }}
                </span>
              </div>
              <div v-if="rateUpdatedAt" class="text-[9px] font-bold text-gray-500 font-num">
                æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ formatTs(rateUpdatedAt) }}
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-[9px] font-bold text-gray-500 ml-1">èª°ä»˜éŒ¢</p>
            <div class="glass-input rounded-xl relative" :class="{'input-error': errors.payer}">
              <select v-model="form.payer" @change="errors.payer = false" class="w-full bg-transparent p-3 text-xs font-bold outline-none appearance-none">
                <option value="" disabled>è«‹é¸æ“‡...</option>
                <option v-for="u in users" :value="u">{{ u }}</option>
              </select>
              <i class="fas fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            </div>
          </div>

          <div class="space-y-1">
            <div class="flex justify-between px-1">
              <p class="text-[9px] font-bold text-gray-500" :class="{'text-red-400': errors.involved}">èª°æœ‰ä»½ ({{ form.involved.length }})</p>
              <button @click="toggleSelectAll" class="text-[9px] text-emerald-500 font-bold hover:text-white transition-colors">å…¨é¸/å–æ¶ˆ</button>
            </div>
            <div class="glass-input rounded-xl p-2 max-h-28 overflow-y-auto custom-scroll space-y-1" :class="{'input-error': errors.involved}">
              <div v-for="u in users" :key="u" @click="toggleInvolved(u)" class="flex items-center gap-2 p-1.5 rounded-lg cursor-pointer hover:bg-white/5">
                <input type="checkbox" :checked="form.involved.includes(u)" class="math-check pointer-events-none">
                <span class="text-[10px] font-bold" :class="form.involved.includes(u) ? 'text-white' : 'text-gray-500'">{{ u }}</span>
              </div>
            </div>
          </div>
        </div>

        <button @click="addExpense" class="w-full py-4 rounded-2xl font-black text-sm shadow-xl btn-press flex items-center justify-center gap-2 transition-all"
                :class="isEditing ? 'bg-amber-600 shadow-amber-900/40' : 'bg-emerald-600 shadow-emerald-900/40'">
          <i :class="['fas', isEditing ? 'fa-save' : 'fa-plus']"></i>
          <span>{{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªå…¥æ•¸' }}</span>
          <span v-if="form.amount" class="font-num bg-black/20 px-2 rounded ml-1 text-xs">
            HKD ${{ ((Number(form.amount || 0) * currentRate) || 0).toFixed(1) }}
          </span>
        </button>
      </div>
    </section>

    <!-- Recent -->
    <section class="pb-10">
      <h3 class="text-[10px] font-bold text-gray-500 ml-2 mb-3 uppercase tracking-widest">
        æœ€è¿‘ç´€éŒ„
        <span v-if="multiDayMode && activeDay" class="ml-2 text-[9px] bg-white/10 px-2 py-0.5 rounded-full text-gray-300 font-black">
          {{ activeDay.name }}
        </span>
      </h3>

      <div v-if="currentExpenses.length === 0" class="text-center py-6 opacity-30">
        <i class="fas fa-clipboard-list text-3xl mb-2"></i>
        <p class="text-xs">æš«ç„¡æ¶ˆè²»</p>
      </div>

      <div class="space-y-3">
        <div v-for="(exp, idx) in currentExpenses" :key="exp.id" @click="editExpense(idx)"
          class="glass p-4 rounded-2xl flex justify-between items-center border-l-[3px] transition-all active:scale-[0.99]"
          :class="exp.id === lastAddedId ? 'just-added' : ''"
          :style="{ borderColor: isEditing && editingId === exp.id ? '#f59e0b' : '#10b981' }">

          <div class="flex-1 overflow-hidden pr-3">
            <div class="flex items-center gap-2 mb-1">
              <p class="font-bold text-sm truncate text-gray-100">{{ exp.item }}</p>
              <span v-if="exp.origCurrency !== 'HKD'" class="text-[8px] bg-white/10 px-1.5 rounded text-gray-400 font-num">{{ exp.origCurrency }}</span>
            </div>
            <p class="text-[10px] text-gray-400 font-bold flex items-center gap-1">
              <span class="text-emerald-400 font-num">HKD ${{ (exp.hkd || 0).toFixed(1) }}</span>
              <span class="text-gray-600">|</span>
              <span>{{ exp.payer }} ä»˜</span>
            </p>
          </div>

          <button @click.stop="removeExpense(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-600 hover:bg-red-500/20 hover:text-red-400 transition-colors">
            <i class="fas fa-trash-alt text-xs"></i>
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Floating Draggable Calculator (Top Layer) ===== -->
  <transition name="calc">
    <div v-if="showKeypad" class="fixed inset-0 z-[999]">
      <div class="absolute inset-0 bg-black/40" @pointerdown.prevent="closeKeypad()"></div>

      <div
        class="absolute glass rounded-2xl w-[320px] max-w-[92vw] p-4 shadow-2xl"
        :style="{ left: calcPos.x + 'px', top: calcPos.y + 'px' }"
        @click.stop
        @touchmove.prevent
      >
        <div class="flex items-center justify-between mb-3 cursor-move select-none" @pointerdown.prevent="startDrag">
          <div class="text-xs font-black text-gray-200">è¼¸å…¥é‡‘é¡ï¼ˆå¯è¨ˆæ•¸ï¼‰</div>
          <button
            type="button"
            class="w-9 h-9 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all"
            @pointerdown.prevent.stop="closeKeypad()"
            aria-label="é—œé–‰"
            title="é—œé–‰"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="glass-input rounded-2xl px-3 py-3 mb-3">
          <div class="text-[10px] font-bold text-gray-500 mb-1">Expression</div>
          <div class="font-num font-black text-2xl text-right break-all text-white">
            {{ keypadExpr || '0' }}
          </div>

          <div class="mt-2 flex items-center justify-between">
            <div class="text-[10px] font-bold text-gray-500">Result</div>
            <div class="font-num font-black text-lg text-right text-gray-300">
              {{ amountPreviewText }}
            </div>
          </div>

          <div v-if="keypadHint" class="text-[10px] font-bold text-red-400 mt-1 text-right">
            {{ keypadHint }}
          </div>
        </div>

        <div class="grid grid-cols-4 gap-2 text-sm font-black select-none">
          <button class="bg-white/10 rounded-xl py-3 btn-press" @click="kp('C')">C</button>

          <button
            class="bg-white/10 rounded-xl py-3 btn-press"
            @mousedown.prevent="startBackspaceHold()"
            @mouseup.prevent="stopBackspaceHold()"
            @mouseleave.prevent="stopBackspaceHold()"
            @touchstart.prevent="startBackspaceHold()"
            @touchend.prevent="stopBackspaceHold()"
            @touchcancel.prevent="stopBackspaceHold()"
          >âŒ«</button>

          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('/')">Ã·</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('*')">Ã—</button>

          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('7')">7</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('8')">8</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('9')">9</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('-')">âˆ’</button>

          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('4')">4</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('5')">5</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('6')">6</button>
          <button class="bg-emerald-700/40 rounded-xl py-3 btn-press" @click="kp('+')">ï¼‹</button>

          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('1')">1</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('2')">2</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('3')">3</button>

          <button class="bg-emerald-600 rounded-xl py-3 btn-press row-span-2" @click="kp('=')">
            =<div class="text-[9px] font-bold opacity-80 mt-1">OK</div>
          </button>

          <button class="bg-white/5 rounded-xl py-3 btn-press col-span-2" @click="kp('0')">0</button>
          <button class="bg-white/5 rounded-xl py-3 btn-press" @click="kp('.')">.</button>
        </div>
      </div>
    </div>
  </transition>

  <div class="fixed bottom-0 left-0 right-0 footer-gradient z-40 pointer-events-none"></div>
  <div v-if="showResetMenu" @click="showResetMenu = false" class="fixed inset-0 z-40 bg-transparent"></div>

  <!-- Footer -->
  <footer class="fixed bottom-6 left-0 right-0 max-w-[500px] mx-auto px-6 z-50 grid grid-cols-2 gap-4 pointer-events-none">
    <button @click="showShareModal = true" :disabled="allExpenses.length === 0"
            class="pointer-events-auto bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-xs shadow-2xl shadow-emerald-900/40 btn-press disabled:opacity-50 disabled:grayscale transition-all flex items-center justify-center gap-2 border border-emerald-400/20 backdrop-blur-md text-white">
      <i class="fas fa-receipt"></i> çµç®—åˆ†äº«
    </button>

    <div class="relative pointer-events-auto group">
      <button @click="showResetMenu = !showResetMenu" class="w-full bg-[#151515]/90 border border-white/10 py-4 rounded-2xl font-black text-xs text-gray-400 backdrop-blur-md btn-press hover:bg-white/5 transition-all flex items-center justify-center gap-2 shadow-xl">
        <i class="fas fa-cog"></i> é‡è¨­
      </button>
      <div v-if="showResetMenu" class="absolute bottom-full mb-3 left-0 right-0 bg-[#1a1a1a] rounded-2xl border border-white/10 overflow-hidden shadow-2xl z-50">
        <button @click="resetData('expenses')" class="w-full p-4 text-xs font-bold text-left text-red-300 border-b border-white/5 hover:bg-white/5">
          <i class="fas fa-eraser mr-2"></i>åªæ¸…ç©ºæ¶ˆè²»ç´€éŒ„
        </button>
        <button @click="resetData('all')" class="w-full p-4 text-xs font-bold text-left text-red-500 hover:bg-white/5">
          <i class="fas fa-bomb mr-2"></i>æ¸…é™¤æ‰€æœ‰ç´€éŒ„ (åŒ…æ‹¬æœ‹å‹)
        </button>
      </div>
    </div>
  </footer>

  <!-- Sync Modal -->
<div v-if="showSyncModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6" @click.self="showSyncModal = false">
  <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] relative overflow-hidden">

      <div class="absolute top-0 left-0 right-0 h-32 bg-gradient-to-b from-emerald-900/20 to-transparent pointer-events-none"></div>

      <div class="relative z-10 text-center mb-8">
        <img src="favicon.svg" class="w-20 h-20 mx-auto mb-4 rounded-2xl shadow-[0_0_20px_rgba(16,185,129,0.3)] border border-white/10 object-contain bg-black/20">
        <h3 class="text-xl font-black">ç™»å…¥åŒæ­¥æˆ¿é–“</h3>
      </div>

      <div class="mb-6 relative group">
        <input v-model="roomInput" type="number" class="w-full text-center text-4xl font-num font-bold py-4 bg-black/40 rounded-2xl outline-none border border-white/10 focus:border-emerald-500/50 transition-all text-emerald-400 placeholder-white/5 tracking-widest" placeholder="0000">
        <p class="text-[9px] text-gray-600 text-center mt-2 font-bold uppercase">è¼¸å…¥ 4 ä½æ•¸æˆ¿è™Ÿ</p>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-8">
        <button @click="joinRoom(roomInput)" class="bg-emerald-600 py-3.5 rounded-xl font-black text-xs btn-press">é€²å…¥æˆ¿é–“</button>
        <button @click="createRoom" class="bg-white/5 border border-white/10 py-3.5 rounded-xl font-black text-xs btn-press hover:bg-white/10">æ–°é–‹æˆ¿é–“</button>
      </div>

      <div v-if="recentRoomsWithNames.length > 0" class="border-t border-white/5 pt-5">
        <p class="text-[9px] text-gray-500 font-bold uppercase mb-3 px-1">æœ€è¿‘ç€è¦½</p>
        <div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-1">
          <div v-for="r in recentRoomsWithNames" :key="r.id" class="flex items-center gap-2 group">
            <button @click="joinRoom(r.id)" class="flex-1 bg-white/5 p-3 rounded-xl flex items-center border border-transparent hover:border-emerald-500/30 transition-all text-left">
              <span class="font-num text-emerald-500 font-bold mr-3 text-xs">#{{ r.id }}</span>
              <span class="text-[10px] font-bold text-gray-300 truncate flex-1">{{ r.name }}</span>
            </button>
            <button @click="removeHistoryRoom(r.id)" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-600 hover:text-red-400 hover:bg-red-500/10 transition-colors">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
      </div>

      <button @click="showSyncModal = false" class="absolute top-6 right-6 text-gray-500 hover:text-white">
        <i class="fas fa-times text-lg"></i>
      </button>
    </div>
  </div>

  <!-- Share Modal -->
  <div v-if="showShareModal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex flex-col p-4 overflow-y-auto" @click.self="showShareModal = false">
    <div class="max-w-md mx-auto w-full my-auto">

      <!-- capture -->
      <div id="capture-zone" class="bg-[#e8e8e8] text-black p-6 rounded-lg shadow-2xl mb-6 relative font-mono">
        <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-b from-gray-300 to-transparent opacity-20"></div>

        <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4">
          <h2 class="font-black text-2xl tracking-tighter uppercase mb-1">éæ•¸é€šçŸ¥å–®</h2>
          <p v-if="eventName" class="text-sm font-bold text-gray-600">{{ eventName }}</p>
          <p v-if="multiDayMode" class="text-[10px] font-bold text-gray-500 mt-1">
            {{ shareOptions.scope === 'all' ? 'ç¶œåˆå…¨éƒ¨æ—¥å­' : ('åªè¨ˆï¼š' + (activeDay?.name || 'ç•¶æ—¥')) }}
          </p>
        </div>

        <div class="flex justify-between items-end mb-4 px-2">
          <span class="text-xs font-bold text-gray-600">ç¸½æ”¯å‡º (Total)</span>
          <span class="font-black text-2xl tracking-tight">${{ totalSpentForShare.toFixed(1) }}</span>
        </div>

        <div class="bg-white p-3 rounded border border-gray-300 mb-4">
          <p class="text-[10px] font-bold text-gray-500 mb-2 border-b border-gray-200 pb-1">éæ•¸æŒ‡å— (Payment Guide)</p>
          <div v-if="settlementsForShare.length === 0" class="text-center text-gray-400 text-xs py-2">æ²’æœ‰äººéœ€è¦å¤¾éŒ¢</div>
          <div v-for="s in settlementsForShare" class="flex justify-between items-center py-1 text-sm font-bold">
            <div class="flex items-center gap-2">
              <span class="text-red-600">{{ s.from }}</span>
              <i class="fas fa-arrow-right-long text-gray-400 mx-2"></i>
              <span class="text-emerald-600">{{ s.to }}</span>
            </div>
            <span>${{ s.amount.toFixed(1) }}</span>
          </div>
        </div>

        <div v-if="shareOptions.showList" class="mt-4 pt-2 border-t-2 border-dashed border-gray-400">
          <p class="text-[10px] font-bold text-gray-500 mb-2 text-center uppercase">-- æ¶ˆè²»ç´€éŒ„ (Details) --</p>

          <!-- when scope=all, show day grouping -->
          <template v-if="multiDayMode && shareOptions.scope==='all'">
            <div v-for="d in days" :key="d.id" class="mb-3">
              <div class="text-[10px] font-black text-gray-600 mb-1 flex items-center justify-between">
                <span>{{ d.name }}</span>
                <span class="font-num text-gray-500">${{ (d.expenses || []).reduce((s,e)=>s+Number(e?.hkd||0),0).toFixed(1) }}</span>
              </div>
              <div v-if="(d.expenses || []).length === 0" class="text-[10px] text-gray-400 py-1">ï¼ˆæ­¤æ—¥ç„¡ç´€éŒ„ï¼‰</div>
              <div v-for="e in (d.expenses || [])" class="capture-row flex justify-between text-[10px] leading-[1.4] py-1.5 border-b border-gray-300 last:border-0">
                <span class="truncate pr-2 font-medium">{{ e.item }} <span class="text-gray-400">({{ e.payer }})</span></span>
                <span class="whitespace-nowrap font-bold">${{ Number(e.hkd || 0).toFixed(1) }}</span>
              </div>
            </div>
          </template>

          <!-- else normal list -->
          <template v-else>
            <div v-for="e in expensesForShare" class="capture-row flex justify-between text-[10px] leading-[1.4] py-1.5 border-b border-gray-300 last:border-0">
              <span class="truncate pr-2 font-medium">{{ e.item }} <span class="text-gray-400">({{ e.payer }})</span></span>
              <span class="whitespace-nowrap font-bold">${{ Number(e.hkd || 0).toFixed(1) }}</span>
            </div>
          </template>
        </div>

        <div class="mt-6 text-center">
          <p class="text-[10px] font-bold text-gray-500">Generated by âš¡ï¸MathGod</p>
          <div class="h-2 opacity-0">.</div>
        </div>
      </div>

      <div class="glass p-6 rounded-[2rem] space-y-4">

        <!-- âœ… share scope -->
        <div v-if="multiDayMode" class="flex justify-between items-center bg-black/20 p-3 rounded-xl border border-white/5">
          <span class="text-xs font-bold text-gray-300">çµç®—ç¯„åœ</span>
          <div class="flex gap-2">
            <button
              class="px-3 py-2 rounded-xl text-[10px] font-black btn-press border border-white/10"
              :class="shareOptions.scope==='all' ? 'bg-emerald-600 text-white' : 'bg-white/10 text-gray-300'"
              @click="shareOptions.scope='all';"
            >
              ç¶œåˆå…¨éƒ¨
            </button>
            <button
              class="px-3 py-2 rounded-xl text-[10px] font-black btn-press border border-white/10"
              :class="shareOptions.scope==='day' ? 'bg-emerald-600 text-white' : 'bg-white/10 text-gray-300'"
              @click="shareOptions.scope='day';"
            >
              åªè¨ˆç•¶æ—¥
            </button>
          </div>
        </div>

        <div class="flex justify-between items-center bg-black/20 p-3 rounded-xl border border-white/5">
          <span class="text-xs font-bold text-gray-300">åˆ—å‡ºæ¶ˆè²»ç´€éŒ„</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" v-model="shareOptions.showList" class="sr-only peer">
            <div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
          </label>
        </div>

        <div v-if="shareSubMenu === 'none'" class="grid grid-cols-2 gap-3">
          <button @click="shareSubMenu = 'text'" class="bg-gray-700 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-file-alt text-lg"></i> åˆ†äº«æ–‡å­—
          </button>
          <button @click="shareSubMenu = 'image'" class="bg-emerald-600 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-image text-lg"></i> åˆ†äº«åœ–ç‰‡
          </button>
        </div>

        <div v-if="shareSubMenu === 'text'" class="space-y-3">
          <button @click="copyText" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-copy mr-2"></i> è¤‡è£½æ–‡å­—
          </button>
          <button @click="shareViaApp('text')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>

        <div v-if="shareSubMenu === 'image'" class="space-y-3">
          <button @click="generateImage" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-download mr-2"></i> ä¸‹è¼‰åœ–ç‰‡
          </button>
          <button @click="shareViaApp('image')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share-nodes mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>
      </div>

      <button @click="showShareModal = false; shareSubMenu = 'none'"
              class="w-full bg-white/10 py-3 rounded-xl text-xs font-black mt-4 border border-white/10 hover:bg-white/15 btn-press">
        é—œé–‰
      </button>
    </div>
  </div>

  <!-- Tutorial -->
  <div v-if="showTutorial" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-md flex items-center justify-center p-6" @click.self="showTutorial = false">
    <div class="glass max-w-sm w-full p-6 rounded-[2rem] text-center">
      <h3 class="text-lg font-black text-emerald-400 mb-4">ä½¿ç”¨æ•™å­¸</h3>
      <ul class="text-left text-xs space-y-3 text-gray-300 mb-6 font-bold">
        <li>1. å…ˆåœ¨ <span class="text-white border border-white/20 px-1 rounded">æœ‹å‹</span> å€è¼¸å…¥åå­—ä¸¦åŠ å…¥ã€‚</li>
        <li>2. åœ¨ <span class="text-white border border-white/20 px-1 rounded">æ–°å¢æ¶ˆè²»</span> å¡«å¯«é‡‘é¡ï¼Œé¸æ“‡èª°ä»˜éŒ¢ã€‚</li>
        <li>3. ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—èª°éœ€è¦çµ¦èª°éŒ¢ã€‚</li>
        <li>4. æŒ‰ä¸‹ <span class="text-emerald-400 border border-emerald-400/30 px-1 rounded">çµç®—åˆ†äº«</span> å³å¯ç”¢ç”Ÿå ±è¡¨ã€‚</li>
        <li>5. é»æ“Š <span class="text-emerald-400 border border-emerald-400/30 px-1 rounded">åŒæ­¥MODE</span> å¯èˆ‡æœ‹å‹å³æ™‚é€£ç·šã€‚</li>
        <li>6. å‹¾é¸ <span class="text-emerald-400 border border-emerald-400/30 px-1 rounded">å¤šå¤©æ¨¡å¼</span> å¯é–‹ Day åˆ†é ï¼Œæœ€å¾Œå¯ç¶œåˆå…¨éƒ¨æ—¥å­çµç®—ã€‚</li>
      </ul>
      <button @click="showTutorial = false" class="bg-white/10 w-full py-3 rounded-xl text-xs font-black">æ˜ç™½</button>
    </div>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "yFDRUSUFAFnZf6AGdsEA9LxSyLcZF75oIFfib5At",
    databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "mathgod2"
  };

  try { firebase.initializeApp(firebaseConfig); } catch(e) {}
  const db = firebase.database();

  const { createApp, ref, computed, onMounted, onUnmounted } = Vue;

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: '/mathgod/' })
        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW failed', err));
    });
  }

  createApp({
    setup() {
      const isLoading = ref(false);
      const isSyncing = ref(false);
      const eventName = ref("");
      const users = ref([]);

      // âœ… multi-day state
      const multiDayMode = ref(false);
      const days = ref([]); // [{id, name, expenses: []}]
      const activeDayId = ref(null);

      const lastAddedId = ref(null);
      const newUser = ref("");
      const isEditing = ref(false);
      const editingId = ref(null);

      const showSyncModal = ref(false);
      const showShareModal = ref(false);
      const showResetMenu = ref(false);
      const showTutorial = ref(false);
      const shareSubMenu = ref('none');

      const toasts = ref([]);
      const roomId = ref(null);
      const isOnline = ref(navigator.onLine);
      const roomInput = ref("");
      const recentRooms = ref([]);
      const roomNamesMap = ref({});

      const form = ref({ item: "", amount: "", currency: "HKD", payer: "", involved: [] });

      const sanitizeAmount = () => {
        let s = String(form.value.amount ?? "");
        s = s.replace(/[^\d.]/g, "");
        const dot = s.indexOf(".");
        if (dot !== -1) {
          s = s.slice(0, dot + 1) + s.slice(dot + 1).replace(/\./g, "");
        }
        if (s.length > 1 && s[0] === "0" && s[1] !== ".") {
          s = s.replace(/^0+/, "");
          if (s === "") s = "0";
        }
        form.value.amount = s;
      };

      const errors = ref({ item: false, amount: false, payer: false, involved: false });
      const shareOptions = ref({ showList: true, scope: "all" }); // scope: 'all' | 'day'

      const toast = (msg, type='success') => {
        const id = Date.now();
        toasts.value.push({id, msg, type});
        setTimeout(() => toasts.value = toasts.value.filter(t=>t.id!==id), 3000);
      };
const handleSyncClick = () => {
  console.log('Sync button clicked, isOnline:', isOnline.value);
  if (!isOnline.value) {
    toast('ç›®å‰é›¢ç·šï¼Œæœªèƒ½åŒæ­¥', 'error');
    return;
  }
  console.log('Opening sync modal');
  showSyncModal.value = true;
};
      const pad2 = (n) => String(n).padStart(2, "0");
      const formatTs = (ts) => {
        const d = new Date(ts);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      };

      const amountFontClass = computed(() => {
        const s = String(form.value.amount ?? "").replace(/[^\d.]/g, "");
        const len = s.replace(".", "").length;
        if (len <= 5) return "text-2xl";
        if (len <= 6) return "text-xl";
        if (len <= 8) return "text-lg";
        if (len <= 10) return "text-base";
        return "text-sm";
      });

      const openDatePicker = () => {
        const el = document.getElementById('dateInput');
        if (!el) return;
        el.focus();
        setTimeout(() => {
          if (typeof el.showPicker === 'function') el.showPicker();
          else el.click();
        }, 0);
      };

      const appendDate = (e) => {
        if (e.target.value) {
          const dateStr = `(${e.target.value})`;
          const regex = /\(\d{4}-\d{2}-\d{2}\)$/;
          if (regex.test(eventName.value)) eventName.value = eventName.value.replace(regex, dateStr);
          else eventName.value = eventName.value ? `${eventName.value} ${dateStr}` : dateStr;
          saveData();
        }
      };

      // ========= MULTI-DAY HELPERS =========
      const ensureDefaultDay = () => {
        if (!Array.isArray(days.value) || days.value.length === 0) {
          const id = "day1";
          days.value = [{ id, name: "Day1", expenses: [] }];
          activeDayId.value = id;
        }
        if (!activeDayId.value) activeDayId.value = days.value[0]?.id || "day1";
      };

      const activeDay = computed(() => days.value.find(d => d.id === activeDayId.value) || null);

      const currentExpenses = computed(() => {
        ensureDefaultDay();
        const d = activeDay.value;
        return (d && Array.isArray(d.expenses)) ? d.expenses : [];
      });

      const allExpenses = computed(() => {
        ensureDefaultDay();
        return (days.value || []).flatMap(d => (d.expenses || []));
      });

      const activeDayName = computed({
        get() { return activeDay.value?.name || ""; },
        set(v) { /* handled by renameActiveDay */ }
      });

      const setActiveDay = (id) => {
        activeDayId.value = id;
        cancelEdit();
        saveData();
      };

      const addDay = () => {
        ensureDefaultDay();
        const n = (days.value.length || 0) + 1;
        const id = "day" + Date.now();
        days.value.push({ id, name: `Day${n}`, expenses: [] });
        activeDayId.value = id;
        cancelEdit();
        saveData();
        toast("å·²æ–°å¢ Day");
      };

      const renameActiveDay = () => {
  // This function is now handled by activeDayNameProxy computed setter
  // Keeping for backward compatibility but functionality moved to computed
};

// We'll update rename via watcher-like manual method:
const _activeDayNameTmp = ref("");

      // use this ref for v-model
      // (wired below in return, we bind to activeDayNameProxy)
      const activeDayNameProxy = computed({
        get() {
          _activeDayNameTmp.value = activeDay.value?.name || "";
          return _activeDayNameTmp.value;
        },
        set(v) {
          _activeDayNameTmp.value = v;
          const d = activeDay.value;
          if (!d) return;
          d.name = String(v || "").trim() || "æœªå‘½å";
          saveData();
        }
      });

      const removeActiveDay = () => {
        ensureDefaultDay();
        if (!activeDay.value) return;
        if (days.value.length <= 1) {
          toast("è‡³å°‘è¦ä¿ç•™ 1 æ—¥", "error");
          return;
        }
        if (!confirm(`ç¢ºå®šåˆªé™¤ã€Œ${activeDay.value.name}ã€ï¼Ÿï¼ˆè©²æ—¥æ‰€æœ‰æ¶ˆè²»æœƒæ¶ˆå¤±ï¼‰`)) return;

        const idx = days.value.findIndex(d => d.id === activeDayId.value);
        if (idx > -1) days.value.splice(idx, 1);

        activeDayId.value = days.value[Math.max(0, idx-1)]?.id || days.value[0]?.id || null;
        cancelEdit();
        saveData();
        toast("å·²åˆªé™¤ç•¶æ—¥");
      };

      const onToggleMultiDay = () => {
        ensureDefaultDay();
        if (!multiDayMode.value) {
          // turning OFF: keep days data, just hide UI
          // for share scope, default all (still valid)
          toast("å·²é—œé–‰å¤šå¤©æ¨¡å¼");
        } else {
          toast("å·²é–‹å•Ÿå¤šå¤©æ¨¡å¼");
        }
        saveData();
      };

      // ========= save / load (local + room) =========
      const saveData = () => {
        ensureDefaultDay();
        const data = {
          users: [...users.value],
          eventName: eventName.value,
          multiDayMode: !!multiDayMode.value,
          days: JSON.parse(JSON.stringify(days.value || [])),
          activeDayId: activeDayId.value
        };
        localStorage.setItem('mathGod_localData', JSON.stringify(data));

        if (roomId.value) {
          db.ref('rooms/' + roomId.value).set(data).catch(()=>toast("åŒæ­¥å¤±æ•—ï¼Œå·²å­˜æœ¬åœ°", "error"));
          let names = JSON.parse(localStorage.getItem('mathGod_roomNames') || '{}');
          names[roomId.value] = eventName.value || 'æœªå‘½åæ´»å‹•';
          localStorage.setItem('mathGod_roomNames', JSON.stringify(names));
          roomNamesMap.value = names;
        }
      };

      // ====== rates ======
      const ratesHKD = ref({ HKD: 1 });
      const rateUpdatedAt = ref(null);
      const currentRate = ref(1);

      const SUPPORTED = ["HKD","CNY","JPY","TWD","THB","KRW","USD","EUR","GBP"];
      const RATES_CACHE_KEY = "mathGod_rates_to_HKD_v1";
      const RATES_TTL_MS = 6 * 60 * 60 * 1000;

      const loadRatesCache = () => {
  try {
    const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
    if (cached?.rates && cached?.updatedAt) {
      ratesHKD.value = cached.rates;
      rateUpdatedAt.value = cached.updatedAt;
    }
  } catch (e) {
    console.error("Failed to load rates cache:", e);
  }
};


      const saveRatesCache = (rates, updatedAt) => {
        localStorage.setItem(RATES_CACHE_KEY, JSON.stringify({ rates, updatedAt }));
        ratesHKD.value = rates;
        rateUpdatedAt.value = updatedAt;
      };

      const refreshRatesSilently = async (force=false) => {
        if (!navigator.onLine) return;

        const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
        const freshEnough = cached?.updatedAt && (Date.now() - cached.updatedAt < RATES_TTL_MS);
        if (!force && freshEnough) return;

        try {
          const res = await fetch(`https://open.er-api.com/v6/latest/USD`, { cache: "no-store" });
          const data = await res.json();
          const r = data?.rates;
          if (!r?.HKD) return;

          const toHKD = { HKD: 1 };
          SUPPORTED.forEach(code => {
            if (code === "HKD") return;
            if (r[code]) toHKD[code] = r.HKD / r[code];
          });

          saveRatesCache(toHKD, Date.now());
        } catch (e) {}
      };

      const handleCurrencyChange = async () => {
        if (form.value.currency === "HKD") {
          currentRate.value = 1;
          return;
        }
        const cachedRate = ratesHKD.value?.[form.value.currency];
        currentRate.value = cachedRate || 1;

        await refreshRatesSilently(false);

        const newRate = ratesHKD.value?.[form.value.currency];
        if (newRate) currentRate.value = newRate;

        if (!navigator.onLine && !newRate) toast("é›¢ç·šä¸”æœªæœ‰åŒ¯ç‡å¿«å–ï¼ˆå¯å…ˆä¸Šç·šé–‹ä¸€æ¬¡Appï¼‰", "error");
      };

      // ====== keypad ======
      const showKeypad = ref(false);
      const onEsc = (e) => { if (showKeypad.value && e.key === "Escape") closeKeypad(); };
      const onOnline = () => { isOnline.value = true; toast("å·²é€£ç·šï¼ˆOnlineï¼‰"); };
      const onOffline = () => { isOnline.value = false; toast("é›¢ç·šæ¨¡å¼ï¼ˆOfflineï¼‰", "error"); };

      const keypadExpr = ref("");
      const keypadHint = ref("");
      const calcPos = ref({ x: 20, y: 220 });
      let dragging = false;
      let dragOffset = { x: 0, y: 0 };

      const openKeypad = () => {
        if (showKeypad.value) return;
        errors.value.amount = false;
        keypadHint.value = "";
        const base = form.value.amount;
        keypadExpr.value = (base === null || base === undefined || base === "") ? "" : String(base);
        calcPos.value = {
          x: Math.max(8, Math.round(window.innerWidth / 2 - 160)),
          y: Math.max(8, Math.round(window.innerHeight / 2 - 260))
        };
        document.body.style.overflow = 'hidden';
        showKeypad.value = true;
      };

      const startDrag = (e) => {
        dragging = true;
        const p = (e.touches && e.touches[0]) ? e.touches[0] : e;
        dragOffset.x = p.clientX - calcPos.value.x;
        dragOffset.y = p.clientY - calcPos.value.y;

        const move = (ev) => {
          if (!dragging) return;
          const m = (ev.touches && ev.touches[0]) ? ev.touches[0] : ev;
          const panelW = 320;
          const panelH = 420;
          const maxX = window.innerWidth - panelW - 8;
          const maxY = window.innerHeight - panelH - 8;

          let nx = m.clientX - dragOffset.x;
          let ny = m.clientY - dragOffset.y;

          nx = Math.min(Math.max(8, nx), maxX);
          ny = Math.min(Math.max(8, ny), maxY);

          calcPos.value = { x: nx, y: ny };
        };

        const end = () => {
          dragging = false;
          window.removeEventListener('pointermove', move);
          window.removeEventListener('pointerup', end);
          window.removeEventListener('pointercancel', end);
          window.removeEventListener('mousemove', move);
          window.removeEventListener('mouseup', end);
          window.removeEventListener('touchmove', move);
          window.removeEventListener('touchend', end);
          window.removeEventListener('touchcancel', end);
        };

        window.addEventListener('pointermove', move, { passive: false });
        window.addEventListener('pointerup', end);
        window.addEventListener('pointercancel', end);
        window.addEventListener('mousemove', move, { passive: false });
        window.addEventListener('mouseup', end);
        window.addEventListener('touchmove', move, { passive: false });
        window.addEventListener('touchend', end);
        window.addEventListener('touchcancel', end);
      };

      const closeKeypad = () => {
        showKeypad.value = false;
        keypadHint.value = "";
        stopBackspaceHold();
        document.body.style.overflow = '';
      };

      const evalExpr = (expr) => {
        const cleaned = (expr || "").replace(/\s+/g, "");
        if (!cleaned) return null;
        if (!/^[0-9+\-*/.]+$/.test(cleaned)) throw new Error("åªå¯è¼¸å…¥æ•¸å­—åŒ + âˆ’ Ã— Ã· åŠ .");
        const v = Function(`"use strict"; return (${cleaned});`)();
        if (!Number.isFinite(v)) throw new Error("è¨ˆç®—çµæœç„¡æ•ˆ");
        return v;
      };

      const safeExprForPreview = (s) => {
        let x = (s || "").replace(/\s+/g, "");
        if (!/^[0-9+\-*/.]*$/.test(x)) return "";
        x = x.replace(/[+\-*/]+$/g, "");
        if (x.endsWith(".")) x += "0";
        return x;
      };

      const amountPreview = computed(() => {
        if (!showKeypad.value) return Number(form.value.amount || 0);
        const cleaned = safeExprForPreview(keypadExpr.value);
        if (!cleaned) return 0;
        try {
          const v = Function(`"use strict"; return (${cleaned});`)();
          return Number.isFinite(v) ? v : 0;
        } catch (e) {
          return 0;
        }
      });

      const amountPreviewText = computed(() => {
        return (Math.round((amountPreview.value || 0) * 100) / 100).toFixed(2);
      });

      let backspaceTimer = null;
      let backspaceHoldDelayTimer = null;

      const backspaceOnce = () => { keypadExpr.value = keypadExpr.value.slice(0, -1); };

      const startBackspaceHold = () => {
        keypadHint.value = "";
        if (!keypadExpr.value) return;
        backspaceOnce();
        stopBackspaceHold();
        backspaceHoldDelayTimer = setTimeout(() => {
          backspaceTimer = setInterval(() => {
            if (!showKeypad.value) return stopBackspaceHold();
            if (!keypadExpr.value) return stopBackspaceHold();
            backspaceOnce();
          }, 70);
        }, 1000);
      };

      const stopBackspaceHold = () => {
        if (backspaceHoldDelayTimer) { clearTimeout(backspaceHoldDelayTimer); backspaceHoldDelayTimer = null; }
        if (backspaceTimer) { clearInterval(backspaceTimer); backspaceTimer = null; }
      };

      const kp = (key) => {
        keypadHint.value = "";

        if (key === "C") { keypadExpr.value = ""; return; }
        if (key === "âŒ«") { backspaceOnce(); return; }

        if (key === "=") {
          try {
            const v = evalExpr(keypadExpr.value);
            const val = (v === null) ? null : Math.round(v * 100) / 100;

            if (val === null || !Number.isFinite(val) || val <= 0) {
              keypadHint.value = "è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡ï¼ˆéœ€å¤§æ–¼ 0ï¼‰";
              return;
            }

            form.value.amount = val;
            closeKeypad();
          } catch (e) {
            keypadHint.value = e?.message || "è¨ˆç®—éŒ¯èª¤";
          }
          return;
        }

        const last = keypadExpr.value.slice(-1);
        const isOp = (c) => ["+","-","*","/"].includes(c);

        if (isOp(key)) {
          if (!keypadExpr.value) return;
          if (isOp(last)) {
            keypadExpr.value = keypadExpr.value.slice(0, -1) + key;
            return;
          }
        }

        if (key === ".") {
          const parts = keypadExpr.value.split(/[+\-*/]/);
          const current = parts[parts.length - 1] || "";
          if (current.includes(".")) return;
          if (current === "") keypadExpr.value += "0";
        }

        keypadExpr.value += key;
      };

      // ====== users / involved ======
      const addUser = () => {
        const n = newUser.value.trim();
        if (!n) return;
        if (users.value.includes(n)) { toast("æœ‹å‹å·²å­˜åœ¨", "error"); return; }
        users.value.push(n);
        form.value.involved.push(n);
        newUser.value = "";
        saveData();
      };

      const toggleSelectAll = () => {
        form.value.involved = (form.value.involved.length === users.value.length) ? [] : [...users.value];
      };

      const toggleInvolved = (u) => {
        const idx = form.value.involved.indexOf(u);
        if (idx > -1) form.value.involved.splice(idx, 1);
        else form.value.involved.push(u);
      };

      // ====== expenses (now per-day) ======
      const addExpense = () => {
        if (showKeypad.value) closeKeypad();

        ensureDefaultDay();
        const amt = Number(form.value.amount);

        errors.value = {
          item: !form.value.item,
          amount: !(Number.isFinite(amt) && amt > 0),
          payer: !form.value.payer,
          involved: form.value.involved.length === 0
        };

        if (Object.values(errors.value).some(v => v)) {
          toast("è«‹å¡«å¦¥ç´…è‰²æ¬„ä½", "error");
          return;
        }

        const exp = {
          id: isEditing.value ? editingId.value : Date.now(),
          item: form.value.item,
          hkd: (amt * currentRate.value) || 0,
          payer: form.value.payer,
          involved: [...form.value.involved],
          origAmount: amt,
          origCurrency: form.value.currency
        };

        const d = activeDay.value;
        if (!d) return;

        if (isEditing.value) {
          const i = (d.expenses || []).findIndex(e => e.id === editingId.value);
          if (i > -1) d.expenses[i] = exp;
          toast("ä¿®æ”¹æˆåŠŸ");
        } else {
          d.expenses = d.expenses || [];
          d.expenses.unshift(exp);
          lastAddedId.value = exp.id;
          setTimeout(() => { if (lastAddedId.value === exp.id) lastAddedId.value = null; }, 1000);
          toast("å·²æ–°å¢ä¸€ç­†æ¶ˆè²»");
        }

        cancelEdit();
        saveData();
      };

      const editExpense = (i) => {
        ensureDefaultDay();
        const d = activeDay.value;
        const e = (d?.expenses || [])[i];
        if (!e) return;

        editingId.value = e.id;
        isEditing.value = true;
        form.value = { item: e.item, amount: e.origAmount, currency: e.origCurrency, payer: e.payer, involved: [...(e.involved || [])] };
        handleCurrencyChange();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const cancelEdit = () => {
        isEditing.value = false;
        editingId.value = null;
        form.value = { item: "", amount: "", currency: "HKD", payer: "", involved: [...users.value] };
        currentRate.value = 1;
        errors.value = { item: false, amount: false, payer: false, involved: false };
      };

      const removeExpense = (i) => {
        ensureDefaultDay();
        const d = activeDay.value;
        if (!d) return;

        if (confirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ")) {
          d.expenses.splice(i, 1);
          saveData();
        }
      };

      const removeUser = (i) => {
        const name = users.value[i];
        if (!name) return;

        if (!confirm("ç¢ºå®šåˆªé™¤æ­¤äººï¼Ÿï¼ˆæœƒåŒæ™‚ç§»é™¤ç›¸é—œæ¶ˆè²»é—œè¯ï¼‰")) return;

        users.value.splice(i, 1);
        form.value.involved = (form.value.involved || []).filter(u => u !== name);
        if (form.value.payer === name) form.value.payer = "";

        // remove across all days
        days.value = (days.value || []).map(d => {
          const exps = (d.expenses || [])
            .map(e => ({
              ...e,
              payer: e.payer === name ? "" : e.payer,
              involved: (e.involved || []).filter(u => u !== name),
              hkd: Number(e.hkd || 0),
            }))
            .filter(e => e.payer && Array.isArray(e.involved) && e.involved.length > 0);
          return { ...d, expenses: exps };
        });

        if (users.value.length === 0) {
          form.value.involved = [];
          form.value.payer = "";
        }

        saveData();
        toast("å·²åˆªé™¤æœ‹å‹ä¸¦æ¸…ç†ç›¸é—œç´€éŒ„");
      };

      // ====== settlements helper (supports custom expense list) ======
      const computeSettlements = (expenseList) => {
        let bal = {};
        users.value.forEach(u => bal[u] = 0);

        (expenseList || []).forEach(e => {
          if (!e || !e.payer || !Array.isArray(e.involved) || e.involved.length === 0) return;
          if (!(e.payer in bal)) return;

          const h = Number(e.hkd || 0);
          bal[e.payer] += h;

          const s = h / e.involved.length;
          e.involved.forEach(u => { if (u in bal) bal[u] -= s; });
        });

        let d = [], c = [], res = [];
        for (let u in bal) {
          if (bal[u] < -0.01) d.push({ n: u, a: Math.abs(bal[u]) });
          else if (bal[u] > 0.01) c.push({ n: u, a: bal[u] });
        }

        d.sort((a, b) => b.a - a.a);
        c.sort((a, b) => b.a - a.a);

        let i = 0, j = 0;
        while (i < d.length && j < c.length) {
          let m = Math.min(d[i].a, c[j].a);
          res.push({ from: d[i].n, to: c[j].n, amount: m });
          d[i].a -= m;
          c[j].a -= m;
          if (d[i].a < 0.01) i++;
          if (c[j].a < 0.01) j++;
        }
        return res;
      };

      // share expenses & settlements based on scope
      const expensesForShare = computed(() => {
        if (!multiDayMode.value) return allExpenses.value;
        return shareOptions.value.scope === "all" ? allExpenses.value : currentExpenses.value;
      });

      const settlementsForShare = computed(() => computeSettlements(expensesForShare.value));

      const totalSpentDay = computed(() => currentExpenses.value.reduce((s, e) => s + Number(e?.hkd || 0), 0));
      const totalSpentAll = computed(() => allExpenses.value.reduce((s, e) => s + Number(e?.hkd || 0), 0));
      const totalSpentForShare = computed(() => expensesForShare.value.reduce((s, e) => s + Number(e?.hkd || 0), 0));

      // ====== sync room helpers ======
      const updateHistory = (rid) => {
        let h = JSON.parse(localStorage.getItem('mathGod_history') || '[]');
        h = [rid, ...h.filter(x => x !== rid)].slice(0, 10);
        recentRooms.value = h;
        localStorage.setItem('mathGod_history', JSON.stringify(h));
      };

      const getRoomLink = (rid) => {
        const base = window.location.origin + window.location.pathname;
        const url = new URL(base);
        url.searchParams.set("room", rid);
        return url.toString();
      };

      const getRoomInviteText = (rid) => {
        const link = getRoomLink(rid);
        const name = (eventName.value || "").trim();
        return `æˆ‘é–‹å’—å€‹è¨˜æ•¸é é¢ï¼ğŸ§®
å¹«æ‰‹è¨˜ä½å¤§å®¶æ¶ˆè²»ï¼Œæœ€å¾Œè‡ªå‹•è¨ˆæ•¸æ¯äººè¦ç•€å¹¾éŒ¢ï¼

${name ? `ã€${name}ã€‘\n` : ""}å‡ºééŒ¢å˜…ï¼Œè¨˜å¾—å…¥å»markæ•¸å•¦ï¼š
âš¡ï¸ ${link}`.trim();
      };

      const copyRoomLink = async () => {
        if (!roomId.value) { toast("æœªé€£ç·šæˆ¿é–“", "error"); return; }
        const text = getRoomInviteText(roomId.value);
        try {
          await navigator.clipboard.writeText(text);
          toast("å·²è¤‡è£½é‚€è«‹è¨Šæ¯");
        } catch (e) {
          window.prompt("è¤‡è£½ä»¥ä¸‹è¨Šæ¯åˆ†äº«æ¯”æœ‹å‹ï¼š", text);
        }
      };

      const joinRoom = async (rid, options = {}) => {
        const { silent = false, showRejoinToast = false } = options;

        if (!navigator.onLine) {
          toast("é›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•é€£ç·šæˆ¿é–“ï¼ˆå·²ä½¿ç”¨æœ¬åœ°è³‡æ–™ï¼‰", "error");
          isSyncing.value = false;
          return;
        }
        if (!rid) return;
        rid = rid.toString();

        isSyncing.value = true;
        let handled = false;

        try {
          const snap = await db.ref('rooms/' + rid).once('value');
          if (snap.exists()) {
            roomId.value = rid;
            roomInput.value = rid;
            localStorage.setItem('mathGod_roomId', rid);

            db.ref('rooms/' + rid).off();
            db.ref('rooms/' + rid).on('value', s => {
              const v = s.val();
              if (v) {
                // âœ… migrate room data
                users.value = v.users || [];
                eventName.value = v.eventName || "";
                multiDayMode.value = !!v.multiDayMode;

                if (Array.isArray(v.days) && v.days.length > 0) {
                  days.value = v.days;
                } else {
                  // backward compat: old room may have expenses
                  const oldExpenses = Array.isArray(v.expenses) ? v.expenses : [];
                  days.value = [{ id: "day1", name: "Day1", expenses: oldExpenses }];
                }
                activeDayId.value = v.activeDayId || days.value[0]?.id || "day1";
                if (!isEditing.value) form.value.involved = [...users.value];
              }
            });

            updateHistory(rid);
            showSyncModal.value = false;

            handled = true;
            setTimeout(() => {
              isSyncing.value = false;
              if (!silent) toast(`æˆåŠŸåŠ å…¥æˆ¿é–“ #${rid}`);
              if (showRejoinToast) toast(`å·²å›åˆ°ä¸Šæ¬¡æˆ¿é–“ #${rid}`);
              history.replaceState(null, "", window.location.pathname);
            }, 600);

          } else {
            toast("æˆ¿é–“ä¸å­˜åœ¨", "error");
          }
        } catch (e) {
          console.error(e);
          toast("é€£ç·šéŒ¯èª¤", "error");
        } finally {
          if (!handled) isSyncing.value = false;
        }
      };

      const createRoom = async () => {
        const rid = Math.floor(1000 + Math.random() * 9000).toString();
        ensureDefaultDay();
        const initialData = {
          users: [...users.value],
          eventName: eventName.value || "",
          multiDayMode: !!multiDayMode.value,
          days: JSON.parse(JSON.stringify(days.value || [])),
          activeDayId: activeDayId.value
        };
        try {
          await db.ref('rooms/' + rid).set(initialData);
          joinRoom(rid);
        } catch (e) {
          console.error(e);
          isSyncing.value = false;
          toast("é€£ç·šéŒ¯èª¤", "error");
        }
      };

      const logoutRoom = () => {
        if (!roomId.value) return;
        isSyncing.value = true;

        setTimeout(() => {
          db.ref('rooms/' + roomId.value).off();
          roomId.value = null;
          roomInput.value = "";
          localStorage.removeItem('mathGod_roomId');
          resetData('all', false);
          isSyncing.value = false;
          toast("å·²ç™»å‡ºæˆ¿é–“");
        }, 800);
      };

      const removeHistoryRoom = (rid) => {
  if (confirm("å¾æœ€è¿‘ç´€éŒ„ä¸­åˆªé™¤æ­¤æˆ¿é–“ï¼Ÿ")) {
    let h = (recentRooms.value || []).filter(x => x !== rid);
    recentRooms.value = h;
    localStorage.setItem('mathGod_history', JSON.stringify(h));

    let names = { ...(roomNamesMap.value || {}) };
    delete names[rid];
    localStorage.setItem('mathGod_roomNames', JSON.stringify(names));
    roomNamesMap.value = names;
    toast("å·²å¾ç´€éŒ„ä¸­ç§»é™¤");
  }
};


      // ====== reset ======
      const resetData = (t, ask = true) => {
        const doReset = () => {
          if (t === 'all') {
            users.value = [];
            eventName.value = "";
            multiDayMode.value = false;
            days.value = [{ id: "day1", name: "Day1", expenses: [] }];
            activeDayId.value = "day1";
            form.value = { item: "", amount: "", currency: "HKD", payer: "", involved: [] };
          } else {
            ensureDefaultDay();
            // clear all expenses across all days
            days.value = (days.value || []).map(d => ({ ...d, expenses: [] }));
          }
          saveData();
          showResetMenu.value = false;
        };

        if (ask) {
          if (confirm(t === 'all' ? "ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼ˆåŒ…æ‹¬æœ‹å‹ï¼‰å—ï¼Ÿ" : "ç¢ºå®šåªæ¸…ç©ºæ¶ˆè²»ç´€éŒ„å—ï¼Ÿ")) {
            doReset();
            toast("è³‡æ–™å·²é‡ç½®");
          }
        } else {
          doReset();
        }
      };

      // ====== share ======
      const getShareText = () => {
        const expList = expensesForShare.value;
        const settle = settlementsForShare.value;

        let msg = `å¤¾éŒ¢é€šçŸ¥ (Payment Notice)\n`;
        if (eventName.value) msg += `æ´»å‹•: ${eventName.value}\n`;

        if (multiDayMode.value) {
          msg += `ç¯„åœ: ${shareOptions.value.scope === 'all' ? 'ç¶œåˆå…¨éƒ¨æ—¥å­' : ('åªè¨ˆï¼š' + (activeDay.value?.name || 'ç•¶æ—¥'))}\n`;
        }

        msg += `------------------------------\n`;
        msg += `è«‹è·Ÿéš¨ä»¥ä¸‹åˆ—è¡¨éæ•¸ (Transfer List):\n`;
        if (settle.length === 0) msg += `(æ²’æœ‰äººéœ€è¦å¤¾éŒ¢)\n`;
        settle.forEach(s => msg += `${s.from} âœ ${s.to}: $${s.amount.toFixed(1)}\n`);

        if (shareOptions.value.showList) {
          msg += `\nğŸ“‹ è©³ç´°æ¶ˆè²»ç´€éŒ„:\n`;

          if (multiDayMode.value && shareOptions.value.scope === "all") {
            (days.value || []).forEach(d => {
              msg += `\n== ${d.name} ==\n`;
              (d.expenses || []).forEach((e, idx) => {
                msg += `${idx + 1}. ${e.item} (${e.payer}ä»˜): $${Number(e.hkd || 0).toFixed(1)}\n`;
              });
              if ((d.expenses || []).length === 0) msg += `(æ­¤æ—¥ç„¡ç´€éŒ„)\n`;
            });
          } else {
            expList.forEach((e, idx) => {
              msg += `${idx + 1}. ${e.item} (${e.payer}ä»˜): $${Number(e.hkd || 0).toFixed(1)}\n`;
            });
          }
        }

        msg += `\n------------------------------\nGenerated by âš¡ï¸MathGod`;
        return msg;
      };

      const copyText = () => {
        navigator.clipboard.writeText(getShareText())
          .then(() => toast("å·²è¤‡è£½"))
          .catch(() => toast("è¤‡è£½å¤±æ•—", "error"));
      };

      const shareViaApp = async (type) => {
        try {
          if (type === 'text') {
            if (navigator.share) await navigator.share({ title: 'MathGod çµç®—', text: getShareText() });
            else copyText();
            return;
          }

          if (type === 'image') {
            toast("æ­£åœ¨è£½ä½œåœ–ç‰‡...");
            const zone = document.getElementById('capture-zone');
            if (!zone) return;

            const originalShadow = zone.style.boxShadow;
            const originalPaddingBottom = zone.style.paddingBottom;
            const originalTransform = zone.style.transform;

            zone.classList.add('capture-mode');
            zone.style.boxShadow = 'none';
            zone.style.paddingBottom = '16px';
            zone.style.transform = 'translateZ(0)';

            const canvas = await html2canvas(zone, {
              backgroundColor: '#e8e8e8',
              scale: 2,
              useCORS: true
            });

            canvas.toBlob(async (blob) => {
              zone.classList.remove('capture-mode');
              zone.style.boxShadow = originalShadow;
              zone.style.paddingBottom = originalPaddingBottom;
              zone.style.transform = originalTransform;

              if (!blob) {
                toast("æ­¤ç€è¦½å™¨ç„¡æ³•ç”Ÿæˆåœ–ç‰‡ï¼Œå·²æ”¹ç‚ºä¸‹è¼‰", "error");
                const link = document.createElement('a');
                link.download = `MathGod_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                return;
              }

              const file = new File([blob], "mathgod_share.png", { type: "image/png" });

              if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({ files: [file], title: 'MathGod çµç®—åœ–' });
              } else {
                const link = document.createElement('a');
                link.download = `MathGod_${Date.now()}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                toast("ç³»çµ±ä¸æ”¯æ´ç›´æ¥åœ–ç‰‡åˆ†äº«ï¼Œå·²ç‚ºä½ ä¸‹è¼‰");
              }
            }, "image/png");
          }
        } catch (err) {
          console.error(err);
          toast("åˆ†äº«å¤±æ•—", "error");
        }
      };

      const generateImage = async () => {
        const zone = document.getElementById('capture-zone');
        if (!zone) return;

        const originalShadow = zone.style.boxShadow;
        const originalPaddingBottom = zone.style.paddingBottom;
        const originalTransform = zone.style.transform;

        zone.classList.add('capture-mode');
        zone.style.boxShadow = 'none';
        zone.style.paddingBottom = '16px';
        zone.style.transform = 'translateZ(0)';

        try {
          const canvas = await html2canvas(zone, {
            backgroundColor: '#e8e8e8',
            scale: 2,
            useCORS: true
          });

          const link = document.createElement('a');
          link.download = `MathGod_${Date.now()}.png`;
          link.href = canvas.toDataURL();
          link.click();
        } finally {
          zone.classList.remove('capture-mode');
          zone.style.boxShadow = originalShadow;
          zone.style.paddingBottom = originalPaddingBottom;
          zone.style.transform = originalTransform;
        }
      };

      // ====== computed ======
      const recentRoomsWithNames = computed(() =>
  (recentRooms.value || []).map(id => ({ id, name: (roomNamesMap.value || {})[id] || 'æœªå‘½åæ´»å‹•' }))
);


      onMounted(() => {
        window.removeEventListener("keydown", onEsc);
        window.removeEventListener("online", onOnline);
        window.removeEventListener("offline", onOffline);

        window.addEventListener("keydown", onEsc);
        window.addEventListener("online", onOnline);
        window.addEventListener("offline", onOffline);

        loadRatesCache();
        refreshRatesSilently(false);

        // load local
let local = {};
try {
  local = JSON.parse(localStorage.getItem('mathGod_localData') || '{}');
} catch (e) {
  console.error("Failed to parse local data:", e);
  local = {};
}


        // âœ… backward compat: if old structure has expenses, migrate -> Day1
        users.value = local.users || [];
        eventName.value = local.eventName || "";

        multiDayMode.value = !!local.multiDayMode;

        if (Array.isArray(local.days) && local.days.length > 0) {
          days.value = local.days;
        } else {
          const oldExpenses = Array.isArray(local.expenses) ? local.expenses : [];
          days.value = [{ id: "day1", name: "Day1", expenses: oldExpenses }];
        }

        activeDayId.value = local.activeDayId || days.value[0]?.id || "day1";
        ensureDefaultDay();

        form.value.involved = [...users.value];

        // history
        recentRooms.value = JSON.parse(localStorage.getItem('mathGod_history') || '[]');
        roomNamesMap.value = JSON.parse(localStorage.getItem('mathGod_roomNames') || '{}');

        // URL room auto-join
        const roomFromUrl = new URLSearchParams(window.location.search).get("room");
        if (roomFromUrl && /^\d{4}$/.test(roomFromUrl)) {
          if (navigator.onLine) joinRoom(roomFromUrl);
          else toast("åµæ¸¬åˆ°æˆ¿é–“é€£çµï¼Œä½†ä½ ç¾æ­£é›¢ç·š", "error");
        } else {
          const savedRoom = localStorage.getItem('mathGod_roomId');
          if (savedRoom && navigator.onLine) {
            joinRoom(savedRoom, { silent: true, showRejoinToast: true });
          } else {
            isLoading.value = false;
          }
        }

        if (!navigator.onLine) onOffline();

        // ensure currency sync
        if (form.value.currency !== "HKD") handleCurrencyChange();
      });

      onUnmounted(() => {
        window.removeEventListener("keydown", onEsc);
        window.removeEventListener("online", onOnline);
        window.removeEventListener("offline", onOffline);
      });

           // ====== return ======
      return {
        // state
        isLoading, isSyncing, isOnline,
        eventName, users, newUser,
        form, isEditing, editingId,
        showSyncModal, showShareModal, showResetMenu, showTutorial,
        toasts, roomId, roomInput,
        shareSubMenu,

        // handlers
        handleSyncClick,

        // multi-day
        multiDayMode, days, activeDayId, activeDay,
        currentExpenses, allExpenses,
        setActiveDay, addDay, removeActiveDay,
        activeDayNameProxy,
        onToggleMultiDay,

        // totals
        totalSpentDay, totalSpentAll, totalSpentForShare,

        // rates
        currentRate, rateUpdatedAt, formatTs,

        // share / validation
        shareOptions, errors,
        expensesForShare, settlementsForShare,

        // keypad
        showKeypad, keypadExpr, keypadHint,
        amountPreview, amountPreviewText,
        openKeypad, closeKeypad, kp,
        startBackspaceHold, stopBackspaceHold,

        // actions
        openDatePicker, appendDate,
        addUser, addExpense, editExpense, cancelEdit,
        removeUser, removeExpense,
        toggleSelectAll, toggleInvolved,
        handleCurrencyChange,
        saveData,
        joinRoom, createRoom, logoutRoom,
        resetData, removeHistoryRoom,
        copyRoomLink,
        copyText, shareViaApp, generateImage,

        // computed
        recentRoomsWithNames,

        // drag & misc
        calcPos,
        startDrag,
        lastAddedId,
        amountFontClass,
        sanitizeAmount,
      };

    }
  }).mount('#app');
</script>

</body>
</html>
