<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹</title>

  <meta name="description" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹ - å°ˆç‚ºæœ‹å‹èšæœƒã€æ—…è¡Œè¨­è¨ˆçš„åŒæ­¥åˆ†å¸³å·¥å…·ã€‚æ”¯æ´å¤šåœ‹åŒ¯ç‡è½‰æ›ï¼Œä¸€éµç”Ÿæˆçµç®—å–®ã€‚">


  <meta property="og:type" content="website">
  <meta property="og:url" content="https://capy013.github.io/mathgod/">
  <meta property="og:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta property="og:description" content="æ—…è¡Œã€é£Ÿé£¯ã€å¤¾éŒ¢å””ä½¿ç…©ï¼æ”¯æ´å³æ™‚åŒæ­¥åŠŸèƒ½ï¼Œè‡ªå‹•æ›ç®—åŒ¯ç‡ï¼ŒMathGod å¹«ä½ è¨ˆåˆ°ç›¡ã€‚">
  <meta property="og:image" content="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta name="twitter:description" content="æœ‹å‹èšæœƒåˆ†å¸³ç¥å™¨ï¼šæ”¯æ´å¤šå¹£ç¨®ã€é›²ç«¯åŒæ­¥ã€‚">
  <meta name="twitter:image" content="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png">

  <meta name="theme-color" content="#0a2f23">

  <link rel="icon" href="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png">
  <link rel="apple-touch-icon" href="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png">


  <link rel="manifest" href="./manifest.webmanifest">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #10b981; --bg: #050505; --card-bg: rgba(30, 30, 30, 0.65); --border: rgba(255, 255, 255, 0.1); }
    [v-cloak] { display: none !important; }
    body { background-color: var(--bg); color: #fff; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .glass { background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
    .glass-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
    .glass-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); background: rgba(0,0,0,0.5); }
    .input-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .font-num { font-family: 'JetBrains Mono', monospace; }
    .btn-press { transition: transform 0.1s; }
    .btn-press:active { transform: scale(0.96); }
    .footer-gradient { background: linear-gradient(to top, rgba(5,5,5,0.95) 10%, rgba(5,5,5,0.6) 40%, rgba(5,5,5,0) 100%); pointer-events: none; height: 120px; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-30px) scale(0.9); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    .math-check { appearance: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; position: relative; transition: all 0.2s; }
    .math-check:checked { background: var(--primary); border-color: var(--primary); }
    .math-check:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; font-size: 10px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    .app-logo { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3)); }
   
@keyframes lightningBar {
  0%   { transform: translateX(-120%); }
  100% { transform: translateX(420%); }
}
.animate-lightning-bar {
  animation: lightningBar 1s infinite linear;
}

.capture-mode .truncate {
  overflow: visible !important;
  text-overflow: clip !important;
}


.capture-mode .capture-row,
.capture-mode .capture-row span {
  line-height: 1.6 !important;
  padding-bottom: 2px !important;
}

  </style>
</head>

<body>
<div id="app" v-cloak class="min-h-screen flex flex-col max-w-[500px] mx-auto relative pb-32">

  <transition name="fade">
    <div v-if="isLoading" class="fixed inset-0 z-[200] bg-black flex items-center justify-center">
      <div class="flex flex-col items-center">
        <img src="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png" class="w-16 h-16 rounded-2xl mb-4 animate-pulse shadow-2xl">
        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">âš¡ï¸ Loading...</p>
      </div>
    </div>
  </transition>

  <div class="fixed top-8 left-0 right-0 z-[999] flex flex-col items-center pointer-events-none px-4">
    <transition-group name="toast">
      <div v-for="t in toasts" :key="t.id" class="glass px-6 py-3 rounded-full flex items-center gap-3 mb-2 shadow-2xl pointer-events-auto border-l-4"
           :class="t.type === 'error' ? 'border-red-500' : 'border-emerald-500'">
        <i :class="['fas', t.type === 'error' ? 'fa-times-circle text-red-400' : 'fa-check-circle text-emerald-400']"></i>
        <span class="text-xs font-bold">{{ t.msg }}</span>
      </div>
    </transition-group>
  </div>

  <header class="p-6 pb-8 rounded-b-[2.5rem] sticky top-0 z-40 transition-all duration-500 shadow-2xl backdrop-blur-xl border-b border-white/5"
          :class="isEditing ? 'bg-amber-950/80' : 'bg-[#0a2f23]/80'">

    <div class="flex justify-between items-start mb-6">
      <div class="flex items-center gap-3">
        <img src="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png" class="h-10 w-10 rounded-xl object-contain shadow-lg border border-white/10 app-logo">
        <div>
          <h1 class="text-xl font-black italic tracking-tighter text-white leading-none">MathGod</h1>
          <p class="text-[9px] font-bold text-emerald-400/80 tracking-[0.1em] uppercase">
            {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹æ¨¡å¼' : 'æœ‹å‹å¤¾éŒ¢è¨ˆç®—å™¨' }}
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button @click="showTutorial = true" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs hover:bg-white/20 transition-all">
          <i class="fas fa-question text-white/70"></i>
        </button>

        <div v-if="roomId" class="glass px-3 py-1.5 rounded-full flex items-center gap-3 border-emerald-500/30 bg-emerald-900/20">
          <div class="text-right">
            <p class="text-[8px] font-bold uppercase"
   :class="isOnline ? 'text-emerald-400' : 'text-gray-400'">
  {{ isOnline ? 'ONLINE' : 'OFFLINE' }}
</p>

            <p class="text-xs font-num font-bold text-emerald-400 leading-none">#{{ roomId }}</p>
          </div>
          <button @click="copyRoomLink" class="w-6 h-6 rounded-full bg-white/10 text-white/70 flex items-center justify-center hover:bg-white/20 transition-all">
  <i class="fas fa-link text-[10px]"></i>
</button>

          <button @click="logoutRoom" class="w-6 h-6 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
            <i class="fas fa-power-off text-[10px]"></i>
          </button>
        </div>

        <button
  v-else
  @click="isOnline ? (showSyncModal = true) : toast('ç›®å‰é›¢ç·šï¼Œæœªèƒ½åŒæ­¥', 'error')"
  class="glass px-4 py-2 rounded-full text-[10px] font-bold border-white/10 transition-all flex items-center gap-2 btn-press"
  :class="isOnline ? 'hover:border-emerald-500/50' : 'opacity-40 grayscale'">

 <i :class="['fas', isOnline ? 'fa-cloud' : 'fa-wifi', isOnline ? 'text-emerald-400' : 'text-gray-500']"></i>



  <span>{{ isOnline ? 'åŒæ­¥MODE' : 'é›¢ç·šä¸­' }}</span>
</button>



      </div>
    </div>

    <div class="flex gap-3">
      <div class="flex-1 glass-input rounded-2xl flex items-center px-4 relative">
        <i class="fas fa-pen text-[10px] text-gray-500 mr-3"></i>
        <input v-model="eventName" @input="saveData" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/20" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: æ—¥æœ¬ Day1)">
      </div>

      <button @click="openDatePicker" class="w-12 glass-input rounded-2xl flex items-center justify-center hover:border-emerald-500/50 btn-press">
        <i class="fas fa-calendar-day text-emerald-400 pointer-events-none"></i>
      </button>
      <input type="date" id="dateInput" class="hidden" @change="appendDate">
    </div>
   
<div v-if="isSyncing" class="mt-3">
  <div class="h-1 w-full overflow-hidden rounded-full bg-white/10">
    <div class="h-full w-1/3 bg-emerald-400 animate-lightning-bar"></div>
  </div>
  <div class="mt-1 text-[9px] font-bold text-gray-400 tracking-widest uppercase">
    âš¡ï¸ Loading...
  </div>
</div>

  </header>

  <main class="p-5 space-y-6 flex-1">

 
    <section class="glass p-5 rounded-[2rem]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">STEP 1: æœ‹å‹</h3>
        <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full text-gray-400 font-num">{{ users.length }} äºº</span>
      </div>

      <div class="flex gap-2 mb-4">
        <div class="flex-1 glass-input rounded-xl flex items-center px-4 transition-all"
             :class="{'border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]': users.length === 0}">
          <i class="fas fa-user-plus text-xs text-gray-500 mr-2"></i>
          <input v-model="newUser" @keyup.enter="addUser" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="è¼¸å…¥åå­—...">
        </div>
        <button @click="addUser" class="bg-emerald-600 px-5 rounded-xl font-black text-xs btn-press shadow-lg shadow-emerald-900/50">åŠ å…¥</button>
      </div>

      <div class="flex flex-wrap gap-2">
        <transition-group name="toast">
          <div v-for="(u, i) in users" :key="u" class="bg-white/5 border border-white/10 px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 group">
            {{ u }}
            <button @click="removeUser(i)" class="text-gray-600 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
          </div>
        </transition-group>
        <div v-if="users.length === 0" class="w-full text-center py-2 text-[10px] text-emerald-400/70 animate-pulse">
          <i class="fas fa-arrow-up mr-1"></i> è«‹å…ˆåŠ å…¥åƒèˆ‡æ´»å‹•çš„æœ‹å‹
        </div>
      </div>
    </section>

  
    <section class="glass p-6 rounded-[2rem] transition-all duration-300 relative overflow-hidden"
             :class="{'opacity-50 pointer-events-none grayscale': users.length === 0, 'border-amber-500/50': isEditing}">

      <div v-if="users.length === 0" class="absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
        <div class="bg-black/80 px-4 py-2 rounded-full text-xs font-bold text-white"><i class="fas fa-lock mr-2"></i>åŠ å…¥æœ‹å‹å¾Œè§£é–</div>
      </div>

      <div class="flex justify-between items-center mb-5">
        <h3 class="text-[10px] font-bold uppercase tracking-widest flex items-center gap-2" :class="isEditing ? 'text-amber-500' : 'text-emerald-500'">
          {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹' : 'STEP 2: æ–°å¢æ¶ˆè²»' }}
        </h3>
        <button v-if="isEditing" @click="cancelEdit" class="text-[10px] text-gray-400 underline hover:text-white">å–æ¶ˆä¿®æ”¹</button>
      </div>

      <div class="space-y-4">
        <div class="glass-input rounded-2xl flex items-center px-4 relative" :class="{'input-error': errors.item}">
          <input v-model="form.item" @input="errors.item = false" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤)">
          <button v-if="form.item" @click="form.item = ''" class="absolute right-3 p-2 text-gray-500 hover:text-white transition-colors">
            <i class="fas fa-times text-xs"></i>
          </button>
        </div>

        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-4 glass-input rounded-2xl relative">
            <select v-model="form.currency" @change="handleCurrencyChange" class="w-full h-full bg-transparent px-3 text-xs font-black outline-none appearance-none text-center z-10 relative">
              <option value="HKD">HKD ğŸ‡­ğŸ‡°</option>
              <option value="CNY">CNY ğŸ‡¨ğŸ‡³</option>
              <option value="JPY">JPY ğŸ‡¯ğŸ‡µ</option>
              <option value="TWD">TWD ğŸ‡¹ğŸ‡¼</option>
              <option value="THB">THB ğŸ‡¹ğŸ‡­</option>
              <option value="KRW">KRW ğŸ‡°ğŸ‡·</option>
              <option value="USD">USD ğŸ‡ºğŸ‡¸</option>
              <option value="EUR">EUR ğŸ‡ªğŸ‡º</option>
              <option value="GBP">GBP ğŸ‡¬ğŸ‡§</option>
            </select>
            <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[8px] text-gray-500"></i>
          </div>

          <div class="col-span-8 glass-input rounded-2xl flex flex-col justify-center px-4 py-2" :class="{'input-error': errors.amount}">
            <div class="flex items-center">
              <span class="text-xs font-black text-gray-500 mr-2">$</span>
              <input v-model.number="form.amount" @input="errors.amount = false" type="number" inputmode="decimal" class="w-full bg-transparent text-right font-num font-black text-xl outline-none placeholder-white/10" placeholder="0.0">
            </div>

           
            <div v-if="form.currency !== 'HKD'" class="text-right border-t border-white/5 mt-1 pt-1 space-y-1">
              <div>
                <span class="text-[9px] font-bold text-emerald-400 font-num">
                  Rate: {{currentRate.toFixed(3)}} â‰ˆ HKD ${{ (form.amount * currentRate || 0).toFixed(1) }}
                </span>
              </div>
              <div v-if="rateUpdatedAt" class="text-[9px] font-bold text-gray-500 font-num">
                æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ formatTs(rateUpdatedAt) }}
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="space-y-1">
            <p class="text-[9px] font-bold text-gray-500 ml-1">èª°ä»˜éŒ¢</p>
            <div class="glass-input rounded-xl relative" :class="{'input-error': errors.payer}">
              <select v-model="form.payer" @change="errors.payer = false" class="w-full bg-transparent p-3 text-xs font-bold outline-none appearance-none">
                <option value="" disabled>è«‹é¸æ“‡...</option>
                <option v-for="u in users" :value="u">{{ u }}</option>
              </select>
              <i class="fas fa-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            </div>
          </div>

          <div class="space-y-1">
            <div class="flex justify-between px-1">
              <p class="text-[9px] font-bold text-gray-500" :class="{'text-red-400': errors.involved}">èª°æœ‰ä»½ ({{ form.involved.length }})</p>
              <button @click="toggleSelectAll" class="text-[9px] text-emerald-500 font-bold hover:text-white transition-colors">å…¨é¸/å–æ¶ˆ</button>
            </div>
            <div class="glass-input rounded-xl p-2 max-h-28 overflow-y-auto custom-scroll space-y-1" :class="{'input-error': errors.involved}">
              <div v-for="u in users" :key="u" @click="toggleInvolved(u)" class="flex items-center gap-2 p-1.5 rounded-lg cursor-pointer hover:bg-white/5">
                <input type="checkbox" :checked="form.involved.includes(u)" class="math-check pointer-events-none">
                <span class="text-[10px] font-bold" :class="form.involved.includes(u) ? 'text-white' : 'text-gray-500'">{{ u }}</span>
              </div>
            </div>
          </div>
        </div>

        <button @click="addExpense" class="w-full py-4 rounded-2xl font-black text-sm shadow-xl btn-press flex items-center justify-center gap-2 transition-all"
                :class="isEditing ? 'bg-amber-600 shadow-amber-900/40' : 'bg-emerald-600 shadow-emerald-900/40'">
          <i :class="['fas', isEditing ? 'fa-save' : 'fa-plus']"></i>
          <span>{{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªå…¥å¸³' }}</span>
          <span v-if="form.amount" class="font-num bg-black/20 px-2 rounded ml-1 text-xs">
            HKD ${{ ((form.amount * currentRate) || 0).toFixed(1) }}
          </span>
        </button>
      </div>
    </section>

   
    <section class="pb-10">
      <h3 class="text-[10px] font-bold text-gray-500 ml-2 mb-3 uppercase tracking-widest">æœ€è¿‘ç´€éŒ„</h3>

      <div v-if="expenses.length === 0" class="text-center py-6 opacity-30">
        <i class="fas fa-clipboard-list text-3xl mb-2"></i>
        <p class="text-xs">æš«ç„¡æ¶ˆè²»</p>
      </div>

      <div class="space-y-3">
        <div v-for="(exp, idx) in expenses" :key="exp.id" @click="editExpense(idx)"
             class="glass p-4 rounded-2xl flex justify-between items-center border-l-[3px] transition-all active:scale-[0.99]"
             :style="{ borderColor: isEditing && editingId === exp.id ? '#f59e0b' : '#10b981' }">
          <div class="flex-1 overflow-hidden pr-3">
            <div class="flex items-center gap-2 mb-1">
              <p class="font-bold text-sm truncate text-gray-100">{{ exp.item }}</p>
              <span v-if="exp.origCurrency !== 'HKD'" class="text-[8px] bg-white/10 px-1.5 rounded text-gray-400 font-num">{{ exp.origCurrency }}</span>
            </div>
            <p class="text-[10px] text-gray-400 font-bold flex items-center gap-1">
              <span class="text-emerald-400 font-num">HKD ${{ (exp.hkd || 0).toFixed(1) }}</span>
              <span class="text-gray-600">|</span>
              <span>{{ exp.payer }} ä»˜</span>
            </p>
          </div>

          <button @click.stop="removeExpense(idx)" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-600 hover:bg-red-500/20 hover:text-red-400 transition-colors">
            <i class="fas fa-trash-alt text-xs"></i>
          </button>
        </div>
      </div>
    </section>
  </main>

  <div class="fixed bottom-0 left-0 right-0 footer-gradient z-40 pointer-events-none"></div>
  <div v-if="showResetMenu" @click="showResetMenu = false" class="fixed inset-0 z-40 bg-transparent"></div>

  <footer class="fixed bottom-6 left-0 right-0 max-w-[500px] mx-auto px-6 z-50 grid grid-cols-2 gap-4 pointer-events-none">
    <button @click="showShareModal = true" :disabled="expenses.length === 0"
            class="pointer-events-auto bg-emerald-600 hover:bg-emerald-500 py-4 rounded-2xl font-black text-xs shadow-2xl shadow-emerald-900/40 btn-press disabled:opacity-50 disabled:grayscale transition-all flex items-center justify-center gap-2 border border-emerald-400/20 backdrop-blur-md text-white">
      <i class="fas fa-receipt"></i> çµç®—åˆ†äº«
    </button>

    <div class="relative pointer-events-auto group">
      <button @click="showResetMenu = !showResetMenu" class="w-full bg-[#151515]/90 border border-white/10 py-4 rounded-2xl font-black text-xs text-gray-400 backdrop-blur-md btn-press hover:bg-white/5 transition-all flex items-center justify-center gap-2 shadow-xl">
        <i class="fas fa-cog"></i> é‡è¨­
      </button>
      <div v-if="showResetMenu" class="absolute bottom-full mb-3 left-0 right-0 bg-[#1a1a1a] rounded-2xl border border-white/10 overflow-hidden shadow-2xl z-50 animate-[slideUp_0.2s_ease-out]">
        <button @click="resetData('expenses')" class="w-full p-4 text-xs font-bold text-left text-red-300 border-b border-white/5 hover:bg-white/5"><i class="fas fa-eraser mr-2"></i>åªæ¸…ç©ºæ¶ˆè²»ç´€éŒ„</button>
        <button @click="resetData('all')" class="w-full p-4 text-xs font-bold text-left text-red-500 hover:bg-white/5"><i class="fas fa-bomb mr-2"></i>æ¸…é™¤æ‰€æœ‰ç´€éŒ„ (åŒ…æ‹¬æœ‹å‹)</button>
      </div>
    </div>
  </footer>

 
  <div v-if="showSyncModal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6" @click.self="showSyncModal = false">
    <div class="glass w-full max-w-sm p-8 rounded-[2.5rem] relative overflow-hidden animate-[fadeIn_0.3s_ease]">
      <div class="absolute top-0 left-0 right-0 h-32 bg-gradient-to-b from-emerald-900/20 to-transparent pointer-events-none"></div>

      <div class="relative z-10 text-center mb-8">
        <img src="https://gcdnb.pbrd.co/images/0IwB6gU2P6xo.png" class="w-20 h-20 mx-auto mb-4 rounded-2xl shadow-[0_0_20px_rgba(16,185,129,0.3)] border border-white/10 object-contain bg-black/20">
        <h3 class="text-xl font-black">ç™»å…¥åŒæ­¥æˆ¿é–“</h3>
      </div>

      <div class="mb-6 relative group">
        <input v-model="roomInput" type="number" class="w-full text-center text-4xl font-num font-bold py-4 bg-black/40 rounded-2xl outline-none border border-white/10 focus:border-emerald-500/50 transition-all text-emerald-400 placeholder-white/5 tracking-widest" placeholder="0000">
        <p class="text-[9px] text-gray-600 text-center mt-2 font-bold uppercase">è¼¸å…¥ 4 ä½æ•¸æˆ¿è™Ÿ</p>
      </div>

      <div class="grid grid-cols-2 gap-3 mb-8">
        <button @click="joinRoom(roomInput)" class="bg-emerald-600 py-3.5 rounded-xl font-black text-xs btn-press">é€²å…¥æˆ¿é–“</button>
        <button @click="createRoom" class="bg-white/5 border border-white/10 py-3.5 rounded-xl font-black text-xs btn-press hover:bg-white/10">æ–°é–‹æˆ¿é–“</button>
      </div>

      <div v-if="recentRoomsWithNames.length > 0" class="border-t border-white/5 pt-5">
        <p class="text-[9px] text-gray-500 font-bold uppercase mb-3 px-1">æœ€è¿‘ç€è¦½</p>
        <div class="space-y-2 max-h-40 overflow-y-auto custom-scroll pr-1">
          <div v-for="r in recentRoomsWithNames" :key="r.id" class="flex items-center gap-2 group">
            <button @click="joinRoom(r.id)" class="flex-1 bg-white/5 p-3 rounded-xl flex items-center border border-transparent hover:border-emerald-500/30 transition-all text-left">
              <span class="font-num text-emerald-500 font-bold mr-3 text-xs">#{{ r.id }}</span>
              <span class="text-[10px] font-bold text-gray-300 truncate flex-1">{{ r.name }}</span>
            </button>
            <button @click="removeHistoryRoom(r.id)" class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-600 hover:text-red-400 hover:bg-red-500/10 transition-colors">
              <i class="fas fa-times text-xs"></i>
            </button>
          </div>
        </div>
      </div>

      <button @click="showSyncModal = false" class="absolute top-6 right-6 text-gray-500 hover:text-white"><i class="fas fa-times text-lg"></i></button>
    </div>
  </div>

 
  <div v-if="showShareModal" class="fixed inset-0 z-[100] bg-black/95 backdrop-blur-xl flex flex-col p-4 overflow-y-auto" @click.self="showShareModal = false">
    <div class="max-w-md mx-auto w-full my-auto">

     <div id="capture-zone" class="bg-[#e8e8e8] text-black p-6 rounded-lg shadow-2xl mb-6 relative font-mono">

        <div class="absolute top-0 left-0 right-0 h-2 bg-gradient-to-b from-gray-300 to-transparent opacity-20"></div>

        <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4">
          <h2 class="font-black text-2xl tracking-tighter uppercase mb-1">éæ•¸é€šçŸ¥å–®</h2>
          <p v-if="eventName" class="text-sm font-bold text-gray-600">{{ eventName }}</p>
        </div>

        <div class="flex justify-between items-end mb-4 px-2">
          <span class="text-xs font-bold text-gray-600">ç¸½æ”¯å‡º (Total)</span>
          <span class="font-black text-2xl tracking-tight">${{ totalSpent.toFixed(1) }}</span>
        </div>

        <div class="bg-white p-3 rounded border border-gray-300 mb-4">
          <p class="text-[10px] font-bold text-gray-500 mb-2 border-b border-gray-200 pb-1">éæ•¸æŒ‡å— (Payment Guide)</p>
          <div v-if="settlements.length === 0" class="text-center text-gray-400 text-xs py-2">æ²’æœ‰äººéœ€è¦å¤¾éŒ¢</div>
          <div v-for="s in settlements" class="flex justify-between items-center py-1 text-sm font-bold">
            <div class="flex items-center gap-2">
              <span class="text-red-600">{{ s.from }}</span>
              <i class="fas fa-arrow-right-long text-gray-400 mx-2"></i>
              <span class="text-emerald-600">{{ s.to }}</span>
            </div>
            <span>${{ s.amount.toFixed(1) }}</span>
          </div>
        </div>

        <div v-if="shareOptions.showList" class="mt-4 pt-2 border-t-2 border-dashed border-gray-400">
          <p class="text-[10px] font-bold text-gray-500 mb-2 text-center uppercase">-- æ¶ˆè²»ç´€éŒ„ (Details) --</p>
          <div v-for="e in expenses" class="capture-row flex justify-between text-[10px] leading-[1.4] py-1.5 border-b border-gray-300 last:border-0">
            <span class="truncate pr-2 font-medium">{{ e.item }} <span class="text-gray-400">({{ e.payer }})</span></span>
            <span class="whitespace-nowrap font-bold">${{ e.hkd.toFixed(1) }}</span>
          </div>
        </div>

        <div class="mt-6 text-center">
          <p class="text-[10px] font-bold text-gray-500">Generated by âš¡ï¸MathGod</p>
          <div class="h-2 opacity-0">.</div>
        </div>
      </div>

      <div class="glass p-6 rounded-[2rem] space-y-4">
        <div class="flex justify-between items-center bg-black/20 p-3 rounded-xl border border-white/5">
          <span class="text-xs font-bold text-gray-300">åˆ—å‡ºæ¶ˆè²»ç´€éŒ„</span>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" v-model="shareOptions.showList" class="sr-only peer">
            <div class="w-10 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
          </label>
        </div>

        <div v-if="shareSubMenu === 'none'" class="grid grid-cols-2 gap-3">
          <button @click="shareSubMenu = 'text'" class="bg-gray-700 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-file-alt text-lg"></i> åˆ†äº«æ–‡å­—
          </button>
          <button @click="shareSubMenu = 'image'" class="bg-emerald-600 py-4 rounded-xl font-black text-xs btn-press flex flex-col items-center gap-2">
            <i class="fas fa-image text-lg"></i> åˆ†äº«åœ–ç‰‡
          </button>
        </div>

        <div v-if="shareSubMenu === 'text'" class="space-y-3">
          <button @click="copyText" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-copy mr-2"></i> è¤‡è£½æ–‡å­—
          </button>
          <button @click="shareViaApp('text')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>

        <div v-if="shareSubMenu === 'image'" class="space-y-3">
          <button @click="generateImage" class="w-full bg-white/10 py-4 rounded-xl font-bold text-xs btn-press border border-white/10">
            <i class="fas fa-download mr-2"></i> ä¸‹è¼‰åœ–ç‰‡
          </button>
          <button @click="shareViaApp('image')" class="w-full bg-emerald-600 py-4 rounded-xl font-bold text-xs btn-press">
            <i class="fas fa-share-nodes mr-2"></i> åˆ†äº«åˆ°APP
          </button>
          <button @click="shareSubMenu = 'none'" class="w-full py-1 text-[10px] text-gray-500 font-bold">è¿”å›</button>
        </div>
      </div>

      <button @click="showShareModal = false; shareSubMenu = 'none'"
              class="w-full bg-white/10 py-3 rounded-xl text-xs font-black mt-4 border border-white/10 hover:bg-white/15 btn-press">
        é—œé–‰
      </button>
    </div>
  </div>

  
  <div v-if="showTutorial" class="fixed inset-0 z-[150] bg-black/95 backdrop-blur-md flex items-center justify-center p-6" @click.self="showTutorial = false">
    <div class="glass max-w-sm w-full p-6 rounded-[2rem] text-center">
      <h3 class="text-lg font-black text-emerald-400 mb-4">ä½¿ç”¨æ•™å­¸</h3>
      <ul class="text-left text-xs space-y-3 text-gray-300 mb-6 font-bold">
        <li>1. å…ˆåœ¨ <span class="text-white border border-white/20 px-1 rounded">æœ‹å‹</span> å€è¼¸å…¥åå­—ä¸¦åŠ å…¥ã€‚</li>
        <li>2. åœ¨ <span class="text-white border border-white/20 px-1 rounded">æ–°å¢æ¶ˆè²»</span> å¡«å¯«é‡‘é¡ï¼Œé¸æ“‡èª°ä»˜éŒ¢ã€‚</li>
        <li>3. ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—èª°éœ€è¦çµ¦èª°éŒ¢ã€‚</li>
        <li>4. æŒ‰ä¸‹ <span class="text-emerald-400 border border-emerald-400/30 px-1 rounded">çµç®—åˆ†äº«</span> å³å¯ç”¢ç”Ÿå ±è¡¨ã€‚</li>
        <li>5. é»æ“Š <span class="text-emerald-400 border border-emerald-400/30 px-1 rounded">åŒæ­¥MODE</span> å¯èˆ‡æœ‹å‹å³æ™‚é€£ç·šã€‚</li>
      </ul>
      <button @click="showTutorial = false" class="bg-white/10 w-full py-3 rounded-xl text-xs font-black">æ˜ç™½</button>
    </div>
  </div>

</div>

<script>
  const firebaseConfig = {
    apiKey: "yFDRUSUFAFnZf6AGdsEA9LxSyLcZF75oIFfib5At",
    databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "mathgod2"
  };
  try { firebase.initializeApp(firebaseConfig); } catch(e) {}
  const db = firebase.database();
  const { createApp, ref, computed, onMounted } = Vue;

  
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js', { scope: '/mathgod/' })

        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW failed', err));
    });
  }

  createApp({
    setup() {
     
      const isLoading = ref(false);
      const isSyncing = ref(false);
      const eventName = ref("");
      const users = ref([]);
      const expenses = ref([]);
      const newUser = ref("");
      const isEditing = ref(false);
      const editingId = ref(null);
      const showSyncModal = ref(false);
      const showShareModal = ref(false);
      const showResetMenu = ref(false);
      const showTutorial = ref(false);
      const shareSubMenu = ref('none');
      const toasts = ref([]);
      const roomId = ref(null);
      const isOnline = ref(navigator.onLine);
      const roomInput = ref("");
      const recentRooms = ref([]);
      const roomNamesMap = ref({});
      const form = ref({ item: "", amount: null, currency: "HKD", payer: "", involved: [] });
      const errors = ref({ item: false, amount: false, payer: false, involved: false });

    
      const ratesHKD = ref({ HKD: 1 });
      const rateUpdatedAt = ref(null);
      const currentRate = ref(1);

      const shareOptions = ref({ showList: true });

      
      const toast = (msg, type='success') => {
        const id = Date.now();
        toasts.value.push({id, msg, type});
        setTimeout(() => toasts.value = toasts.value.filter(t=>t.id!==id), 3000);
      };
      const setLoading = (status) => isLoading.value = status;

      const pad2 = (n) => String(n).padStart(2, "0");
      const formatTs = (ts) => {
        const d = new Date(ts);
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
      };

  
      const openDatePicker = () => {
        const el = document.getElementById('dateInput');
        if(!el) return;
        if (typeof el.showPicker === 'function') el.showPicker();
        else el.click();
      };

     
      const saveData = () => {
        const data = { users: [...users.value], expenses: [...expenses.value], eventName: eventName.value };
        localStorage.setItem('mathGod_localData', JSON.stringify(data));
        if (roomId.value) {
          db.ref('rooms/' + roomId.value).set(data).catch(()=>toast("åŒæ­¥å¤±æ•—ï¼Œå·²å­˜æœ¬åœ°", "error"));
          let names = JSON.parse(localStorage.getItem('mathGod_roomNames') || '{}');
          names[roomId.value] = eventName.value || 'æœªå‘½åæ´»å‹•';
          localStorage.setItem('mathGod_roomNames', JSON.stringify(names));
          roomNamesMap.value = names;
        }
      };

      
      const SUPPORTED = ["HKD","CNY","JPY","TWD","THB","KRW","USD","EUR","GBP"];
      const RATES_CACHE_KEY = "mathGod_rates_to_HKD_v1";
      const RATES_TTL_MS = 6 * 60 * 60 * 1000; 

      const loadRatesCache = () => {
        const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
        if (cached?.rates && cached?.updatedAt) {
          ratesHKD.value = cached.rates;
          rateUpdatedAt.value = cached.updatedAt;
        }
      };

      const saveRatesCache = (rates, updatedAt) => {
        localStorage.setItem(RATES_CACHE_KEY, JSON.stringify({ rates, updatedAt }));
        ratesHKD.value = rates;
        rateUpdatedAt.value = updatedAt;
      };

      
      const refreshRatesSilently = async (force=false) => {
        if (!navigator.onLine) return;

        const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
        const freshEnough = cached?.updatedAt && (Date.now() - cached.updatedAt < RATES_TTL_MS);
        if (!force && freshEnough) return;

        try {
          const res = await fetch(`https://open.er-api.com/v6/latest/USD`, { cache: "no-store" });
          const data = await res.json();
          const r = data?.rates;
          if (!r?.HKD) return;

          
          const toHKD = { HKD: 1 };
          SUPPORTED.forEach(code => {
            if (code === "HKD") return;
            if (r[code]) toHKD[code] = r.HKD / r[code];
          });

          saveRatesCache(toHKD, Date.now());
        } catch (e) {
         
        }
      };

      
      const handleCurrencyChange = async () => {
        if (form.value.currency === "HKD") {
          currentRate.value = 1;
          return;
        }

        
        const cachedRate = ratesHKD.value?.[form.value.currency];
        currentRate.value = cachedRate || 1;

        
        await refreshRatesSilently(false);

       
        const newRate = ratesHKD.value?.[form.value.currency];
        if (newRate) currentRate.value = newRate;

        
        if (!navigator.onLine && !newRate) {
          toast("é›¢ç·šä¸”æœªæœ‰åŒ¯ç‡å¿«å–ï¼ˆå¯å…ˆä¸Šç·šé–‹ä¸€æ¬¡Appï¼‰", "error");
        }
      };

      const addUser = () => {
        const n = newUser.value.trim();
        if(!n) return;
        if(users.value.includes(n)) { toast("æœ‹å‹å·²å­˜åœ¨", "error"); return; }
        users.value.push(n);
        form.value.involved.push(n);
        newUser.value = "";
        saveData();
      };

      const addExpense = () => {
        errors.value = {
          item: !form.value.item,
          amount: !form.value.amount,
          payer: !form.value.payer,
          involved: form.value.involved.length === 0
        };

        if(Object.values(errors.value).some(v => v)) {
          toast("è«‹å¡«å¦¥ç´…è‰²æ¬„ä½", "error");
          return;
        }
   const amt = Number(form.value.amount);
if (!Number.isFinite(amt) || amt <= 0) {
  errors.value.amount = true;
  toast("é‡‘é¡å¿…é ˆå¤§æ–¼ 0", "error");
  return;
}



        const exp = {
          id: isEditing.value ? editingId.value : Date.now(),
          item: form.value.item,
         hkd: (amt * currentRate.value) || 0,
          payer: form.value.payer,
          involved: [...form.value.involved],
          origAmount: amt,
          origCurrency: form.value.currency
        };

        if(isEditing.value) {
          const i = expenses.value.findIndex(e => e.id === editingId.value);
          if(i > -1) expenses.value[i] = exp;
          toast("ä¿®æ”¹æˆåŠŸ");
        } else {
          expenses.value.unshift(exp);
          toast("å·²æ–°å¢ä¸€ç­†æ¶ˆè²»");
        }
        cancelEdit();
        saveData();
      };

      const editExpense = (i) => {
        const e = expenses.value[i];
        editingId.value = e.id;
        isEditing.value = true;
        form.value = { item: e.item, amount: e.origAmount, currency: e.origCurrency, payer: e.payer, involved: [...(e.involved || [])] };
        handleCurrencyChange();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };

      const cancelEdit = () => {
        isEditing.value = false;
        editingId.value = null;
        form.value = { item: "", amount: null, currency: "HKD", payer: "", involved: [...users.value] };
        currentRate.value = 1;
        errors.value = { item: false, amount: false, payer: false, involved: false };
      };

    
      const updateHistory = (rid) => {
        let h = JSON.parse(localStorage.getItem('mathGod_history') || '[]');
        h = [rid, ...h.filter(x => x !== rid)].slice(0, 10);
        recentRooms.value = h;
        localStorage.setItem('mathGod_history', JSON.stringify(h));
      };
   
const getRoomLink = (rid) => {
  const base = window.location.origin + window.location.pathname;
  const url = new URL(base);
  url.searchParams.set("room", rid);
  return url.toString();
};

const getRoomInviteText = (rid) => {
  const link = getRoomLink(rid);
  const name = (eventName.value || "").trim();

  return `æˆ‘ç”¨ âš¡ï¸MathGod é–‹å’—é–“æˆ¿ï½
ç”¨åšŸè¨˜ä½å¤§å®¶æ¶ˆè²»ï¼Œæœ€å¾Œæœƒè‡ªå‹•è¨ˆæ•¸æ¯äººè¦ç•€å¹¾éŒ¢ï¼

å¯ä»¥æ’³æ¢linkå…¥æˆ¿markæ•¸ğŸ‘‡
${name ? `æ´»å‹•ï¼š${name}\n` : ""}
${link}`.trim();
};



const copyRoomLink = async () => {
  if (!roomId.value) {
    toast("æœªé€£ç·šæˆ¿é–“", "error");
    return;
  }

  const text = getRoomInviteText(roomId.value);

  try {
    await navigator.clipboard.writeText(text);
    toast("å·²è¤‡è£½é‚€è«‹è¨Šæ¯");
  } catch (e) {
  
    window.prompt("è¤‡è£½ä»¥ä¸‹è¨Šæ¯åˆ†äº«æ¯”æœ‹å‹ï¼š", text);
  }
};



    const joinRoom = async (rid, options = {}) => {
  const { silent = false } = options;

 
  if (!navigator.onLine) {
    toast("é›¢ç·šæ¨¡å¼ï¼Œç„¡æ³•é€£ç·šæˆ¿é–“ï¼ˆå·²ä½¿ç”¨æœ¬åœ°è³‡æ–™ï¼‰", "error");
    isSyncing.value = false;
    return;
  }

  if (!rid) return;
  rid = rid.toString();

  isSyncing.value = true;

  
  let handled = false;

  try {
    const snap = await db.ref('rooms/' + rid).once('value');

    if (snap.exists()) {
      roomId.value = rid;
      roomInput.value = rid;
      localStorage.setItem('mathGod_roomId', rid);

      db.ref('rooms/' + rid).off();
      db.ref('rooms/' + rid).on('value', s => {
        const v = s.val();
        if (v) {
          users.value = v.users || [];
          expenses.value = v.expenses || [];
          eventName.value = v.eventName || "";
          if (!isEditing.value) form.value.involved = [...users.value];
        }
      });

      updateHistory(rid);
      showSyncModal.value = false;

      handled = true;
      setTimeout(() => {
  isSyncing.value = false;

  if (!silent) {
    toast(`æˆåŠŸåŠ å…¥æˆ¿é–“ #${rid}`);
  }

  history.replaceState(null, "", window.location.pathname);
}, 600);



    } else {
      toast("æˆ¿é–“ä¸å­˜åœ¨", "error");
    }

  } catch (e) {
    console.error(e);
    toast("é€£ç·šéŒ¯èª¤", "error");
  } finally {
   
    if (!handled) isSyncing.value = false;
  }
};


      const createRoom = async () => {
      
        const rid = Math.floor(1000 + Math.random() * 9000).toString();
        const initialData = { users: [...users.value], expenses: [...expenses.value], eventName: eventName.value || "" };
        try {
          await db.ref('rooms/' + rid).set(initialData);
          joinRoom(rid);
        } catch(e) {
  console.error(e);
  isSyncing.value = false; 
  toast("é€£ç·šéŒ¯èª¤", "error");
}

      };

      const logoutRoom = () => {
        if(!roomId.value) return;
        isSyncing.value = true;
setTimeout(() => {
          db.ref('rooms/' + roomId.value).off();
          roomId.value = null;
          roomInput.value = "";
          localStorage.removeItem('mathGod_roomId');
          resetData('all', false);
          isSyncing.value = false;
          toast("å·²ç™»å‡ºæˆ¿é–“");
        }, 800);
      };

      const removeHistoryRoom = (rid) => {
        if(confirm("å¾æœ€è¿‘ç´€éŒ„ä¸­åˆªé™¤æ­¤æˆ¿é–“ï¼Ÿ")) {
          let h = recentRooms.value.filter(x => x !== rid);
          recentRooms.value = h;
          localStorage.setItem('mathGod_history', JSON.stringify(h));
          let names = { ...(roomNamesMap.value || {}) };
          delete names[rid];
          localStorage.setItem('mathGod_roomNames', JSON.stringify(names));
          roomNamesMap.value = names;
        }
      };

      const resetData = (t, ask=true) => {
        const doReset = () => {
          if(t==='all'){
            users.value=[];
            expenses.value=[];
            eventName.value="";
            form.value = { item: "", amount: null, currency: "HKD", payer: "", involved: [] };
          } else {
            expenses.value=[];
          }
          saveData();
          showResetMenu.value=false;
        };
        if(ask) {
          if(confirm(t==='all' ? "ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼ˆåŒ…æ‹¬æœ‹å‹ï¼‰å—ï¼Ÿ" : "ç¢ºå®šåªæ¸…ç©ºæ¶ˆè²»ç´€éŒ„å—ï¼Ÿ")) {
            doReset();
            toast("è³‡æ–™å·²é‡ç½®");
          }
        } else {
          doReset();
        }
      };

      const appendDate = (e) => {
        if (e.target.value) {
          const dateStr = `(${e.target.value})`;
          const regex = /\(\d{4}-\d{2}-\d{2}\)$/;
          if (regex.test(eventName.value)) {
            eventName.value = eventName.value.replace(regex, dateStr);
          } else {
            eventName.value = eventName.value ? `${eventName.value} ${dateStr}` : dateStr;
          }
          saveData();
        }
      };

      const settlements = computed(() => {
        let bal = {};
        users.value.forEach(u => bal[u] = 0);

        expenses.value.forEach(e => {
          if(!e || !e.payer || !Array.isArray(e.involved) || e.involved.length === 0) return;
          if(!(e.payer in bal)) return; // payer å·²è¢«åˆª -> å¿½ç•¥
          const h = Number(e.hkd || 0);
          bal[e.payer] += h;
          const s = h / e.involved.length;
          e.involved.forEach(u => {
            if(u in bal) bal[u] -= s;
          });
        });

        let d=[], c=[], res=[];
        for(let u in bal) {
          if(bal[u] < -0.01) d.push({n: u, a: Math.abs(bal[u])});
          else if(bal[u] > 0.01) c.push({n: u, a: bal[u]});
        }
        d.sort((a,b)=>b.a-a.a);
        c.sort((a,b)=>b.a-a.a);

        let i=0, j=0;
        while(i<d.length && j<c.length) {
          let m = Math.min(d[i].a, c[j].a);
          res.push({from: d[i].n, to: c[j].n, amount: m});
          d[i].a -= m;
          c[j].a -= m;
          if(d[i].a < 0.01) i++;
          if(c[j].a < 0.01) j++;
        }
        return res;
      });

      const getShareText = () => {
        let msg = `å¤¾éŒ¢é€šçŸ¥ (Payment Notice)\n`;
        if (eventName.value) msg += `æ´»å‹•: ${eventName.value}\n`;
        msg += `------------------------------\n`;
        msg += `è«‹è·Ÿéš¨ä»¥ä¸‹åˆ—è¡¨éæ•¸ (Transfer List):\n`;
        if(settlements.value.length === 0) msg += `(æ²’æœ‰äººéœ€è¦å¤¾éŒ¢)\n`;
        settlements.value.forEach(s => msg += `${s.from} âœ ${s.to}: $${s.amount.toFixed(1)}\n`);

        if (shareOptions.value.showList) {
          msg += `\nğŸ“‹ è©³ç´°æ¶ˆè²»ç´€éŒ„:\n`;
          expenses.value.forEach((e, idx) => {
            msg += `${idx+1}. ${e.item} (${e.payer}ä»˜): $${Number(e.hkd || 0).toFixed(1)}\n`;
          });
        }
        msg += `\n------------------------------\nGenerated by âš¡ï¸MathGod`;
        return msg;
      };

      const copyText = () => {
        navigator.clipboard.writeText(getShareText())
          .then(()=>toast("å·²è¤‡è£½"))
          .catch(()=>toast("è¤‡è£½å¤±æ•—","error"));
      };

      const shareViaApp = async (type) => {
  try {
    if (type === 'text') {
      if (navigator.share) {
        await navigator.share({ title: 'MathGod çµç®—', text: getShareText() });
      } else {
        copyText();
      }
      return;
    }

    if (type === 'image') {
      toast("æ­£åœ¨è£½ä½œåœ–ç‰‡...");
      const zone = document.getElementById('capture-zone');
      if (!zone) return;

      const originalShadow = zone.style.boxShadow;
      const originalPaddingBottom = zone.style.paddingBottom;
      const originalTransform = zone.style.transform;

      zone.classList.add('capture-mode');
      zone.style.boxShadow = 'none';
      zone.style.paddingBottom = '16px';
      zone.style.transform = 'translateZ(0)';

      const canvas = await html2canvas(zone, {
        backgroundColor: '#e8e8e8',
        scale: 2,
        useCORS: true
      });

      canvas.toBlob(async (blob) => {
       
        zone.classList.remove('capture-mode');
        zone.style.boxShadow = originalShadow;
        zone.style.paddingBottom = originalPaddingBottom;
        zone.style.transform = originalTransform;

        const file = new File([blob], "mathgod_share.png", { type: "image/png" });
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({ files: [file], title: 'MathGod çµç®—åœ–' });
        } else {
          const link = document.createElement('a');
          link.download = `MathGod_${Date.now()}.png`;
          link.href = canvas.toDataURL();
          link.click();
          toast("ç³»çµ±ä¸æ”¯æ´ç›´æ¥åœ–ç‰‡åˆ†äº«ï¼Œå·²ç‚ºä½ ä¸‹è¼‰");
        }
      });

      return;
    }
  } catch (err) {
    console.error(err);
    toast("åˆ†äº«å¤±æ•—", "error");
  }
};


  const generateImage = async () => {
  const zone = document.getElementById('capture-zone');
  if (!zone) return;

  const originalShadow = zone.style.boxShadow;
  const originalPaddingBottom = zone.style.paddingBottom;
  const originalTransform = zone.style.transform;

  zone.classList.add('capture-mode');
  zone.style.boxShadow = 'none';
  zone.style.paddingBottom = '16px';
  zone.style.transform = 'translateZ(0)';

  try {
    const canvas = await html2canvas(zone, {
      backgroundColor: '#e8e8e8',
      scale: 2,
      useCORS: true
    });

    const link = document.createElement('a');
    link.download = `MathGod_${Date.now()}.png`;
    link.href = canvas.toDataURL();
    link.click();
  } finally {
    zone.classList.remove('capture-mode');
    zone.style.boxShadow = originalShadow;
    zone.style.paddingBottom = originalPaddingBottom;
    zone.style.transform = originalTransform;
  }
};



      const removeUser = (i) => {
        const name = users.value[i];
        if(!name) return;

        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤äººï¼Ÿï¼ˆæœƒåŒæ™‚ç§»é™¤ç›¸é—œæ¶ˆè²»é—œè¯ï¼‰")) return;

        users.value.splice(i, 1);

        form.value.involved = (form.value.involved || []).filter(u => u !== name);
        if (form.value.payer === name) form.value.payer = "";

        expenses.value = (expenses.value || [])
          .map(e => ({
            ...e,
            payer: e.payer === name ? "" : e.payer,
            involved: (e.involved || []).filter(u => u !== name),
            hkd: Number(e.hkd || 0),
          }))
          .filter(e => e.payer && Array.isArray(e.involved) && e.involved.length > 0);

        if (users.value.length === 0) {
          form.value.involved = [];
          form.value.payer = "";
        }

        saveData();
        toast("å·²åˆªé™¤æœ‹å‹ä¸¦æ¸…ç†ç›¸é—œç´€éŒ„");
      };

      const removeExpense = (i) => {
        if(confirm("ç¢ºå®šåˆªé™¤ç´€éŒ„ï¼Ÿ")) {
          expenses.value.splice(i,1);
          saveData();
        }
      };

      const toggleSelectAll = () => {
        form.value.involved = (form.value.involved.length === users.value.length) ? [] : [...users.value];
      };

      const toggleInvolved = (u) => {
        const idx = form.value.involved.indexOf(u);
        if(idx>-1) form.value.involved.splice(idx,1);
        else form.value.involved.push(u);
      };

      onMounted(() => {
  
  loadRatesCache();
  refreshRatesSilently(false);
  if (form.value.currency !== "HKD") handleCurrencyChange();

      
const roomFromUrl = new URLSearchParams(window.location.search).get("room");
if (roomFromUrl && /^\d{4}$/.test(roomFromUrl)) {
  if (navigator.onLine) {
    joinRoom(roomFromUrl);

  } else {
    toast("åµæ¸¬åˆ°æˆ¿é–“é€£çµï¼Œä½†ä½ ç¾æ­£é›¢ç·šï¼Œæœªèƒ½åŠ å…¥", "error");
    isLoading.value = false;
  }
  return; // 
}


  const local = JSON.parse(localStorage.getItem('mathGod_localData') || '{}');
        if(local.users) {
          users.value = local.users;
          expenses.value = local.expenses || [];
          eventName.value = local.eventName || "";
        }
        form.value.involved = [...users.value];

        recentRooms.value = JSON.parse(localStorage.getItem('mathGod_history') || '[]');
        roomNamesMap.value = JSON.parse(localStorage.getItem('mathGod_roomNames') || '{}');

       const savedRoom = localStorage.getItem('mathGod_roomId');

if (savedRoom && navigator.onLine) {
  joinRoom(savedRoom, { silent: true });
toast(`å·²å›åˆ°ä¸Šæ¬¡æˆ¿é–“ #${savedRoom}`);

} else {

  isLoading.value = false;
  
}


       const onOnline = () => {
  isOnline.value = true;
  toast("å·²é€£ç·šï¼ˆOnlineï¼‰");
};

const onOffline = () => {
  isOnline.value = false;
  toast("é›¢ç·šæ¨¡å¼ï¼ˆOfflineï¼‰", "error");
};

        window.addEventListener('online', onOnline);
        window.addEventListener('offline', onOffline);
        if (!navigator.onLine) onOffline();


      
      });

      return {
  isLoading,
  isSyncing,
  isOnline,      
  shareSubMenu,
  eventName, users, expenses, newUser, form, isEditing, editingId,
  showSyncModal, showShareModal, showResetMenu, showTutorial, toasts,
  roomId, roomInput, currentRate, shareOptions, errors,

  copyRoomLink,

  rateUpdatedAt,
  formatTs,


  openDatePicker,
  recentRoomsWithNames: computed(() => recentRooms.value.map(id => ({ id, name: roomNamesMap.value[id] || 'æœªå‘½åæ´»å‹•' }))),
  totalSpent: computed(() => expenses.value.reduce((s, e) => s + Number(e?.hkd || 0), 0)),
  settlements,
  addUser, addExpense, saveData, joinRoom, createRoom, logoutRoom,
  editExpense, cancelEdit,
  removeUser,
  removeExpense,
  handleCurrencyChange,
  toggleSelectAll,
  toggleInvolved,
  appendDate, resetData, removeHistoryRoom, copyText, generateImage, shareViaApp
};

    }
  }).mount('#app');
</script>
</body>
</html>






