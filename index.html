<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹</title>
  <meta name="description" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹ - å°ˆç‚ºæœ‹å‹èšæœƒã€æ—…è¡Œè¨­è¨ˆçš„åŒæ­¥åˆ†å¸³å·¥å…·ã€‚æ”¯æ´å¤šåœ‹åŒ¯ç‡è½‰æ›ï¼Œä¸€éµç”Ÿæˆçµç®—å–®ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://mydown.vercel.app/">
  <meta property="og:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta property="og:description" content="æ—…è¡Œã€é£Ÿé£¯ã€å¤¾éŒ¢å””ä½¿ç…©ï¼æ”¯æ´å³æ™‚åŒæ­¥åŠŸèƒ½ï¼Œè‡ªå‹•æ›ç®—åŒ¯ç‡ï¼ŒMathGod å¹«ä½ è¨ˆåˆ°ç›¡ã€‚">
  <meta property="og:image" content="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="MathGodâš¡ï¸å¤¾éŒ¢è¨ˆæ•¸å°åŠ©æ‰‹">
  <meta name="twitter:description" content="æœ‹å‹èšæœƒåˆ†å¸³ç¥å™¨ï¼šæ”¯æ´å¤šå¹£ç¨®ã€é›²ç«¯åŒæ­¥ã€‚">
  <meta name="twitter:image" content="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png">
  <meta name="theme-color" content="#0a2f23">
  <link rel="icon" href="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png">
  <link rel="apple-touch-icon" href="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png">


  <link rel="manifest" href="./manifest.webmanifest">

  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    :root { --primary: #10b981; --bg: #050505; --card-bg: rgba(30, 30, 30, 0.65); --border: rgba(255, 255, 255, 0.1); }
    [v-cloak] { display: none !important; }
    body { background-color: var(--bg); color: #fff; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    .glass { background: var(--card-bg); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
    .glass-input { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); transition: all 0.3s; }
    .glass-input:focus-within { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2); background: rgba(0,0,0,0.5); }
    .input-error { border-color: #ef4444 !important; background: rgba(239, 68, 68, 0.1) !important; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .font-num { font-family: 'JetBrains Mono', monospace; }
    .btn-press { transition: transform 0.1s; }
    .btn-press:active { transform: scale(0.96); }
    .footer-gradient { background: linear-gradient(to top, rgba(5,5,5,0.95) 10%, rgba(5,5,5,0.6) 40%, rgba(5,5,5,0) 100%); pointer-events: none; height: 120px; }
    .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
    .fade-enter-from, .fade-leave-to { opacity: 0; }
    .toast-enter-active, .toast-leave-active { transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-enter-from, .toast-leave-to { opacity: 0; transform: translateY(-30px) scale(0.9); }
    .custom-scroll::-webkit-scrollbar { width: 4px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    .math-check { appearance: none; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 6px; position: relative; transition: all 0.2s; }
    .math-check:checked { background: var(--primary); border-color: var(--primary); }
    .math-check:checked::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; font-size: 10px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
    .app-logo { filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.3)); }
  </style>
</head>

<body>
<div id="app" v-cloak class="min-h-screen flex flex-col max-w-[500px] mx-auto relative pb-32">

  <transition name="fade">
    <div v-if="isLoading" class="fixed inset-0 z-[200] bg-black flex items-center justify-center">
      <div class="flex flex-col items-center">
        <img src="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png" class="w-16 h-16 rounded-2xl mb-4 animate-pulse shadow-2xl">
        <p class="text-xs text-gray-500 font-bold tracking-widest uppercase">Processing...</p>
      </div>
    </div>
  </transition>

  <div class="fixed top-8 left-0 right-0 z-[999] flex flex-col items-center pointer-events-none px-4">
    <transition-group name="toast">
      <div v-for="t in toasts" :key="t.id" class="glass px-6 py-3 rounded-full flex items-center gap-3 mb-2 shadow-2xl pointer-events-auto border-l-4"
           :class="t.type === 'error' ? 'border-red-500' : 'border-emerald-500'">
        <i :class="['fas', t.type === 'error' ? 'fa-times-circle text-red-400' : 'fa-check-circle text-emerald-400']"></i>
        <span class="text-xs font-bold">{{ t.msg }}</span>
      </div>
    </transition-group>
  </div>

  <header class="p-6 pb-8 rounded-b-[2.5rem] sticky top-0 z-40 transition-all duration-500 shadow-2xl backdrop-blur-xl border-b border-white/5"
          :class="isEditing ? 'bg-amber-950/80' : 'bg-[#0a2f23]/80'">
    <div class="flex justify-between items-start mb-6">
      <div class="flex items-center gap-3">
        <img src="https://gcdnb.pbrd.co/images/WfgYQo77g3a6.png" class="h-10 w-10 rounded-xl object-contain shadow-lg border border-white/10 app-logo">
        <div>
          <h1 class="text-xl font-black italic tracking-tighter text-white leading-none">MathGod</h1>
          <p class="text-[9px] font-bold text-emerald-400/80 tracking-[0.1em] uppercase">
            {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹æ¨¡å¼' : 'æœ‹å‹å¤¾éŒ¢è¨ˆç®—å™¨' }}
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button @click="showTutorial = true" class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-xs hover:bg-white/20 transition-all">
          <i class="fas fa-question text-white/70"></i>
        </button>
      </div>
    </div>

    <div class="flex gap-3">
      <div class="flex-1 glass-input rounded-2xl flex items-center px-4 relative">
        <i class="fas fa-pen text-[10px] text-gray-500 mr-3"></i>
        <input v-model="eventName" @change="saveData" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/20" placeholder="æ´»å‹•åç¨± (ä¾‹å¦‚: æ—¥æœ¬ Day1)">
      </div>

      <button @click="openDatePicker" class="w-12 glass-input rounded-2xl flex items-center justify-center hover:border-emerald-500/50 btn-press">
        <i class="fas fa-calendar-day text-emerald-400 pointer-events-none"></i>
      </button>
      <input type="date" id="dateInput" class="hidden" @change="appendDate">
    </div>
  </header>

  <main class="p-5 space-y-6 flex-1">
    <section class="glass p-5 rounded-[2rem]">
      <div class="flex justify-between items-center mb-3">
        <h3 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">STEP 1: æœ‹å‹</h3>
        <span class="text-[10px] bg-white/10 px-2 py-0.5 rounded-full text-gray-400 font-num">{{ users.length }} äºº</span>
      </div>

      <div class="flex gap-2 mb-4">
        <div class="flex-1 glass-input rounded-xl flex items-center px-4 transition-all"
             :class="{'border-emerald-500 shadow-[0_0_15px_rgba(16,185,129,0.2)]': users.length === 0}">
          <i class="fas fa-user-plus text-xs text-gray-500 mr-2"></i>
          <input v-model="newUser" @keyup.enter="addUser" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="è¼¸å…¥åå­—...">
        </div>
        <button @click="addUser" class="bg-emerald-600 px-5 rounded-xl font-black text-xs btn-press shadow-lg shadow-emerald-900/50">åŠ å…¥</button>
      </div>

      <div class="flex flex-wrap gap-2">
        <transition-group name="toast">
          <div v-for="(u, i) in users" :key="u" class="bg-white/5 border border-white/10 px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 group">
            {{ u }}
            <button @click="removeUser(i)" class="text-gray-600 hover:text-red-400 px-1"><i class="fas fa-times"></i></button>
          </div>
        </transition-group>
      </div>
    </section>

    <section class="glass p-6 rounded-[2rem] transition-all duration-300 relative overflow-hidden"
             :class="{'opacity-50 pointer-events-none grayscale': users.length === 0, 'border-amber-500/50': isEditing}">

      <div v-if="users.length === 0" class="absolute inset-0 z-50 flex items-center justify-center bg-black/20 backdrop-blur-[2px]">
        <div class="bg-black/80 px-4 py-2 rounded-full text-xs font-bold text-white"><i class="fas fa-lock mr-2"></i>å…ˆåŠ æœ‹å‹è§£é–</div>
      </div>

      <div class="flex justify-between items-center mb-5">
        <h3 class="text-[10px] font-bold uppercase tracking-widest flex items-center gap-2" :class="isEditing ? 'text-amber-500' : 'text-emerald-500'">
          {{ isEditing ? 'æ­£åœ¨ä¿®æ”¹' : 'STEP 2: æ–°å¢æ¶ˆè²»' }}
        </h3>
        <button v-if="isEditing" @click="cancelEdit" class="text-[10px] text-gray-400 underline hover:text-white">å–æ¶ˆä¿®æ”¹</button>
      </div>

      <div class="space-y-4">
        <div class="glass-input rounded-2xl flex items-center px-4 relative" :class="{'input-error': errors.item}">
          <input v-model="form.item" @input="errors.item = false" class="w-full bg-transparent py-3 text-sm font-bold outline-none placeholder-white/30" placeholder="æ¶ˆè²»é …ç›® (ä¾‹å¦‚: æ™šé¤)">
        </div>

        <div class="grid grid-cols-12 gap-3">
          <div class="col-span-4 glass-input rounded-2xl relative">
            <select v-model="form.currency" @change="handleCurrencyChange" class="w-full h-full bg-transparent px-3 text-xs font-black outline-none appearance-none text-center z-10 relative">
              <option value="HKD">HKD ğŸ‡­ğŸ‡°</option>
              <option value="CNY">CNY ğŸ‡¨ğŸ‡³</option>
              <option value="JPY">JPY ğŸ‡¯ğŸ‡µ</option>
              <option value="TWD">TWD ğŸ‡¹ğŸ‡¼</option>
              <option value="THB">THB ğŸ‡¹ğŸ‡­</option>
              <option value="KRW">KRW ğŸ‡°ğŸ‡·</option>
              <option value="USD">USD ğŸ‡ºğŸ‡¸</option>
              <option value="EUR">EUR ğŸ‡ªğŸ‡º</option>
              <option value="GBP">GBP ğŸ‡¬ğŸ‡§</option>
            </select>
            <i class="fas fa-chevron-down absolute right-2 top-1/2 -translate-y-1/2 text-[8px] text-gray-500"></i>
          </div>

          <div class="col-span-8 glass-input rounded-2xl flex flex-col justify-center px-4 py-2" :class="{'input-error': errors.amount}">
            <div class="flex items-center">
              <span class="text-xs font-black text-gray-500 mr-2">$</span>
              <input v-model.number="form.amount" @input="errors.amount = false" type="number" inputmode="decimal" class="w-full bg-transparent text-right font-num font-black text-xl outline-none placeholder-white/10" placeholder="0.0">
            </div>

            <div v-if="form.currency !== 'HKD'" class="text-right border-t border-white/5 mt-1 pt-1 space-y-1">
              <div>
                <span class="text-[9px] font-bold text-emerald-400 font-num">
                  Rate: {{currentRate.toFixed(3)}} â‰ˆ HKD ${{ (form.amount * currentRate || 0).toFixed(1) }}
                </span>
              </div>
              <div v-if="rateUpdatedAt" class="text-[9px] font-bold text-gray-500 font-num">
                æœ€å¾Œæ›´æ–°æ™‚é–“ï¼š{{ formatTs(rateUpdatedAt) }}
              </div>
            </div>
          </div>
        </div>

        <button @click="addExpense" class="w-full py-4 rounded-2xl font-black text-sm shadow-xl btn-press flex items-center justify-center gap-2 transition-all bg-emerald-600 shadow-emerald-900/40">
          <i class="fas fa-plus"></i>
          <span>ç¢ºèªå…¥å¸³</span>
        </button>
      </div>
    </section>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "yFDRUSUFAFnZf6AGdsEA9LxSyLcZF75oIFfib5At",
    databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app/",
    projectId: "mathgod2"
  };
  try { firebase.initializeApp(firebaseConfig); } catch(e) {}
  const db = firebase.database();
  const { createApp, ref, computed, onMounted } = Vue;


  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('SW registered'))
        .catch(err => console.log('SW failed', err));
    });
  }

  createApp({
    setup() {
      const isLoading = ref(false);
      const eventName = ref("");
      const users = ref([]);
      const expenses = ref([]);
      const newUser = ref("");
      const isEditing = ref(false);
      const editingId = ref(null);
      const showTutorial = ref(false);
      const toasts = ref([]);
      const form = ref({ item: "", amount: null, currency: "HKD", payer: "", involved: [] });
      const errors = ref({ item: false, amount: false, payer: false, involved: false });
      const currentRate = ref(1);


      const ratesHKD = ref({ HKD: 1 });
      const rateUpdatedAt = ref(null);

      const toast = (msg, type='success') => {
        const id = Date.now();
        toasts.value.push({id, msg, type});
        setTimeout(() => toasts.value = toasts.value.filter(t=>t.id!==id), 3000);
      };

      const openDatePicker = () => {
        const el = document.getElementById('dateInput');
        if(!el) return;
        if (typeof el.showPicker === 'function') el.showPicker();
        else el.click();
      };

      const formatTs = (ts) => {
        const d = new Date(ts);
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      };


      const SUPPORTED = ["HKD","CNY","JPY","TWD","THB","KRW","USD","EUR","GBP"];
      const RATES_CACHE_KEY = "mathGod_rates_to_HKD_v1";
      const RATES_TTL_MS = 6 * 60 * 60 * 1000;

      const loadRatesCache = () => {
        const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
        if (cached?.rates && cached?.updatedAt) {
          ratesHKD.value = cached.rates;
          rateUpdatedAt.value = cached.updatedAt;
        }
      };

      const saveRatesCache = (rates, updatedAt) => {
        localStorage.setItem(RATES_CACHE_KEY, JSON.stringify({ rates, updatedAt }));
        ratesHKD.value = rates;
        rateUpdatedAt.value = updatedAt;
      };

      const refreshRatesSilently = async (force=false) => {
        if (!navigator.onLine) return;

        const cached = JSON.parse(localStorage.getItem(RATES_CACHE_KEY) || "null");
        const freshEnough = cached?.updatedAt && (Date.now() - cached.updatedAt < RATES_TTL_MS);
        if (!force && freshEnough) return;

        try {
          const res = await fetch(`https://open.er-api.com/v6/latest/USD`, { cache: "no-store" });
          const data = await res.json();
          const r = data?.rates;
          if (!r?.HKD) return;

          const toHKD = { HKD: 1 };
          SUPPORTED.forEach(code => {
            if (code === "HKD") return;
            if (r[code]) toHKD[code] = r.HKD / r[code];
          });

          saveRatesCache(toHKD, Date.now());
        } catch (e) {}
      };

      const handleCurrencyChange = async () => {
        if (form.value.currency === "HKD") {
          currentRate.value = 1;
          return;
        }

        const cachedRate = ratesHKD.value?.[form.value.currency];
        currentRate.value = cachedRate || 1;

        await refreshRatesSilently(false);

        const newRate = ratesHKD.value?.[form.value.currency];
        if (newRate) currentRate.value = newRate;

        if (!navigator.onLine && !newRate) {
          toast("é›¢ç·šä¸”æœªæœ‰åŒ¯ç‡å¿«å–ï¼ˆå¯å…ˆä¸Šç·šé–‹ä¸€æ¬¡Appï¼‰", "error");
        }
      };

      const saveData = () => {
        const data = { users: [...users.value], expenses: [...expenses.value], eventName: eventName.value };
        localStorage.setItem('mathGod_localData', JSON.stringify(data));
      };

      const addUser = () => {
        const n = newUser.value.trim();
        if(!n) return;
        if(users.value.includes(n)) { toast("æœ‹å‹å·²å­˜åœ¨", "error"); return; }
        users.value.push(n);
        newUser.value = "";
        saveData();
      };

      const addExpense = () => {
        errors.value = { item: !form.value.item, amount: !form.value.amount, payer: false, involved: false };
        if(Object.values(errors.value).some(v => v)) { toast("è«‹å¡«å¦¥ç´…è‰²æ¬„ä½", "error"); return; }

        expenses.value.unshift({
          id: Date.now(),
          item: form.value.item,
          hkd: (form.value.amount * currentRate.value) || 0,
          payer: "",
          involved: [],
          origAmount: form.value.amount,
          origCurrency: form.value.currency
        });

        form.value.item = "";
        form.value.amount = null;
        form.value.currency = "HKD";
        currentRate.value = 1;
        saveData();
        toast("å·²æ–°å¢ä¸€ç­†æ¶ˆè²»");
      };

      const appendDate = (e) => {
        if (e.target.value) {
          const dateStr = `(${e.target.value})`;
          const regex = /\(\d{4}-\d{2}-\d{2}\)$/;
          if (regex.test(eventName.value)) eventName.value = eventName.value.replace(regex, dateStr);
          else eventName.value = eventName.value ? `${eventName.value} ${dateStr}` : dateStr;
          saveData();
        }
      };

      const removeUser = (i) => {
        const name = users.value[i];
        if(!name) return;
        if(!confirm("ç¢ºå®šåˆªé™¤æ­¤äººï¼Ÿ")) return;
        users.value.splice(i, 1);
        saveData();
      };

      onMounted(() => {
        const local = JSON.parse(localStorage.getItem('mathGod_localData') || '{}');
        if(local.users) {
          users.value = local.users || [];
          expenses.value = local.expenses || [];
          eventName.value = local.eventName || "";
        }


        loadRatesCache();
        refreshRatesSilently(false);

        if (!navigator.onLine) toast("é›¢ç·šæ¨¡å¼ï¼ˆOfflineï¼‰", "error");
        window.addEventListener('online', () => toast("å·²é€£ç·šï¼ˆOnlineï¼‰"));
        window.addEventListener('offline', () => toast("é›¢ç·šæ¨¡å¼ï¼ˆOfflineï¼‰", "error"));
      });

      return {
        isLoading, eventName, users, expenses, newUser, isEditing, editingId, showTutorial, toasts,
        form, errors, currentRate, rateUpdatedAt, formatTs,
        openDatePicker, saveData,
        addUser, removeUser,
        addExpense, cancelEdit: () => {}, editExpense: () => {}, removeExpense: () => {},
        handleCurrencyChange,
        appendDate,
        settlements: computed(() => []),
        totalSpent: computed(() => expenses.value.reduce((s, e) => s + Number(e?.hkd || 0), 0)),
      };
    }
  }).mount('#app');
</script>
</body>
</html>
